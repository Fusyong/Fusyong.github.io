
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://blog.xiiigame.com/2022-01-10-LuaTeX-CLD-TEX%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
      
      
        <link rel="prev" href="../2022-02-23-luametatex-callback-playground/">
      
      
        <link rel="next" href="../2022-01-10-ConTeXt%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
      
      <link rel="icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.9">
    
    
      
        <title>LuaTeX-LMTX-CLD学习笔记 - 嬉戏实验室</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.0d440cfe.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/ansi-colours.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-PWB4KHSW87"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-PWB4KHSW87",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-PWB4KHSW87",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="pink">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#vscode" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href=".." title="嬉戏实验室" class="md-header__button md-logo" aria-label="嬉戏实验室" data-md-component="logo">
      
  <img src="../img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            嬉戏实验室
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              LuaTeX-LMTX-CLD学习笔记
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="嬉戏实验室" class="md-nav__button md-logo" aria-label="嬉戏实验室" data-md-component="logo">
      
  <img src="../img/logo.png" alt="logo">

    </a>
    嬉戏实验室
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        ☆ 首页
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../new/" class="md-nav__link">
        ☆ 最新
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../tags/" class="md-nav__link">
        ☆ 标签
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          儿童识字
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          儿童识字
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-11-19-%E3%80%8A%E5%B9%BC%E5%84%BF%E8%AF%86%E5%AD%9790%E5%A4%A9%EF%BC%9A%E8%AE%A4%E8%AF%86%E4%B9%A6%E4%B8%AD80%25%E7%9A%84%E6%B1%89%E5%AD%97%E3%80%8B/" class="md-nav__link">
        《幼儿识字90天：认识书中80%的汉字》
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-04-21-%E6%80%8E%E4%B9%88%E8%AE%A9%E5%AD%A9%E5%AD%90%E8%AF%86%E5%AD%97%E5%8F%88%E5%A4%9A%E5%8F%88%E5%87%86%E7%A1%AE/" class="md-nav__link">
        怎么让孩子识字又多又准确
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-03-02-%E8%AF%86%E5%AD%97%E7%94%A8%E6%88%90%E8%AF%AD%EF%BC%88A%E7%BA%A7%E5%AD%97%EF%BC%89/" class="md-nav__link">
        儿童识字用成语及录音（A级字）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-18-%E5%A6%82%E4%BD%95%E7%9C%8B%E5%BE%85%E3%80%8A%E4%B9%89%E5%8A%A1%E6%95%99%E8%82%B2%E5%B8%B8%E7%94%A8%E8%AF%8D%E8%A1%A8%EF%BC%88%E8%8D%89%E6%A1%88%EF%BC%89%E3%80%8B%E5%87%BA%E7%89%88%E5%B9%B6%E5%AF%B9%E5%A4%96%E5%8F%91%E5%B8%83%EF%BC%9F/" class="md-nav__link">
        如何看待《义务教育常用词表（草案）》出版并对外发布
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-02-09-%E5%B0%8F%E5%AD%A6%E8%AF%AD%E6%96%87%E5%AD%97%E5%8D%A1%EF%BC%882021%E5%B9%B4%E6%98%A5%E5%AD%A3%EF%BC%89/" class="md-nav__link">
        小学语文识字卡片（2021年秋季更新）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-08-24-%E5%B0%8F%E5%AD%A6%E8%AF%AD%E6%96%87%E5%AD%97%E5%8D%A1%EF%BC%882020%E5%B9%B4%E7%A7%8B%E5%AD%A3%EF%BC%89/" class="md-nav__link">
        小学语文识字卡片（2020年秋季）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-06-30-%E5%8F%A4%E4%BA%BA%E8%AF%86%E5%AD%97%E7%9A%84%E7%89%B9%E7%82%B9/" class="md-nav__link">
        古人识字的特点
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-06-30-%E8%AF%AD%E6%96%87%E8%AF%BE%E8%AF%86%E5%AD%97%E7%9A%84%E7%89%B9%E7%82%B9/" class="md-nav__link">
        语文课识字的特点
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-09-28-%E5%A6%82%E4%BD%95%E7%9C%8B%E5%BE%85%E5%84%BF%E7%AB%A5%E8%AF%86%E5%AD%97%E5%BA%94%E8%AF%A5%E2%80%9C%E5%8F%AA%E8%AE%A4%E5%AD%97%EF%BC%8C%E5%9B%BE%E5%92%8C%E6%8B%BC%E9%9F%B3%E9%83%BD%E4%B8%8D%E7%9C%8B%E2%80%9D/" class="md-nav__link">
        如何看待儿童识字应该“只认字，图和拼音都不看”？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-08-18-%E5%B0%8F%E5%AD%A6%E8%AF%86%E5%AD%97%E6%96%B9%E6%B3%95%E6%9C%89%E5%93%AA%E4%BA%9B/" class="md-nav__link">
        小学识字方法有哪些？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-09-15-%E6%80%8E%E4%B9%88%E6%95%99%E5%AD%A9%E5%AD%90%E8%AF%86%E5%AD%97/" class="md-nav__link">
        怎么教孩子识字
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-06-30-%E7%BB%99%E8%87%AA%E5%AE%B6%E5%AD%A9%E5%AD%90DIY%E8%AF%86%E5%AD%97%E6%9D%90%E6%96%99%EF%BC%9A%E5%AD%97%E5%8D%A1%EF%BC%88%E9%99%84%E6%88%90%E5%93%81%EF%BC%89/" class="md-nav__link">
        给自家孩子DIY识字材料：字卡（附成品）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-28-%E6%97%A9%E8%AF%86%E5%AD%97%E4%BC%9A%E7%A0%B4%E5%9D%8F%E5%AD%A9%E5%AD%90%E7%9A%84%E5%88%9B%E9%80%A0%E5%8A%9B%E3%80%81%E6%83%B3%E8%B1%A1%E5%8A%9B%E5%90%97/" class="md-nav__link">
        早识字会破坏孩子的创造力、想象力吗？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-09-15-%E6%9C%89%E4%BB%80%E4%B9%88%E6%96%87%E7%AB%A0%E5%90%AB%E6%9C%89%E4%B8%8D%E5%90%8C%E7%9A%84%E6%B1%89%E5%AD%97%E6%AF%94%E8%BE%83%E5%A4%9A%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%94%A8%E4%BA%8E%E6%95%99%E5%B0%8F%E6%9C%8B%E5%8F%8B%E8%AF%86%E5%AD%97/" class="md-nav__link">
        有什么文章含有不同的汉字比较多，可以用于教小朋友识字？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-01-31-%E5%AD%97%E7%90%86/" class="md-nav__link">
        常用字源字理(累积更新)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-10-18-%E4%BB%8E%E9%A1%B7%E5%88%B0%E9%A2%8D/" class="md-nav__link">
        从顷到颍（附说明）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-10-21-%E4%BB%8E%E3%AB%83%E5%88%B0%E6%97%97/" class="md-nav__link">
        从㫃到旗
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-06-27-%E5%B0%8F%E5%AD%A6%E8%AF%AD%E6%96%87%E5%90%8C%E6%AD%A5%E5%85%B4%E8%B6%A3%E8%AF%86%E5%AD%97/" class="md-nav__link">
        小学语文同步兴趣识字（累积更新）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-11-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%AF%AD%E6%96%87%E8%80%81%E5%B8%88%E4%B8%8D%E4%B8%80%E4%B8%AA%E4%B8%AA%E6%95%99%E6%B1%89%E5%AD%97%E6%9C%AC%E4%B9%89/" class="md-nav__link">
        为什么语文老师不一个个教汉字本义？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-08-11-%E5%AD%A9%E5%AD%90%E5%9C%A8%E4%B8%8A%E5%B0%8F%E5%AD%A6%E4%B9%8B%E5%89%8D%E8%AF%A5%E8%AE%A9%E4%BB%96%E6%8E%8C%E6%8F%A1%E6%8B%BC%E9%9F%B3%E5%90%97/" class="md-nav__link">
        孩子在上小学之前该让他掌握拼音吗？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-14-%E9%80%82%E5%BD%93%E5%BC%80%E5%B1%95%E7%B9%81%E4%BD%93%E5%AD%97%E6%95%99%E8%82%B2%E6%9C%89%E5%BF%85%E8%A6%81%E5%90%97/" class="md-nav__link">
        适当开展繁体字教育有必要吗？
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          阅读启蒙
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          阅读启蒙
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-09-09-%E9%83%A8%E7%BC%96%E7%89%88%E5%B0%8F%E5%AD%A6%E8%AF%AD%E6%96%87%E6%95%99%E6%9D%90%E6%8B%BC%E9%9F%B3%E6%A0%87%E6%B3%A8%E8%A7%84%E5%88%99/" class="md-nav__link">
        部编版小学语文教材拼音标注规则
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-11-28-%E9%83%A8%E7%BC%96%E7%89%88%E5%B0%8F%E5%AD%A6%E8%AF%AD%E6%96%87%E6%95%99%E6%9D%90%E6%8B%BC%E9%9F%B3%E6%98%AF%E4%BB%80%E4%B9%88%E5%AD%97%E4%BD%93/" class="md-nav__link">
        部编版小学语文教材拼音是什么字体
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-03-29-%E4%B8%80%E5%B9%B4%E7%BA%A7%E5%AD%A9%E5%AD%90%E7%9C%8B%E4%B9%A6%E7%89%B9%E5%88%AB%E7%B2%97%E7%95%A5%E6%80%8E%E4%B9%88%E5%BC%95%E5%AF%BC/" class="md-nav__link">
        一年级孩子看书特别快，但很粗略，怎么引导？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-04-04-%E5%AD%A9%E5%AD%90%E4%B8%8D%E7%88%B1%E5%AD%A6%E4%B9%A0%EF%BC%8C%E6%AF%9B%E7%B3%99%E3%80%81%E5%BA%94%E4%BB%98%E6%80%8E%E4%B9%88%E5%8A%9E/" class="md-nav__link">
        孩子不爱学习，毛糙、应付怎么办？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-26-%E9%99%AA%E5%AD%A9%E5%AD%90%E5%AD%A6%E8%8B%B1%E8%AF%AD%E7%9A%84%E4%B8%80%E7%82%B9%E5%B0%9D%E8%AF%95%E5%92%8C%E6%83%B3%E6%B3%95/" class="md-nav__link">
        陪孩子学英语的一点尝试和想法（累积更新）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-19-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%87%AA%E7%84%B6%E6%8B%BC%E8%AF%BB%E6%B3%95%E9%87%8C%E9%9D%A2%E7%9A%84%E8%A7%84%E5%BE%8B%E7%BC%BA%E4%B9%8F%E6%99%AE%E9%81%8D%E6%80%A7/" class="md-nav__link">
        为什么自然拼读法里面的规律缺乏普遍性？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-03-09-%E5%AD%A6%E8%8B%B1%E8%AF%AD%E4%BB%8E%E5%93%AA%E9%87%8C%E5%BC%80%E5%A7%8B/" class="md-nav__link">
        学英语从哪里开始？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-09-20-%E5%A6%82%E4%BD%95%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD%E9%9F%B3%E6%A0%87/" class="md-nav__link">
        如何学习英语音标？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2019-09-08-%E6%9C%89%E9%81%93%E8%AF%8D%E5%85%B8%E7%AC%942.0%E4%B9%8B%E7%AB%A5%E4%B9%A6%E5%AE%9E%E6%B5%8B/" class="md-nav__link">
        有道词典笔2.0之童书实测
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-02-28-%E4%BA%B2%E5%AD%90%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        亲子阅读笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-10-04-%E6%98%AF%E4%B8%8D%E6%98%AF%E5%AD%A9%E5%AD%90%E5%8F%AF%E4%BB%A5%E4%B8%8D%E4%B8%8A%E5%B9%BC%E5%84%BF%E5%9B%AD/" class="md-nav__link">
        是不是孩子可以不上幼儿园
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-03-30-%E6%80%8E%E4%B9%88%E8%B7%9F%E5%AD%A9%E5%AD%90%E8%A7%A3%E9%87%8A%E7%94%9F%E5%91%BD%E7%9A%84%E6%84%8F%E4%B9%89/" class="md-nav__link">
        怎么跟孩子解释生命的意义
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-04-18-%E5%A6%82%E4%BD%95%E8%AF%B4%E5%AD%A9%E5%AD%90%E6%89%8D%E4%BC%9A%E5%90%AC/" class="md-nav__link">
        如何说孩子才会听
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-03-23-%E5%A6%82%E4%BD%95%E8%83%BD%E8%AE%A9%E5%B0%8F%E5%AD%A6%E7%94%9F%E5%AE%89%E9%9D%99%E7%9A%84%E5%81%9A%E4%BD%9C%E4%B8%9A/" class="md-nav__link">
        如何能让小学生安静的做作业
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-05-21-%E6%80%8E%E4%B9%88%E6%89%8D%E8%83%BD%E8%AE%A9%E5%AD%A9%E5%AD%90%E8%87%AA%E5%B7%B1%E6%9F%A5%E5%AD%97%E5%85%B8%E8%AF%86%E5%AD%97/" class="md-nav__link">
        怎么才能让孩子自己查字典识字？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-03-30-%E5%B0%8F%E5%AD%A6%E4%B8%80%E5%B9%B4%E7%BA%A7%E8%A6%81%E8%83%8C%E3%80%8A%E5%BC%9F%E5%AD%90%E8%A7%84%E3%80%8B%E5%90%88%E7%90%86%E5%90%97/" class="md-nav__link">
        小学一年级要背《弟子规》合理吗
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-06-19-%E4%BC%B4%E5%AD%A6%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        家长伴学技术笔记（累积更新）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-10-28-%E9%82%A3%E4%B8%AA%E5%81%B7%E4%B8%9C%E8%A5%BF%E7%9A%84%E4%BA%BA%E5%B0%B1%E6%98%AF%E6%88%91/" class="md-nav__link">
        那个偷东西的人就是我
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          语文答问
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          语文答问
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-28-%E5%AD%A9%E5%AD%90%E4%B8%8D%E4%BC%9A%E5%86%99%E4%BD%9C%E6%96%87%EF%BC%8C%E8%83%BD%E8%AF%B4%EF%BC%8C%E4%B8%80%E5%88%B0%E5%86%99%E5%B0%B1%E4%B8%8D%E4%BC%9A%E4%BA%86/" class="md-nav__link">
        孩子不会写作文，能说，一到写就不会了
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-09-23-%E6%B1%89%E8%AF%AD%E6%8B%BC%E9%9F%B3%E9%9F%B5%E6%AF%8Do%E7%9A%84%E8%AF%BB%E6%B3%95/" class="md-nav__link">
        汉语拼音韵母o的读法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-04-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%8B%BC%E9%9F%B3ao%E4%B8%8D%E5%86%99%E4%BD%9Cau/" class="md-nav__link">
        为什么拼音ao不写作au
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-06-10-%E7%A9%B6%E7%AB%9F%E6%9C%89%E6%B2%A1%E6%9C%89%E2%80%9C%E6%82%A8%E4%BB%AC%E2%80%9D%E8%BF%99%E7%A7%8D%E7%94%A8%E6%B3%95/" class="md-nav__link">
        究竟有没有“您们”这种用法？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-06-10-%E2%80%9C%E5%85%B1%E2%80%9D%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BB%8E%E9%83%A8%E9%A6%96%E2%80%9C%E8%89%B9%E2%80%9D%E5%8F%AF%E4%BB%A5%E6%9F%A5%E5%88%B0/" class="md-nav__link">
        “共”为什么从部首“艹”可以查到
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-06-06-%E6%B1%89%E5%AD%97%E4%B8%BA%E4%BD%95%E6%98%AF%E7%AE%80%E5%8C%96%E7%9A%84%E8%B6%8B%E5%8A%BF/" class="md-nav__link">
        汉字为何是简化的趋势
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-06-02-%E4%B8%80%E5%B9%B4%E7%BA%A7%E4%B8%8B%E5%AD%A6%E6%9C%9F%E6%8B%BC%E9%9F%B3%E5%AD%97%E6%AF%8D%E8%A1%A8%E4%B8%BA%E4%BB%80%E4%B9%88%E6%98%AF%E8%8B%B1%E6%96%87%E5%AD%97%E6%AF%8D%E7%9A%84%E9%A1%BA%E5%BA%8F/" class="md-nav__link">
        一年级下学期拼音字母表为什么是英文字母的顺序
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-03-26-%E5%A6%82%E4%BD%95%E7%9C%8B%E5%BE%85%E9%B2%81%E8%BF%85%E5%85%88%E7%94%9F%E6%8F%90%E5%87%BA%E7%9A%84%E5%BA%9F%E9%99%A4%E6%B1%89%E5%AD%97/" class="md-nav__link">
        如何看待鲁迅先生提出要废除汉字
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-05-20-%E9%81%87%E5%88%B0%E9%9A%BE%E5%AD%97%E6%80%8E%E4%B9%88%E8%BE%93%E5%85%A5/" class="md-nav__link">
        遇到难字怎么输入
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-02-15-%E5%BD%93%E5%88%9D%E5%88%9B%E5%88%B6%E6%8B%BC%E9%9F%B3%E7%9A%84%E6%97%B6%E5%80%99%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E7%94%A8v%E8%80%8C%E7%94%A8%C3%BC%EF%BC%9F%EF%BC%88%E6%B1%89%E8%AF%AD%E6%8B%BC%E9%9F%B3%E6%96%B9%E6%A1%88%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98%EF%BC%89/" class="md-nav__link">
        当初创制拼音的时候为什么不用v而用ü？（汉语拼音方案的一些问题）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-02-26-%E6%B1%89%E8%AF%AD%E6%8B%BC%E9%9F%B3%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8F%AB%E6%B1%89%E8%AF%AD%E6%8B%BC%E9%9F%B3%EF%BC%8C%E8%80%8C%E4%B8%8D%E5%8F%AB%E6%B1%89%E8%AF%AD%E6%B3%A8%E9%9F%B3%E6%88%96%E6%B1%89%E8%AF%AD%E9%9F%B3%E6%A0%87/" class="md-nav__link">
        汉语拼音为什么叫汉语拼音，而不叫汉语注音或汉语音标？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-22-%E5%AE%8B%E4%BD%93%E5%AD%97%E6%98%AF%E5%90%A6%E6%98%AF%E6%9C%80%E9%95%BF%E6%97%B6%E9%97%B4%E9%80%82%E5%90%88%E9%98%85%E8%AF%BB%E7%9A%84%E5%AD%97%E4%BD%93/" class="md-nav__link">
        宋体字是否是最长时间适合阅读的字体？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-05-%E7%AE%80%E4%BD%93%E5%AD%97%E9%87%8C%E4%B8%89%E7%82%B9%E6%B0%B4%E4%B8%BA%E4%BB%80%E4%B9%88%E7%AE%80%E5%8C%96%E4%B8%BA%E4%B8%A4%E7%82%B9%E6%B0%B4/" class="md-nav__link">
        简体字里三点水为什么简化为两点水？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-16-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%95%BF%E6%97%B6%E9%97%B4%E7%9B%AF%E7%9D%80%E4%B8%80%E4%B8%AA%E6%B1%89%E5%AD%97%EF%BC%8C%E4%BC%9A%E8%A7%89%E5%BE%97%E5%BE%88%E5%A5%87%E6%80%AA%EF%BC%8C%E8%A7%89%E5%BE%97%E4%B8%8D%E8%AE%A4%E8%AF%86%E8%BF%99%E4%B8%AA%E6%B1%89%E5%AD%97/" class="md-nav__link">
        为什么长时间盯着一个汉字，会觉得很奇怪，觉得不认识这个汉字?
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-19-%E4%B8%BA%E4%BB%80%E4%B9%88%E7%AE%80%E5%8C%96%E5%AD%97%E3%80%8C%E5%9B%BD%E3%80%8D%E6%8A%8A%E3%80%8C%E6%88%96%E3%80%8D%E6%8D%A2%E6%88%90%E4%BA%86%E3%80%8C%E7%8E%89%E3%80%8D%EF%BC%8C%E7%B9%81%E4%BD%93%E5%AD%97%E4%B8%AD%E7%9A%84%E3%80%8C%E6%88%96%E3%80%8D%E6%9C%89%E4%BB%80%E4%B9%88%E5%90%AB%E4%B9%89/" class="md-nav__link">
        为什么把「國」改成「国」，「或」有什么含义？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-28-%E5%BD%A2%E5%A3%B0%E5%AD%97%E5%9C%A8%E7%8E%B0%E4%BB%A3%E6%B1%89%E8%AF%AD%E5%B8%B8%E7%94%A8%E5%AD%97%E4%B8%AD%E6%89%80%E5%8D%A0%E7%9A%84%E6%AF%94%E4%BE%8B%E6%98%AF%E7%99%BE%E5%88%86%E4%B9%8B%E5%87%A0/" class="md-nav__link">
        形声字在现代汉语常用字中所占的比例是百分之几？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-12-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%B1%89%E5%AD%97%E4%BC%9A%E6%BC%94%E5%8C%96%E6%88%90%E6%96%B9%E6%96%B9%E6%AD%A3%E6%AD%A3%E7%9A%84%EF%BC%8C%E6%B2%A1%E6%9C%89%E5%9C%86%E5%9C%88%E7%BB%93%E6%9E%84%E7%9A%84%E5%81%8F%E6%97%81/" class="md-nav__link">
        为什么汉字会演化成方方正正的，没有圆圈结构的偏旁
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-06-25-%E6%B1%89%E5%AD%97%E6%9C%89%E5%A4%9A%E5%A4%9A/" class="md-nav__link">
        汉字到底有多多？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-15-%E9%80%9A%E8%BF%87%E7%AE%80%E4%BD%93%E6%B1%89%E5%AD%97%E9%9A%8F%E6%9C%BA%E7%BB%84%E5%90%88%E4%BA%A7%E7%94%9F%E6%88%91%E5%9B%BD%E7%8E%B0%E6%9C%89%E7%9A%84%E6%9F%90%E4%B8%80%E6%9C%AC%E4%B9%A6%E7%9A%84%E5%85%A8%E9%83%A8%E5%86%85%E5%AE%B9%E7%9A%84%E6%A6%82%E7%8E%87%E5%A4%A7%E7%BA%A6%E6%98%AF%E5%A4%9A%E5%B0%91%EF%BC%8C%E6%80%8E%E4%B9%88%E5%8E%BB%E8%AE%A1%E7%AE%97/" class="md-nav__link">
        简体字随机组合成某一本书的概率大约是多少，怎么算？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-17-%E5%BD%93%E4%BB%A3%E5%88%9D%E9%AB%98%E4%B8%AD%E8%AF%AD%E6%96%87%E6%95%99%E5%AD%A6%E6%98%AF%E5%90%A6%E8%BF%87%E4%BA%8E%E2%80%9C%E6%96%87%E5%AD%A6%E5%8C%96%E2%80%9D%E4%BA%86/" class="md-nav__link">
        当代初高中语文教学是否过于“文学化”了？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-03-25-%E4%B8%AD%E5%B9%B4%E8%87%AA%E5%AD%A6%E8%8B%B1%E8%AF%AD%E8%A6%81%E6%9C%89%E5%8A%A8%E5%8A%9B/" class="md-nav__link">
        中年人自学英语的动力从哪儿来？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-11-%E8%AF%AD%E6%96%87%E7%AD%94%E9%97%AE/" class="md-nav__link">
        更多语文与伴学答问 〉〉
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-11-08-%E5%9B%BD%E5%AE%B6%E5%92%8C%E8%A1%8C%E4%B8%9A%E6%A0%87%E5%87%86%E6%9C%89%E7%89%88%E6%9D%83%E5%90%97/" class="md-nav__link">
        国家和行业标准有版权吗？
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          语文专栏
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          语文专栏
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-03-10-%E9%83%BD%E8%AF%B4%E5%86%99%E6%97%A5%E8%AE%B0%E6%98%AF%E5%A5%BD%E4%B9%A0%E6%83%AF%EF%BC%8C%E4%BD%86%E5%AD%A9%E5%AD%90%E4%B8%8D%E7%88%B1%E5%86%99%E6%80%8E%E4%B9%88%E5%8A%9E/" class="md-nav__link">
        都说写日记是好习惯，但孩子不爱写怎么办
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-03-10-%E5%AD%A9%E5%AD%90%E4%B8%8D%E7%88%B1%E5%AD%A6%E4%B9%A0%EF%BC%9F%E5%85%88%E8%AE%A9%E4%BB%96%E7%88%B1%E4%B8%8A%E8%AF%BB%E4%B9%A6/" class="md-nav__link">
        孩子不爱学习？先让他爱上读书
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-04-01-%E5%8D%B4%E6%98%AF%E7%9F%B3%E6%A6%B4%E7%9F%A5%E7%AB%8B%E5%A4%8F%EF%BC%8C%E5%B9%B4%E5%B9%B4%E6%AD%A4%E6%97%A5%E4%B8%80%E8%8A%B1%E5%BC%80%EF%BC%9A%E7%AB%8B%E5%A4%8F%E7%9A%84%E5%AD%97/" class="md-nav__link">
        却是石榴知立夏，年年此日一花开：立夏的字
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-05-11-%E8%94%AC%E8%8F%9C%E9%9D%92%EF%BC%8C%E8%94%AC%E8%8F%9C%E9%9D%92%EF%BC%8C%E8%AF%B4%E8%AF%B4%E7%AC%91%E7%AC%91%E5%88%B0%E5%8C%97%E4%BA%AC%EF%BC%9A%E5%9F%8E%E9%87%8C%E7%9A%84%E5%AD%97/" class="md-nav__link">
        蔬菜青，蔬菜青，说说笑笑到北京：城里的字
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-05-26-%E8%AE%B8%E4%B8%89%E5%A4%9A%E6%98%AF%E5%93%AA%E4%B8%89%E5%A4%9A%EF%BC%9F%EF%BC%9A%E5%B0%8F%E5%AD%A9%E7%9A%84%E5%AD%97/" class="md-nav__link">
        许三多是哪三多？：小孩的字
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-05-20-%E5%AD%A9%E5%AD%90%E5%8F%AA%E6%83%B3%E5%90%AC%E9%9F%B3%E9%A2%91%E6%95%85%E4%BA%8B%E4%B8%8D%E6%83%B3%E8%AF%BB%E4%B9%A6%E7%9C%8B%E4%B9%A6%EF%BC%8C%E6%80%8E%E4%B9%88%E5%8A%9E/" class="md-nav__link">
        孩子只想听音频故事不想读书看书，怎么办？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-01-25-%E3%80%8A%E4%BA%8C%E3%80%87%E4%BA%8C%E4%B8%80%E5%B9%B4%E5%85%A8%E5%9B%BD%E5%A7%93%E5%90%8D%E6%8A%A5%E5%91%8A%E3%80%8B%E5%8F%91%E5%B8%83%EF%BC%8C%E4%BD%A0%E5%AE%B6%E5%AD%A9%E5%AD%90%E2%80%9C%E6%92%9E%E5%90%8D%E2%80%9D%E4%BA%86%E5%90%97/" class="md-nav__link">
        《二〇二一年全国姓名报告》发布，你家孩子“撞名”了吗？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-01-23-%E6%98%A5%E8%8A%82%E5%81%87%E6%9C%9F%E9%87%8C%EF%BC%8C%E6%80%8E%E4%B9%88%E8%AE%A9%E5%AD%A9%E5%AD%90%E8%AF%BB%E4%B9%A6%E6%9B%B4%E6%9C%89%E6%94%B6%E8%8E%B7/" class="md-nav__link">
        春节假期里，怎么让孩子读书更有收获
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          学习的技术、资料与游戏
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          学习的技术、资料与游戏
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-06-24-%E8%87%AA%E5%88%B6%E5%84%BF%E7%AB%A5%E5%90%AF%E8%92%99%E9%9B%86%E4%B8%AD%E8%AF%86%E5%AD%97%E8%AF%AD%E6%96%99%E5%BA%93%E4%B8%8E%E5%88%86%E7%BA%A7%E5%AD%97%E8%A1%A8/" class="md-nav__link">
        自制儿童识字语料库与分级字表
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-06-24-%E8%87%AA%E5%88%B6%E5%84%BF%E7%AB%A5%E5%90%AF%E8%92%99%E9%9B%86%E4%B8%AD%E8%AF%86%E5%AD%97%E5%88%86%E7%BA%A7%E5%AD%97%E8%A1%A8/" class="md-nav__link">
        自制儿童识字分级字表
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-04-25-%E8%AF%86%E5%AD%97%E9%87%8F%E6%B5%8B%E8%AF%95/" class="md-nav__link">
        试试你认识多少字
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-10-02-%E5%84%BF%E7%AB%A5%E8%AF%86%E5%AD%97%E7%94%A8%E6%B1%89%E8%AF%AD%E6%96%87%E6%9C%AC%E7%9A%84%E9%9A%BE%E5%BA%A6%E7%AE%97%E6%B3%95/" class="md-nav__link">
        儿童识字用汉语文本的难度算法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-10-14-%E6%8B%BC%E5%AD%97%E6%B8%B8%E6%88%8F%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3/" class="md-nav__link">
        《拼字》游戏软件说明文档
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-06-13-%E6%B2%A1%E8%B6%A3%E6%B8%B8%E6%88%8F2.0/" class="md-nav__link">
        汉字《拼字》游戏2.0
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-12-5-%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%BD%AF%E4%BB%B6%E8%91%97%E4%BD%9C%E6%9D%83%E7%99%BB%E8%AE%B0%E5%AE%9E%E4%BE%8B/" class="md-nav__link">
        计算机软件著作权登记实例
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-06-15-%E4%B8%80%E5%AD%97%E4%B8%8D%E8%90%BD/" class="md-nav__link">
        跟我的《拼字》“同款”的几种游戏
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-10-10-%E3%80%8A%E9%80%9A%E7%94%A8%E8%A7%84%E8%8C%83%E6%B1%89%E5%AD%97%E8%A1%A8%E3%80%8B%E4%B8%AD%E6%9E%84%E5%AD%97%E6%9C%80%E5%A4%9A%E7%9A%84100%E4%B8%AA%E9%83%A8%E4%BB%B6/" class="md-nav__link">
        《通用规范汉字表》中构字最多的100个部件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-05-25-%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E6%B8%B8%E6%88%8F%E6%95%B4%E7%90%86/" class="md-nav__link">
        语言学习游戏整理(草稿)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-05-25-%E8%A7%86%E9%A2%91%E7%9B%8A%E6%99%BA%E6%B8%B8%E6%88%8F%E5%88%86%E7%B1%BB/" class="md-nav__link">
        视频益智游戏分类
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          亲子写字
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          亲子写字
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2023-01-02-%E4%BA%B2%E5%AD%90%E5%86%99%E5%AD%97%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        亲子写字笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-09-29-%E7%AC%94%E9%A1%BA%E5%8A%A8%E7%94%BB/" class="md-nav__link">
        2678字笔顺动画
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-06-02-%E5%A6%82%E4%BD%95%E5%90%91%E5%AD%A9%E5%AD%90%E8%A7%A3%E9%87%8A%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%80%E5%AE%9A%E8%A6%81%E6%8C%89%E7%AC%94%E9%A1%BA%E5%86%99%E5%AD%97/" class="md-nav__link">
        如何向孩子解释为什么一定要按笔顺写字
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-05-16-%E9%A2%9C%E7%9C%9F%E5%8D%BF%E6%9C%89%E6%B2%A1%E6%9C%89%E5%86%99%E9%94%99%E5%AD%97/" class="md-nav__link">
        颜真卿有没有写错字
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-05-28-%E6%98%AF%E4%B8%8D%E6%98%AF%E5%8F%AA%E6%9C%89%E6%B1%89%E5%AD%97%E6%89%8D%E8%83%BD%E5%86%99%E5%87%BA%E4%B9%A6%E6%B3%95/" class="md-nav__link">
        是不是只有汉字才能写出书法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-04-19-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%8B%B1%E8%AF%AD%E5%92%8C%E6%8B%BC%E9%9F%B3%E8%A6%81%E5%AD%A6%E4%B8%A4%E5%A5%97%E6%89%8B%E5%86%99%E4%BD%93%EF%BC%9F/" class="md-nav__link">
        为什么英语和拼音要学两套手写体？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-14-%E4%B8%BA%E4%BB%80%E4%B9%88%E5%B0%8F%E5%AD%A6%E8%8B%B1%E8%AF%AD%E6%95%99%E6%9D%90%E8%A6%81%E7%94%A8%E8%BF%99%E7%A7%8D%E5%AD%97%E4%BD%93%E4%BD%93%E5%8D%B0%E5%88%B7/" class="md-nav__link">
        为什么小学英语教材要用这种字体印刷
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-06-19-%E6%B3%95%E5%B8%96%E7%BD%91%E5%9B%BE%E6%AF%94%E4%B9%A6%E6%B8%85%E6%A5%9A/" class="md-nav__link">
        《高力士墓志》网图比书清楚
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-17-%E4%B9%A6%E8%AE%BA%E6%95%B4%E7%90%86%EF%BC%9A%E3%80%8A%E6%8E%88%E7%AC%94%E8%A6%81%E8%AF%B4%E3%80%8B/" class="md-nav__link">
        书论：唐·韩方明《授笔要说》
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-17-%E4%B9%A6%E8%AE%BA%E6%95%B4%E7%90%86%EF%BC%9A%E3%80%8A%E6%B5%B7%E5%B2%B3%E5%90%8D%E8%A8%80%E3%80%8B/" class="md-nav__link">
        书论：宋·米芾《海岳名言》
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-17-%E4%B9%A6%E8%AE%BA%E6%95%B4%E7%90%86%EF%BC%9A%E3%80%8A%E7%BF%B0%E5%A2%A8%E5%BF%97%E3%80%8B/" class="md-nav__link">
        书论：宋高宗赵构《翰墨志》
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-17-%E4%B9%A6%E8%AE%BA%E6%95%B4%E7%90%86%EF%BC%9A%E3%80%8A%E5%A4%A7%E5%AD%97%E7%BB%93%E6%9E%84%E5%85%AB%E5%8D%81%E5%9B%9B%E6%B3%95%E3%80%8B/" class="md-nav__link">
        书论：明·李淳《大字结构八十四法》
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-17-%E4%B9%A6%E8%AE%BA%E6%95%B4%E7%90%86%EF%BC%9A%E3%80%8A%E7%BF%B0%E6%9E%97%E8%A6%81%E8%AF%80%E3%80%8B/" class="md-nav__link">
        书论：元·陈绎曾《翰林要诀》
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-17-%E4%B9%A6%E8%AE%BA%E6%95%B4%E7%90%86%EF%BC%9A%E3%80%8A%E4%B9%A6%E6%B3%95%E4%B8%89%E6%98%A7%E3%80%8B/" class="md-nav__link">
        书论：元·佚名《书法三昧》
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-17-%E4%B9%A6%E8%AE%BA%E6%95%B4%E7%90%86%EF%BC%9A%E3%80%8A%E5%A2%A8%E6%B1%A0%E7%90%90%E5%BD%95%E3%80%8B/" class="md-nav__link">
        书论：明·杨慎《墨池琐录》
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-17-%E4%B9%A6%E8%AE%BA%E6%95%B4%E7%90%86%EF%BC%9A%E3%80%8A%E4%B9%A6%E6%B3%95%E7%BA%B6%E8%B4%AF%E3%80%8B/" class="md-nav__link">
        书论：明·宋啬《书法纶贯》
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-17-%E4%B9%A6%E8%AE%BA%E6%95%B4%E7%90%86%EF%BC%9A%E3%80%8A%E4%B9%A6%E6%B3%95%E7%BA%A6%E8%A8%80%E3%80%8B/" class="md-nav__link">
        书论：明末清初·宋曹《书法约言》
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-17-%E4%B9%A6%E8%AE%BA%E6%95%B4%E7%90%86%EF%BC%9A%E3%80%8A%E7%AB%A5%E5%AD%A6%E4%B9%A6%E7%A8%8B%E3%80%8B/" class="md-nav__link">
        书论：明·丰坊《童学书程》
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
      
      
      
        <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
          少儿编程及STEAM
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          少儿编程及STEAM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2019-11-23-PygameZero%E6%96%87%E6%A1%A3%E7%9A%84%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE/" class="md-nav__link">
        Pygame Zero文档的思维导图和入门实例
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-01-29-PygameZero%E5%8A%A9%E6%89%8B/" class="md-nav__link">
        PygameZero助手（比照Scratch而做的增强）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-06-09-PygameZero%E8%B5%84%E6%BA%90/" class="md-nav__link">
        PygameZero资源
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-03-17-%E5%B0%91%E5%84%BF%E7%BC%96%E7%A8%8B%E7%94%A8%E5%9C%A8%E7%BA%BF%E7%BC%96%E8%BE%91%E5%99%A8/" class="md-nav__link">
        少儿编程用在线编辑器
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-12-06-Python%E6%89%BE%E9%97%A8%E6%95%99%E7%A8%8B-%E7%9B%AE%E5%BD%95-%E6%B4%BE%E7%9C%9F%E5%92%8C%E4%B8%A4%E6%9D%A1%E8%85%BF%E6%9D%A5%E5%88%B0%E5%93%88%E7%BD%97%E4%B8%96%E7%95%8C/" class="md-nav__link">
        派真和两条腿来到哈罗世界
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-12-21-%E7%BC%96%E7%A8%8B%E7%8E%AF%E5%A2%83/" class="md-nav__link">
        编程环境
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2019-10-05-%E5%88%9D%E5%AD%A6python%E6%9C%89%E5%93%AA%E4%BA%9B%E7%BC%96%E8%BE%91%E5%99%A8%E6%8E%A8%E8%8D%90/" class="md-nav__link">
        初学python，有哪些编辑器推荐
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-13-Python%E7%BC%96%E7%A8%8B%E7%AD%94%E9%97%AE/" class="md-nav__link">
        Python编程答问
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2019-05-15-Python%E7%A6%85/" class="md-nav__link">
        Python口头禅
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-12-27-Pyo%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        Pyo学习笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-12-28-Pyo%E6%96%87%E6%A1%A3%EF%BC%88%E4%B8%80%EF%BC%89/" class="md-nav__link">
        Pyo文档（一）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2019-1-1-Pyo%E6%96%87%E6%A1%A3%EF%BC%88%E4%BA%8C%EF%BC%89%E5%AE%9E%E4%BE%8B/" class="md-nav__link">
        Pyo文档（二）实例
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2023-03-18-%E3%80%8A%E6%9E%81%E7%AE%80%E7%AE%97%E6%9C%AF%E5%8F%B2%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        《极简算术史》读书笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2019-10-20-%E6%95%99%E5%AD%A9%E5%AD%90%E9%AA%91%E8%87%AA%E8%A1%8C%E8%BD%A6/" class="md-nav__link">
        教孩子骑自行车
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
      
      
      
        <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
          启蒙文摘
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          启蒙文摘
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-06-12-%E6%95%99%E7%AB%A5%E5%AD%90%E6%B3%95/" class="md-nav__link">
        教童子法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-06-10-%E8%BF%9E%E7%8E%AF%E5%9B%BE%E7%94%BB%E7%90%90%E8%B0%88/" class="md-nav__link">
        连环图画琐谈
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-06-10-%E3%80%8A%E7%9C%8B%E5%9B%BE%E8%AF%86%E5%AD%97%E3%80%8B/" class="md-nav__link">
        《看图识字》
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-06-10-%E4%BA%BA%E7%94%9F%E8%AF%86%E5%AD%97%E8%83%A1%E6%B6%82%E5%A7%8B/" class="md-nav__link">
        人生识字胡涂始
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-06-11-%E7%8E%8B%E9%95%9B%E4%B9%A6%E8%8B%8F%E8%BD%BC%E7%9F%B3%E8%8B%8D%E8%88%92%E9%86%89%E5%A2%A8%E5%A0%82%E8%AF%97/" class="md-nav__link">
        王镛书苏轼石苍舒醉墨堂诗
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-06-11-%E3%80%8A%E4%BC%A0%E7%BB%9F%E8%AF%AD%E6%96%87%E6%95%99%E8%82%B2%E6%95%99%E6%9D%90%E8%AE%BA%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        《传统语文教育教材论》阅读笔记
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
      
      
      
        <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
          老编辑的效率工具
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_12">
          <span class="md-nav__icon md-icon"></span>
          老编辑的效率工具
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2019-10-12-%E5%B8%B8%E7%94%A8%E8%BD%AF%E4%BB%B6%E3%80%81%E8%AF%AD%E8%A8%80%E5%92%8C%E6%A1%86%E6%9E%B6/" class="md-nav__link">
        常用/备用软件、语言和框架
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-07-11-%E6%95%88%E7%8E%87%E5%B7%A5%E5%85%B7%E7%AD%94%E9%97%AE/" class="md-nav__link">
        效率工具答问（累积更新）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2023-03-03-%E7%94%A8ChatGPT%E8%AE%AD%E7%BB%83%E4%B8%80%E4%BD%8D%E8%82%B2%E5%84%BF%E6%95%99%E7%BB%83/" class="md-nav__link">
        用ChatGPT训练一位育儿教练
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2023-03-04-80-Ways-to-Use-ChatGPT-in-the-Classroom/" class="md-nav__link">
        《ChatGPT辅助教学80招》目录试译
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-01-10-VSCode%E5%B0%8F%E6%8A%84/" class="md-nav__link">
        VSCode小抄
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2023-03-02-%E7%BB%99%E8%87%AA%E5%B7%B1%E9%85%8D%E7%BD%AE%E7%A7%B0%E5%BF%83%E5%A6%82%E6%84%8F%E7%9A%84%E5%86%99%E4%BD%9C%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        给自己配置称心如意的写作工具
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-11-7-%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7%E5%BF%97/" class="md-nav__link">
        奇技淫巧志
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-03-04-%E6%88%91%E5%B8%B8%E7%94%A8%E7%9A%84TextPro%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9B%BF%E6%8D%A2%E8%A1%A8/" class="md-nav__link">
        我常用的TextPro用自定义替换表
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-09-01-libreoffice%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98/" class="md-nav__link">
        LibreOfficeWriter使用问题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-10-26-%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%A4%84%E7%90%86%E6%96%87%E6%9C%AC%E3%80%81%E7%AE%A1%E7%90%86%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%89%E4%BB%B6%E5%A5%97/" class="md-nav__link">
        用正则表达式处理文本、管理文件的三件套
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-05-31-%E7%BB%99%E7%BC%96%E8%BE%91%E6%9C%8B%E5%8F%8B%E7%9A%84%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%AF%BE%E7%A8%8B/" class="md-nav__link">
        给编辑朋友的正则表达式课程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-02-02-%E6%95%99%E8%82%B2%E7%A1%AC%E4%BB%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        教育硬件学习笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-12-12-%E5%B0%8F%E5%B7%A5%E5%85%B7%EF%BC%9A%E4%BB%8E%E5%A4%9A%E6%96%87%E4%BB%B6%E4%B8%AD%E6%94%B6%E9%9B%86%E5%AD%97%E7%AC%A6%E4%B8%B2/" class="md-nav__link">
        小工具：从多文件中收集字符串
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-12-14-Audition%E6%8A%80%E5%B7%A7%EF%BC%9A%E4%BD%BF%E4%B8%A4%E6%AE%B5%E4%B8%8D%E5%90%8C%E7%8E%AF%E5%A2%83%E7%9A%84%E5%BD%95%E9%9F%B3%E5%8D%8F%E8%B0%83%E4%B8%80%E8%87%B4/" class="md-nav__link">
        Audition技巧：使两段不同环境的录音协调一致
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-12-14-Audition%E6%8A%80%E5%B7%A7%EF%BC%9A%E8%87%AA%E5%8A%A8%E5%88%86%E5%88%87%E9%9F%B3%E9%A2%91/" class="md-nav__link">
        Audition技巧：半自动分切音频
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-12-15-%E5%B0%8F%E5%B7%A5%E5%85%B7%EF%BC%9A%E5%88%86%E5%89%B2%E6%96%87%E6%9C%AC%E6%96%87%E4%BB%B6/" class="md-nav__link">
        小工具：分割文本文件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2020-09-26-%E7%A1%AC%E7%9B%98%E6%8D%9F%E5%9D%8F%EF%BC%8C%E6%8A%A2%E6%95%91%E6%95%B0%E6%8D%AE/" class="md-nav__link">
        硬盘损坏，抢救数据
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-27-markdown%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        markdown学习笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-02-04-%E4%B8%A4%E7%A7%8Dmarkdown%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E6%96%B9%E6%B3%95/" class="md-nav__link">
        两种markdown文件解析方法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-04-16-markdown%E4%B8%AD%E7%9A%84mermaid%E5%9B%BE%E4%BE%8B/" class="md-nav__link">
        markdown中的mermaid图例
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-02-05-%E6%9C%89%E6%B2%A1%E6%9C%89%E5%90%88%E9%80%82%E7%9A%84%E8%83%BD%E6%9B%BF%E4%BB%A3flash%E7%9A%84%E8%BD%AF%E4%BB%B6%E6%8E%A8%E8%8D%90%E7%9A%84/" class="md-nav__link">
        有没有合适的能替代flash的软件推荐？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-03-02-mkdocs-material%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        静态网站框架mkdocs+material学习笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-03-12-mkdocs-macros-plugin%E5%AE%8F%E6%8F%92%E4%BB%B6/" class="md-nav__link">
        mkdocs-macros-plugin宏插件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-04-22-autotrace%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3/" class="md-nav__link">
        autotrace说明文档
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-10-14-%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2%E7%94%9F%E6%88%90%E5%99%A8Pelican%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        静态网站生成器Pelican学习笔记
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
      
      
      
        <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
          Phaser学习中心组
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          Phaser学习中心组
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-04-12-Phaser3%E6%B8%B8%E6%88%8F%E7%BB%93%E6%9E%84%E7%A4%BA%E4%BE%8B/" class="md-nav__link">
        Phaser3游戏结构示例（未完成）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-04-03-Phaser3%E7%9A%84%E6%A8%A1%E5%9D%97%E7%BB%93%E6%9E%84/" class="md-nav__link">
        Phaser3的模块结构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-03-30-%E5%9C%A8Phaser%E6%B8%B8%E6%88%8F%E4%B8%AD%E5%B5%8C%E5%85%A5%E5%AD%97%E4%BD%93/" class="md-nav__link">
        在Phaser游戏中嵌入字体
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2019-2-10-Phaser%E6%96%B0%E9%97%BB%E8%81%94%E6%92%AD/" class="md-nav__link">
        Phaser新闻联播
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-12-4-Phaser%203%20FAQ%201/" class="md-nav__link">
        Phaser3常识答问（一）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-12-4-Phaser%203%20FAQ%202/" class="md-nav__link">
        Phaser3常识答问（二）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-11-12-Phaser3%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        Phaser3学习笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2019-1-8-Phaser3%E5%AE%98%E7%BD%91%E5%AE%9E%E4%BE%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        Phaser3官网实例学习笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-10-14-Phaser2%E5%AE%98%E7%BD%91%E5%AE%9E%E4%BE%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        Phaser2官网实例学习笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-10-14-%E4%B8%80%E4%B8%AA%E4%B8%9A%E4%BD%99%E4%B9%A0Phaser%E7%9A%84%E9%87%8E%E8%B7%AF%E5%AD%90/" class="md-nav__link">
        一个业余习Phaser的野路子
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
      
      
      
        <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
          Phaser3文档注记
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_14">
          <span class="md-nav__icon md-icon"></span>
          Phaser3文档注记
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-03-30-GameConfig%E6%B8%B8%E6%88%8F%E9%85%8D%E7%BD%AE/" class="md-nav__link">
        GameConfig游戏配置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-03-30-Phaser.Scale.ScaleManager/" class="md-nav__link">
        ScaleManager窗口适配
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2019-1-2-Phaser3%20API%E6%96%87%E6%A1%A3%E5%A4%A7%E7%BA%B2-Scene/" class="md-nav__link">
        Scene场景
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-03-31-Phaser.Scenes.ScenePlugin/" class="md-nav__link">
        ScenePlugin场景管理器
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-12-1-Phaser3%20API%E6%96%87%E6%A1%A3%E5%A4%A7%E7%BA%B2-Loader.LoaderPlugin/" class="md-nav__link">
        LoaderPlugin加载器
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-11-24-Phaser3%20API%E6%96%87%E6%A1%A3%E5%A4%A7%E7%BA%B2-Sprite/" class="md-nav__link">
        Sprite精灵
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-03-31-Phaser.GameObjects.Graphics%E5%9B%BE%E7%94%BB%E7%B1%BB/" class="md-nav__link">
        Graphics图形
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-04-02-Phaser.GameObjects.Text/" class="md-nav__link">
        Phaser.GameObjects.Text文本
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-11-30-Phaser3%20API%E6%96%87%E6%A1%A3%E5%A4%A7%E7%BA%B2-Container/" class="md-nav__link">
        Container容器
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-11-30-Phaser3%20API%E6%96%87%E6%A1%A3%E5%A4%A7%E7%BA%B2-Group/" class="md-nav__link">
        Group组
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-11-30-Phaser3%20API%E6%96%87%E6%A1%A3%E5%A4%A7%E7%BA%B2-Actions/" class="md-nav__link">
        Actions批处理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2019-1-8-Phaser3%20API%E6%96%87%E6%A1%A3%E5%A4%A7%E7%BA%B2-InputPlugin/" class="md-nav__link">
        InputPlugin输入管理器
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-12-23-Phaser.Input.Pointer/" class="md-nav__link">
        Pointer热点
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-04-03-Phaser.Cameras.Scene2D.Camera/" class="md-nav__link">
        Camera镜头
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-04-14-Phaser3%E5%9C%BA%E6%99%AF%E4%B8%80%E8%A7%88/" class="md-nav__link">
        Phaser3场景一览
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-04-12-Phaser3%E6%B8%B8%E6%88%8F%E5%AF%B9%E8%B1%A1%E4%B8%80%E8%A7%88/" class="md-nav__link">
        Phaser3游戏对象一览
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-04-13-Phaser3%E4%BA%8B%E4%BB%B6%E4%B8%80%E8%A7%88/" class="md-nav__link">
        Phaser3事件一览
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-04-15-%E7%89%A9%E7%90%86%E7%B3%BB%E7%BB%9F%E4%B8%80%E8%A7%88/" class="md-nav__link">
        Phaser3物理模块一览
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-04-15-%E5%9C%BA%E6%99%AFArcade%E7%89%A9%E7%90%86%E7%B3%BB%E7%BB%9F%E4%B8%80%E8%A7%88/" class="md-nav__link">
        场景的Arcade物理系统一览
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-04-15-%E5%9C%BA%E6%99%AFArcade%E7%89%A9%E7%90%86%E4%B8%96%E7%95%8C%E4%B8%80%E8%A7%88/" class="md-nav__link">
        场景的Arcade物理世界一览
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-04-15-%E5%8A%A8%E6%80%81Arcade%E7%89%A9%E4%BD%93%E4%B8%80%E8%A7%88/" class="md-nav__link">
        Arcade动态物体一览
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" >
      
      
      
        <label class="md-nav__link" for="__nav_15" id="__nav_15_label" tabindex="0">
          Phaser3官网入门教程
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_15">
          <span class="md-nav__icon md-icon"></span>
          Phaser3官网入门教程
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../making-your-first-phaser-3-game/" class="md-nav__link">
        第一节 - 前言
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../making-your-first-phaser-3-game/part2/" class="md-nav__link">
        第二节 - 加载资源
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../making-your-first-phaser-3-game/part3/" class="md-nav__link">
        第三节 - 建立游戏世界
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../making-your-first-phaser-3-game/part4/" class="md-nav__link">
        第四节 - 平台
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../making-your-first-phaser-3-game/part5/" class="md-nav__link">
        第5节 - 玩家
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../making-your-first-phaser-3-game/part6/" class="md-nav__link">
        第6节 - 添加物理系统
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../making-your-first-phaser-3-game/part7/" class="md-nav__link">
        第7节 - 键盘控制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../making-your-first-phaser-3-game/part8/" class="md-nav__link">
        第8节 - 收集星星
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../making-your-first-phaser-3-game/part9/" class="md-nav__link">
        第9节 - 计分
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../making-your-first-phaser-3-game/part10/" class="md-nav__link">
        第10节 - 跳跳弹
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_16" checked>
      
      
      
        <label class="md-nav__link" for="__nav_16" id="__nav_16_label" tabindex="0">
          TEX, ConTeXt与排版自动化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_16_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_16">
          <span class="md-nav__icon md-icon"></span>
          TEX, ConTeXt与排版自动化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2023-03-30-%E4%BD%BFTypst%E7%9A%84par%E8%83%BD%E8%B0%83%E6%95%B4%E6%B1%89%E5%AD%97%E9%97%B4%E8%B7%9D/" class="md-nav__link">
        使Typst par能调整汉字间距
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2023-03-28-%E4%BD%93%E9%AA%8CTypst/" class="md-nav__link">
        体验Typst
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2023-03-25-Typst%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        Typst学习笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-11-20-ConTeXt%E7%AE%80%E4%BB%8B%E5%92%8C%E4%B8%AD%E6%96%87%E6%8E%92%E7%89%88%E6%95%88%E6%9E%9C/" class="md-nav__link">
        ConTeXt简介和中文排版效果
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-10-28-ConTeXt-LMTX%E6%A0%87%E7%82%B9%E5%8E%8B%E7%BC%A9%E6%8F%92%E4%BB%B6/" class="md-nav__link">
        ConTeXt中文标点压缩插件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-15-ConTeXt-LMTX%E4%B8%AD%E6%96%87%E7%AB%96%E6%8E%92%E6%8F%92%E4%BB%B6/" class="md-nav__link">
        ConTeXt LMTX中文竖排插件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-01-14-ConTeXt-LMTX%E7%9A%84%E6%B1%89%E5%AD%97%E7%AB%96%E6%8E%92%E6%80%9D%E8%B7%AF/" class="md-nav__link">
        ConTeXt LMTX中文竖排思路
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-06-19-ConTeXt%E5%8F%8C%E8%A1%8C%E5%A4%B9%E6%B3%A8%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/" class="md-nav__link">
        ConTeXt+LMTX双行夹注的简单实现
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-20-luametatex-node-playground/" class="md-nav__link">
        LuaTeX结点游乐场
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-23-luametatex-callback-playground/" class="md-nav__link">
        LuaTeX回调游乐场
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          LuaTeX-LMTX-CLD学习笔记
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        LuaTeX-LMTX-CLD学习笔记
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#vscode" class="md-nav__link">
    vscode开发环境设置
  </a>
  
    <nav class="md-nav" aria-label="vscode开发环境设置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    编译配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lua" class="md-nav__link">
    Lua配置
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luatex" class="md-nav__link">
    LuaTeX
  </a>
  
    <nav class="md-nav" aria-label="LuaTeX">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    数据结构：结点和结点列表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#box" class="md-nav__link">
    box及其排版程序
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    结点表示
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    主要文本结点
  </a>
  
    <nav class="md-nav" aria-label="主要文本结点">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#9_parlocal_par" class="md-nav__link">
    9 par(local_par)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0_hlist" class="md-nav__link">
    0 hlist
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1_vlist" class="md-nav__link">
    1 vlist
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#29_glyph" class="md-nav__link">
    29 glyph
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12_glue" class="md-nav__link">
    12 glue
  </a>
  
    <nav class="md-nav" aria-label="12 glue">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    汉字字间胶
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13_kern" class="md-nav__link">
    13 kern
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14_penalty" class="md-nav__link">
    14 penalty
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_rule" class="md-nav__link">
    2 rule
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_insert" class="md-nav__link">
    3 insert
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_mark" class="md-nav__link">
    4 mark
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5_adjust" class="md-nav__link">
    5 adjust
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7_disc" class="md-nav__link">
    7 disc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#18_noad" class="md-nav__link">
    18 noad
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8_whatsit" class="md-nav__link">
    8 whatsit前端小玩意
  </a>
  
    <nav class="md-nav" aria-label="8 whatsit前端小玩意">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#user_defined" class="md-nav__link">
    user_defined
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6_boundary" class="md-nav__link">
    6 boundary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#10_dir" class="md-nav__link">
    10 dir
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#28_margin_kern" class="md-nav__link">
    28 margin_kern
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node" class="md-nav__link">
    node库
  </a>
  
    <nav class="md-nav" aria-label="node库">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    导语
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type" class="md-nav__link">
    type结点类型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fields" class="md-nav__link">
    fields结点字段
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#new" class="md-nav__link">
    new新建结点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#free" class="md-nav__link">
    free释放结点内存
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy" class="md-nav__link">
    copy拷贝结点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#next" class="md-nav__link">
    next前后结点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#current_attr" class="md-nav__link">
    current_attr当前属性结点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hpack" class="md-nav__link">
    hpack打横包
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vpack" class="md-nav__link">
    vpack打竖包
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    把行间距加入行中
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dimensions" class="md-nav__link">
    dimensions行尺寸
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    数学列表转行列表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tail" class="md-nav__link">
    tail尾结点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#slide" class="md-nav__link">
    slide滑到尾结点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#length" class="md-nav__link">
    length结点计数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    是不是字符、是不是字模
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traverse" class="md-nav__link">
    traverse迭代结点列表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traverse_id" class="md-nav__link">
    traverse_id
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traverse_char" class="md-nav__link">
    traverse_char
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traverse_list" class="md-nav__link">
    traverse_list
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    通过双向链接迭代
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#has_glyph" class="md-nav__link">
    has_glyph
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#first_glyph" class="md-nav__link">
    first_glyph
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#end_of_math" class="md-nav__link">
    end_of_math
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove" class="md-nav__link">
    remove
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insert_before_insert_after" class="md-nav__link">
    insert_before, insert_after
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ligaturing" class="md-nav__link">
    ligaturing应用合体字
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kerning" class="md-nav__link">
    kerning应用字间
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    字模与字符结点转换
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#last_node" class="md-nav__link">
    last_node
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write" class="md-nav__link">
    write
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    结点能否跳过
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setglue" class="md-nav__link">
    setglue注胶
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getglue" class="md-nav__link">
    getglue查看胶值
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#is_zero_glue" class="md-nav__link">
    is_zero_glue空值胶
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    结点的两种取用模式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    属性的处理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#property" class="md-nav__link">
    结点资产Property表
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tex" class="md-nav__link">
    TeX相关库
  </a>
  
    <nav class="md-nav" aria-label="TeX相关库">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tex_1" class="md-nav__link">
    tex库
  </a>
  
    <nav class="md-nav" aria-label="tex库">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    简介
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setget" class="md-nav__link">
    内部参数值的set、get
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    转换命令
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#last_item" class="md-nav__link">
    last item命令
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_get_and_is" class="md-nav__link">
    取用寄存器：set, get and is*
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#code_getsetcodes" class="md-nav__link">
    字符code寄存器: [get|set]*code[s]
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#box_getsetbox" class="md-nav__link">
    Box寄存器: [get|set]box
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#boxe_usesaveboxresource_and_getboxresourcedimensions" class="md-nav__link">
    重用boxe: [use|save]boxresource and getboxresourcedimensions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#triggerbuildpage" class="md-nav__link">
    triggerbuildpage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#splitbox" class="md-nav__link">
    splitbox
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing_math_parameters_getsetmath" class="md-nav__link">
    Accessing math parameters: [get|set]math
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#special_list_heads_getsetlist" class="md-nav__link">
    Special list heads: [get|set]list
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#semantic_nest_levels_getnest_and_ptr" class="md-nav__link">
    Semantic nest levels: getnest and ptr
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#print_functions" class="md-nav__link">
    Print functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    辅助函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions_for_dealing_with_primitives" class="md-nav__link">
    Functions for dealing with primitives
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    内核功能界面
  </a>
  
    <nav class="md-nav" aria-label="内核功能界面">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#badness" class="md-nav__link">
    badness
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#texresetparagraph" class="md-nav__link">
    tex.resetparagraph
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linebreak" class="md-nav__link">
    linebreak分行
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shipout" class="md-nav__link">
    shipout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getpagestate" class="md-nav__link">
    getpagestate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getlocallevel" class="md-nav__link">
    getlocallevel
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#randomizers" class="md-nav__link">
    Randomizers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions_related_to_synctex" class="md-nav__link">
    Functions related to synctex
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token" class="md-nav__link">
    token库
  </a>
  
    <nav class="md-nav" aria-label="token库">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    扫描器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token_1" class="md-nav__link">
    生成token
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    宏
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pdfwhatsit" class="md-nav__link">
    PDF后端物件（whatsit）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fonts" class="md-nav__link">
    Fonts 字体
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luatex_1" class="md-nav__link">
    luatex字体常识
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lua_1" class="md-nav__link">
    执行lua代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#directlua" class="md-nav__link">
    预先展开：\directlua代码执行机制
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#directluascan_tokstoken" class="md-nav__link">
    \directlua预处理（scan_toks()）中不展开的权标（token）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lua_2" class="md-nav__link">
    避免lua代码展开导致的问题
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#directluathetoks" class="md-nav__link">
    \directlua中的\the\toks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    其他展开技术
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lua_3" class="md-nav__link">
    Lua转义序列
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    以页面为单位的信息收集与统计
  </a>
  
    <nav class="md-nav" aria-label="以页面为单位的信息收集与统计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    不可能在主文件中精确引用页码计数器
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    标点压缩临时方案
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    速度问题
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tex_without_tex_revised_and_expanded" class="md-nav__link">
    TeX_without_TeX_revised_and_expanded
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luametatexlmtx" class="md-nav__link">
    LuaMetaTEX（LMTX）
  </a>
  
    <nav class="md-nav" aria-label="LuaMetaTEX（LMTX）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    引言
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    字体
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luafont" class="md-nav__link">
    Lua中的font库
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    朝向与旋转（竖排、直书）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    模块开发
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lua_in_context" class="md-nav__link">
    Lua in ConTeXt
  </a>
  
    <nav class="md-nav" aria-label="Lua in ConTeXt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    引言
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#context_interfacing" class="md-nav__link">
    ConTeXt文档中的代码执行界面 Interfacing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    引入外部代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    使用命名空间
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    库
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    输出文本
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#context_commands" class="md-nav__link">
    ConTeXt commands
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contextlua" class="md-nav__link">
    传递参数和缓存: ConTeXt命令给Lua提供的钩子
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    用例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    字符串操作
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    表格操作
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io" class="md-nav__link">
    IO
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contextluacontext" class="md-nav__link">
    在ConTeXt外部运行Lua（可使用ConTeXt环境）
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cld_context_lua_documents" class="md-nav__link">
    CLD: ConTeXt Lua Documents
  </a>
  
    <nav class="md-nav" aria-label="CLD: ConTeXt Lua Documents">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    执行方式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    常用函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    传递函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cld" class="md-nav__link">
    CLD双向传递变量
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    直接输出
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#catcodes" class="md-nav__link">
    特种码 Catcodes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    以函数而不是语句作为参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trial_typesetting" class="md-nav__link">
    试排 Trial typesetting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#steppers_luatex" class="md-nav__link">
    Steppers 从Lua临时进入TeX
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modes" class="md-nav__link">
    Modes 模式匹配
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token_2" class="md-nav__link">
    Token列表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node_1" class="md-nav__link">
    Node列表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    回调函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    页面布局与框架布局
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_45" class="md-nav__link">
    列表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_46" class="md-nav__link">
    表格
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_47" class="md-nav__link">
    放置图片
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_48" class="md-nav__link">
    风格
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forlorien" class="md-nav__link">
    ForLorien 打印数学题的完整例子
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interfacing_texunicode" class="md-nav__link">
    Interfacing TeX界面和Unicode的处理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#formatters" class="md-nav__link">
    Formatters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graphics" class="md-nav__link">
    Graphics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_49" class="md-nav__link">
    宏
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verbatim" class="md-nav__link">
    Verbatim 字符字面值
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    Logging
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lua_4" class="md-nav__link">
    Lua 函数
  </a>
  
    <nav class="md-nav" aria-label="Lua 函数">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#table" class="md-nav__link">
    table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#math" class="md-nav__link">
    math
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#boolean" class="md-nav__link">
    boolean
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#string" class="md-nav__link">
    string
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utf" class="md-nav__link">
    UTF
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#number" class="md-nav__link">
    number
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lpeg_patterns" class="md-nav__link">
    LPEG patterns 格式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io_1" class="md-nav__link">
    IO
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filedirurlos" class="md-nav__link">
    File、Dir、URL、OS
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lua_interface_code" class="md-nav__link">
    LUA 界面代码 interface code
  </a>
  
    <nav class="md-nav" aria-label="LUA 界面代码 interface code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_50" class="md-nav__link">
    字体
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nodes" class="md-nav__link">
    Nodes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resolversmathgrphmetapostluatextracing" class="md-nav__link">
    Resolvers、math、grph、MetaPost、LuaTEX、Tracing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scanners" class="md-nav__link">
    Scanners
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#print" class="md-nav__link">
    控制台print中文乱码的问题
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_51" class="md-nav__link">
    样例
  </a>
  
    <nav class="md-nav" aria-label="样例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hyphenation" class="md-nav__link">
    hyphenation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-01-10-ConTeXt%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        ConTeXt学习笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-01-10-latex-CTEX%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        latex-CTEX学习笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-05-28-TEX%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        TEX学习笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-06-22-ConTeXt-rule%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        ConTeXt rule学习笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-18-LuaTeX-LuaMetaTeX-%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%BA%90/" class="md-nav__link">
        TEX系学习资源
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-08-29-metafun%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        metafun学习笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-09-23-metapost-luametafun-examples/" class="md-nav__link">
        metapost用例
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-11-11-How-TeX-Calculates-Glue-Settings-in-an-hbox/" class="md-nav__link">
        TeX怎样计算横盒子(hbox)中的胶的设定值
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-09-13-Understanding-underfull-and-overfull-box-warnings/" class="md-nav__link">
        理解未满盒子和溢出盒子的警告信息
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2022-10-04-lua%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        学习笔记
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_17" >
      
      
      
        <label class="md-nav__link" for="__nav_17" id="__nav_17_label" tabindex="0">
          布考斯基与诗
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_17_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_17">
          <span class="md-nav__icon md-icon"></span>
          布考斯基与诗
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-10-14-%E5%B8%83%E8%80%83%E6%96%AF%E5%9F%BA%E5%B9%B4%E8%A1%A8/" class="md-nav__link">
        布考斯基年表
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-10-14-%E5%BC%B9%E9%86%89%E7%90%B4%EF%BC%9A%E5%B8%83%E8%80%83%E6%96%AF%E5%9F%BA%E8%AF%97%E9%9B%86/" class="md-nav__link">
        弹醉琴/如击鼓/直到手指滴血：布考斯基诗集
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2012-8-2-%E7%88%B1%E6%98%AF%E5%9C%B0%E7%8B%B1%E7%9A%84%E6%81%B6%E7%8B%97%EF%BC%9A%E5%B8%83%E8%80%83%E6%96%AF%E5%9F%BA%E8%AF%97%E9%9B%86/" class="md-nav__link">
        爱如恶狗：布考斯基诗集
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2009-3-18-%E6%9C%80%E7%BB%88%E4%BA%BA%E5%A6%82%E8%8A%B1%EF%BC%9A%E5%B8%83%E8%80%83%E6%96%AF%E5%9F%BA%E6%96%B0%E8%AF%97%E9%80%89%E8%AF%91/" class="md-nav__link">
        最终人如花：布考斯基新诗选译
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2019-1-3-%E9%BB%91%E9%A6%8D%E7%88%B1%E5%A4%B9%E8%8F%9C%EF%BC%88%E8%AF%95%E8%AF%91%EF%BC%89/" class="md-nav__link">
        黑馍爱夹菜（试译）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-11-9-%E3%80%8A%E7%94%9F%E6%9D%A5%E5%A6%82%E6%AD%A4%E3%80%8B%E5%AD%97%E5%B9%95/" class="md-nav__link">
        《生来如此》字幕
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2018-10-14-%E7%BA%A6%E7%BF%B0%C2%B7%E5%87%A1%E8%92%82/" class="md-nav__link">
        约翰·凡蒂（John Fante）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-03-25-%E8%AF%84%E5%93%91%E5%AD%A9%E5%AD%90%E7%9A%84%E8%AF%97%E9%9B%86/" class="md-nav__link">
        大时代，读小诗
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../about/" class="md-nav__link">
        ☆ About
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#vscode" class="md-nav__link">
    vscode开发环境设置
  </a>
  
    <nav class="md-nav" aria-label="vscode开发环境设置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    编译配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lua" class="md-nav__link">
    Lua配置
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luatex" class="md-nav__link">
    LuaTeX
  </a>
  
    <nav class="md-nav" aria-label="LuaTeX">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    数据结构：结点和结点列表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#box" class="md-nav__link">
    box及其排版程序
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    结点表示
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    主要文本结点
  </a>
  
    <nav class="md-nav" aria-label="主要文本结点">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#9_parlocal_par" class="md-nav__link">
    9 par(local_par)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0_hlist" class="md-nav__link">
    0 hlist
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1_vlist" class="md-nav__link">
    1 vlist
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#29_glyph" class="md-nav__link">
    29 glyph
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12_glue" class="md-nav__link">
    12 glue
  </a>
  
    <nav class="md-nav" aria-label="12 glue">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    汉字字间胶
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13_kern" class="md-nav__link">
    13 kern
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14_penalty" class="md-nav__link">
    14 penalty
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_rule" class="md-nav__link">
    2 rule
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_insert" class="md-nav__link">
    3 insert
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_mark" class="md-nav__link">
    4 mark
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5_adjust" class="md-nav__link">
    5 adjust
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7_disc" class="md-nav__link">
    7 disc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#18_noad" class="md-nav__link">
    18 noad
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8_whatsit" class="md-nav__link">
    8 whatsit前端小玩意
  </a>
  
    <nav class="md-nav" aria-label="8 whatsit前端小玩意">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#user_defined" class="md-nav__link">
    user_defined
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6_boundary" class="md-nav__link">
    6 boundary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#10_dir" class="md-nav__link">
    10 dir
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#28_margin_kern" class="md-nav__link">
    28 margin_kern
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node" class="md-nav__link">
    node库
  </a>
  
    <nav class="md-nav" aria-label="node库">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    导语
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type" class="md-nav__link">
    type结点类型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fields" class="md-nav__link">
    fields结点字段
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#new" class="md-nav__link">
    new新建结点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#free" class="md-nav__link">
    free释放结点内存
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy" class="md-nav__link">
    copy拷贝结点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#next" class="md-nav__link">
    next前后结点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#current_attr" class="md-nav__link">
    current_attr当前属性结点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hpack" class="md-nav__link">
    hpack打横包
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vpack" class="md-nav__link">
    vpack打竖包
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    把行间距加入行中
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dimensions" class="md-nav__link">
    dimensions行尺寸
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    数学列表转行列表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tail" class="md-nav__link">
    tail尾结点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#slide" class="md-nav__link">
    slide滑到尾结点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#length" class="md-nav__link">
    length结点计数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    是不是字符、是不是字模
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traverse" class="md-nav__link">
    traverse迭代结点列表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traverse_id" class="md-nav__link">
    traverse_id
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traverse_char" class="md-nav__link">
    traverse_char
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traverse_list" class="md-nav__link">
    traverse_list
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    通过双向链接迭代
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#has_glyph" class="md-nav__link">
    has_glyph
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#first_glyph" class="md-nav__link">
    first_glyph
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#end_of_math" class="md-nav__link">
    end_of_math
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove" class="md-nav__link">
    remove
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insert_before_insert_after" class="md-nav__link">
    insert_before, insert_after
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ligaturing" class="md-nav__link">
    ligaturing应用合体字
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kerning" class="md-nav__link">
    kerning应用字间
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    字模与字符结点转换
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#last_node" class="md-nav__link">
    last_node
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write" class="md-nav__link">
    write
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    结点能否跳过
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setglue" class="md-nav__link">
    setglue注胶
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getglue" class="md-nav__link">
    getglue查看胶值
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#is_zero_glue" class="md-nav__link">
    is_zero_glue空值胶
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    结点的两种取用模式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    属性的处理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#property" class="md-nav__link">
    结点资产Property表
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tex" class="md-nav__link">
    TeX相关库
  </a>
  
    <nav class="md-nav" aria-label="TeX相关库">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tex_1" class="md-nav__link">
    tex库
  </a>
  
    <nav class="md-nav" aria-label="tex库">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    简介
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setget" class="md-nav__link">
    内部参数值的set、get
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    转换命令
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#last_item" class="md-nav__link">
    last item命令
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_get_and_is" class="md-nav__link">
    取用寄存器：set, get and is*
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#code_getsetcodes" class="md-nav__link">
    字符code寄存器: [get|set]*code[s]
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#box_getsetbox" class="md-nav__link">
    Box寄存器: [get|set]box
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#boxe_usesaveboxresource_and_getboxresourcedimensions" class="md-nav__link">
    重用boxe: [use|save]boxresource and getboxresourcedimensions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#triggerbuildpage" class="md-nav__link">
    triggerbuildpage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#splitbox" class="md-nav__link">
    splitbox
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing_math_parameters_getsetmath" class="md-nav__link">
    Accessing math parameters: [get|set]math
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#special_list_heads_getsetlist" class="md-nav__link">
    Special list heads: [get|set]list
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#semantic_nest_levels_getnest_and_ptr" class="md-nav__link">
    Semantic nest levels: getnest and ptr
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#print_functions" class="md-nav__link">
    Print functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    辅助函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions_for_dealing_with_primitives" class="md-nav__link">
    Functions for dealing with primitives
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    内核功能界面
  </a>
  
    <nav class="md-nav" aria-label="内核功能界面">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#badness" class="md-nav__link">
    badness
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#texresetparagraph" class="md-nav__link">
    tex.resetparagraph
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linebreak" class="md-nav__link">
    linebreak分行
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shipout" class="md-nav__link">
    shipout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getpagestate" class="md-nav__link">
    getpagestate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getlocallevel" class="md-nav__link">
    getlocallevel
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#randomizers" class="md-nav__link">
    Randomizers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions_related_to_synctex" class="md-nav__link">
    Functions related to synctex
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token" class="md-nav__link">
    token库
  </a>
  
    <nav class="md-nav" aria-label="token库">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    扫描器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token_1" class="md-nav__link">
    生成token
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    宏
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pdfwhatsit" class="md-nav__link">
    PDF后端物件（whatsit）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fonts" class="md-nav__link">
    Fonts 字体
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luatex_1" class="md-nav__link">
    luatex字体常识
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lua_1" class="md-nav__link">
    执行lua代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#directlua" class="md-nav__link">
    预先展开：\directlua代码执行机制
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#directluascan_tokstoken" class="md-nav__link">
    \directlua预处理（scan_toks()）中不展开的权标（token）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lua_2" class="md-nav__link">
    避免lua代码展开导致的问题
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#directluathetoks" class="md-nav__link">
    \directlua中的\the\toks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    其他展开技术
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lua_3" class="md-nav__link">
    Lua转义序列
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    以页面为单位的信息收集与统计
  </a>
  
    <nav class="md-nav" aria-label="以页面为单位的信息收集与统计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    不可能在主文件中精确引用页码计数器
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    标点压缩临时方案
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    速度问题
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tex_without_tex_revised_and_expanded" class="md-nav__link">
    TeX_without_TeX_revised_and_expanded
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luametatexlmtx" class="md-nav__link">
    LuaMetaTEX（LMTX）
  </a>
  
    <nav class="md-nav" aria-label="LuaMetaTEX（LMTX）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    引言
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    字体
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luafont" class="md-nav__link">
    Lua中的font库
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    朝向与旋转（竖排、直书）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    模块开发
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lua_in_context" class="md-nav__link">
    Lua in ConTeXt
  </a>
  
    <nav class="md-nav" aria-label="Lua in ConTeXt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    引言
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#context_interfacing" class="md-nav__link">
    ConTeXt文档中的代码执行界面 Interfacing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    引入外部代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    使用命名空间
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    库
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    输出文本
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#context_commands" class="md-nav__link">
    ConTeXt commands
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contextlua" class="md-nav__link">
    传递参数和缓存: ConTeXt命令给Lua提供的钩子
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    用例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    字符串操作
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    表格操作
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io" class="md-nav__link">
    IO
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contextluacontext" class="md-nav__link">
    在ConTeXt外部运行Lua（可使用ConTeXt环境）
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cld_context_lua_documents" class="md-nav__link">
    CLD: ConTeXt Lua Documents
  </a>
  
    <nav class="md-nav" aria-label="CLD: ConTeXt Lua Documents">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    执行方式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    常用函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    传递函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cld" class="md-nav__link">
    CLD双向传递变量
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    直接输出
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#catcodes" class="md-nav__link">
    特种码 Catcodes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    以函数而不是语句作为参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trial_typesetting" class="md-nav__link">
    试排 Trial typesetting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#steppers_luatex" class="md-nav__link">
    Steppers 从Lua临时进入TeX
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modes" class="md-nav__link">
    Modes 模式匹配
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token_2" class="md-nav__link">
    Token列表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node_1" class="md-nav__link">
    Node列表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    回调函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    页面布局与框架布局
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_45" class="md-nav__link">
    列表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_46" class="md-nav__link">
    表格
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_47" class="md-nav__link">
    放置图片
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_48" class="md-nav__link">
    风格
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forlorien" class="md-nav__link">
    ForLorien 打印数学题的完整例子
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interfacing_texunicode" class="md-nav__link">
    Interfacing TeX界面和Unicode的处理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#formatters" class="md-nav__link">
    Formatters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graphics" class="md-nav__link">
    Graphics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_49" class="md-nav__link">
    宏
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verbatim" class="md-nav__link">
    Verbatim 字符字面值
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    Logging
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lua_4" class="md-nav__link">
    Lua 函数
  </a>
  
    <nav class="md-nav" aria-label="Lua 函数">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#table" class="md-nav__link">
    table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#math" class="md-nav__link">
    math
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#boolean" class="md-nav__link">
    boolean
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#string" class="md-nav__link">
    string
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utf" class="md-nav__link">
    UTF
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#number" class="md-nav__link">
    number
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lpeg_patterns" class="md-nav__link">
    LPEG patterns 格式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io_1" class="md-nav__link">
    IO
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filedirurlos" class="md-nav__link">
    File、Dir、URL、OS
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lua_interface_code" class="md-nav__link">
    LUA 界面代码 interface code
  </a>
  
    <nav class="md-nav" aria-label="LUA 界面代码 interface code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_50" class="md-nav__link">
    字体
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nodes" class="md-nav__link">
    Nodes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resolversmathgrphmetapostluatextracing" class="md-nav__link">
    Resolvers、math、grph、MetaPost、LuaTEX、Tracing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scanners" class="md-nav__link">
    Scanners
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#print" class="md-nav__link">
    控制台print中文乱码的问题
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_51" class="md-nav__link">
    样例
  </a>
  
    <nav class="md-nav" aria-label="样例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hyphenation" class="md-nav__link">
    hyphenation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
  
                  
  

  <nav class="md-tags" >
    
      
      
        <a href="../tags/#cld" class="md-tag">CLD</a>
      
    
      
      
        <a href="../tags/#lmtx" class="md-tag">LMTX</a>
      
    
      
      
        <a href="../tags/#luatex" class="md-tag">LuaTeX</a>
      
    
  </nav>





  <h1>LuaTeX-LMTX-CLD学习笔记</h1>

<p><em>欢迎加入本人建的"LuaTeX ConTeXt 学习互助"群：431714622，互助学习LuaTeX ConTeXt LaTeX相关技术，以及通过Lua、Python实现格式化文本、数据的自动排版。</em></p>
<p><strong>注意：为了避免本博客的jinja引擎误解析，已经在<code>{</code>+<code>#</code>之间，以及对应的<code>}</code>之前加入空格</strong></p>
<hr />
<h2 id="vscode">vscode开发环境设置<a class="headerlink" href="#vscode" title="Permanent link">#</a></h2>
<h3 id="_1">编译配置<a class="headerlink" href="#_1" title="Permanent link">#</a></h3>
<p>使用wk-j的<code>Save and Run</code>插件运行脚本编译命令，例如：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nt">&quot;saveAndRun&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;commands&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;\\.lmtx$&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;isAsync&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;cmd&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;chcp 65001 &amp;&amp; context --autogenerate ${file}&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="c1">// &quot;cmd&quot;: &quot;chcp 65001 &amp;&amp; context ${file}&quot;,</span>
<span class="w">            </span><span class="nt">&quot;useShortcut&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;silent&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">},</span>
</code></pre></div></td></tr></table></div>
<h3 id="lua">Lua配置<a class="headerlink" href="#lua" title="Permanent link">#</a></h3>
<p>使用sumneko的<code>Lua</code>插件。配置<code>Lua.workspace.library</code>，添加库，比如(根据你的实际安装位置调整路径，没有实际测试哪些是必要的)：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">    </span><span class="nt">&quot;Lua.workspace.library&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;D:\\venvs\\context-win64\\&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">//整个安装路径，800多个文件，慢；以下也有700多个文件</span>
<span class="w">        </span><span class="c1">// &quot;D:\\venvs\\context-win64\\bin\\&quot;,</span>
<span class="w">        </span><span class="c1">// &quot;D:\\venvs\\context-win64\\tex\\texmf-context\\scripts\\context\\lua\\&quot;,</span>
<span class="w">        </span><span class="c1">// &quot;D:\\venvs\\context-win64\\tex\\texmf-context\\tex\\context\\base\\mkiv\\&quot;,</span>
<span class="w">        </span><span class="c1">// &quot;D:\\venvs\\context-win64\\tex\\texmf-context\\tex\\context\\base\\mkxl\\&quot;,</span>
<span class="w">        </span><span class="c1">// &quot;D:\\venvs\\context-win64\\tex\\texmf-context\\tex\\context\\interface\\mkiv\\&quot;,</span>
<span class="w">        </span><span class="c1">// &quot;D:\\venvs\\context-win64\\tex\\texmf-context\\tex\\context\\modules\\mkiv\\&quot;,</span>
<span class="w">        </span><span class="c1">// &quot;D:\\venvs\\context-win64\\tex\\texmf-context\\tex\\context\\patterns\\mkiv\\&quot;,</span>
<span class="w">        </span><span class="c1">// &quot;D:\\venvs\\context-win64\\tex\\texmf-context\\tex\\generic\\context\\luatex\\&quot;,</span>
<span class="w">        </span><span class="c1">// &quot;D:\\venvs\\context-win64\\tex\\texmf-win64\\bin\\&quot;,</span>
<span class="w">    </span><span class="p">],</span>
</code></pre></div></td></tr></table></div>
<h2 id="luatex">LuaTeX<a class="headerlink" href="#luatex" title="Permanent link">#</a></h2>
<p>本部分主要学习如下资料的笔记：</p>
<ul>
<li>官方手册<em>LuaTEX Reference Manual</em></li>
<li><a href="http://wiki.luatex.org/index.php/TeX_without_TeX">TeX without TeX - LuaTeXWiki</a></li>
<li><a href="https://www.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_1)%3A_What_is_it%E2%80%94and_what_makes_it_so_different%3F">An Introduction to LuaTeX (Part 1)</a></li>
<li><a href="https://www.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua">An Introduction to LuaTeX (Part 2)</a></li>
<li>教学项目<a href="https://github.com/alt/chickenize"><em>chickenize</em></a></li>
</ul>
<p>编译命令用：</p>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>lualatex<span class="w"> </span>test.tex
context<span class="w"> </span>--luatex<span class="w"> </span>test.mkiv
</code></pre></div></td></tr></table></div>
LuaTeX使用户可以从根基上控制TEX的行为，因此不只适用于学术排版、数学排版，而可作为任何排版系统的基础，比如数据排版<a href="https://www.speedata.de">speedata publisher</a>几乎纯用LuaTeX，又如结合ConTeXt使用。</p>
<p>LuaTeX起源pdfTeX，但并未使用pdfTeX的代码，也不会随之更新。</p>
<p>LuaTeX引擎支持两种编程语言：传统的基于TeX的语言，比如LaTeX(LuaLaTeX)宏包，还有Lua脚本语言。</p>
<p>TEX主要关心的是生成段落和页。段落生成器（par builder）把字符列表分行，构成box，行间用glue、penalty等分隔。页面生成器（page builder）累积行，在适当的时机输出。TEX并不构造实际的页面，而是使用能够操纵box的基元(primitive，低级命令)。结果再推给一个文件（通常是pdf）。</p>
<p>TEX引擎是一个黑盒，LuaTEX打开了这个黑盒，让用户可以通过Lua访问TEX引擎约的320个基元和隐藏的部分（LuaTEX新加基元）。<strong>在处理过程中的几乎所有合理的结点上，LuaTEX引擎把钩子提供给Lua；也就是说，你可以重载TEX自身的基本行为。</strong> 当我们说<a href="#TeX回调函数">“回调/回调函数”（callback）</a>的时候，说的就是这些钩子。</p>
<h3 id="_2"><a href="#lua结点表示">数据结构：结点和结点列表</a><a class="headerlink" href="#_2" title="Permanent link">#</a></h3>
<p><strong>node类型</strong></p>
<p>结点列表vlist/hlist, 字模glyph, 胶glue, 铅条/铅线rule, 罚分penalty, 小件whatsit, 字间kern，等等。<strong>结点列表是结点的一种类型，一种容器结点。</strong></p>
<p><strong>node list</strong></p>
<ul>
<li>垂直结点列表vlist，表示vbox、vtop、vcenter等垂直盒子中的内容</li>
<li>水平结点列表hlist，表示hbox等水平盒子中的内容</li>
<li>
<p>胶是表示弹性占位的特殊特殊盒子（或理解为弹簧）</p>
<ul>
<li>水平胶: hskip, parfillskip, 等</li>
<li>垂直胶: hskip,  baselineskip, 等</li>
</ul>
</li>
<li>
<p>结点列表包含</p>
<ul>
<li>盒子的元数据集合和</li>
<li>取用盒子中的对象的方法；</li>
</ul>
</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\hskip</span> &lt;natural width&gt; plus &lt;amount to stretch&gt; minus &lt;amount to shrink&gt;

<span class="k">\hbox</span> to100pt<span class="nb">{</span><span class="c">%</span>
A<span class="k">\hskip</span>4pt plus3pt minus 2pt B<span class="c">%</span>
<span class="k">\hskip</span> 0pt plus 2fil C<span class="c">%</span>
<span class="k">\hskip</span> 0pt plus 2fill D<span class="c">%</span>
<span class="k">\hskip</span> 0pt plus 3fill<span class="nb">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="box">box及其排版程序<a class="headerlink" href="#box" title="Permanent link">#</a></h3>
<ul>
<li>TEX box: \hbox, \vbox and \vtop<ul>
<li>\raise \lower （盒子的shift）在水平模式中调整盒子的垂直位置</li>
<li>\moveleft \moveright （盒子的shift）在垂直模式中调整盒子的水平位置</li>
<li>\hss，等于<code>\hskip 0pt plus 1fil minus 1fil</code>, 它会吸掉h盒子另一侧的所有宽度，无论正负。</li>
<li>\vss， 等于<code>\vskip 0cm plus 1fil minus 1fil</code></li>
<li>\strut \hsize</li>
</ul>
</li>
<li>对应的LuaTEX包裹器: \hpack, \vpack and \tpack，不会应用回调</li>
<li>LuaTEX相关的四个文本方向，LuaMetaTEX则是正反两个。<ul>
<li>\righttoleft \lefttoright；\textdirection（ConTeXt中无效）</li>
</ul>
</li>
</ul>
<p>盒子排版时LuaTEX的行为： </p>
<ol>
<li>构造结点列表。在LuaTEX中是双向链表，以便操控；但TEX本身只使用前向链接。</li>
<li>对结点列表进行断词(hyphenate)，即注入分割/断词结点(discretionary node)。这根据字模结点/字符结点的语言属性而定。</li>
<li>然后构造合字(ligature)，如果字体有这样复合字。当应用这个机制时，我们说的是ConTeXt基本模式(base mode)。</li>
<li>然后应用字间，如果字体提供的话。这也是基本模式的行为。</li>
<li>最后是盒子打包：<ul>
<li>对于水平盒子，列表被打包在hlist结点中，通常是一行，计算并设置好了尺寸。</li>
<li>对于垂直盒子，段落被分成行，没有断词，而有optimal断词，或者在糟糕的情况下应用所谓紧急拉伸(emergency stretch)，结果是一个设置好尺寸的vlist结点。</li>
</ul>
</li>
</ol>
<p>在传统TEX中，前四步交织在一起。但在LuaTEX中是分开的，因为第5步可以通过回调重载；在这种情况下，第3、4步（甚至第2步）也有可能重载，特别是在Lua中处理字体的时候。</p>
<h3 id="_3">结点表示<a class="headerlink" href="#_3" title="Permanent link">#</a></h3>
<p><code>node.types()</code>返回类型总表（括号中的数字是类型id）：</p>
<p>hlist (0), vlist (1), rule (2), ins (3), mark (4), adjust (5), boundary (6), disc (7), whatsit (8), par (9), dir (10), math (11), glue (12), kern(13), penalty (14), unset (15), style (16), choice (17), noad (18), radical (19), fraction (20), accent (21), fence (22), math_char (23), sub_box (24), sub_mlist (25), math_text_char (26), delim (27), margin_kern (28), glyph (29), align_record (30), pseudo_file (31), pseudo_line(32), page_insert (33), split_insert (34), expr_stack (35), nested_list (36), span (37), attribute (38), glue_spec (39), attribute_list (40), temp (41), align_stack (42), movement_stack (43), if_stack (44), unhyphenated (45), hyphenated (46), delta (47), passive (48), shape (49).</p>
<p>结点视觉化lua库：</p>
<p><a href="https://gist.github.com/pgundlach/556247">pgundlach/viznodelist.lua</a></p>
<h3 id="_4">主要文本结点<a class="headerlink" href="#_4" title="Permanent link">#</a></h3>
<p><em>开头的数字是类型id</em></p>
<h4 id="9_parlocal_par">9 par(local_par)<a class="headerlink" href="#9_parlocal_par" title="Permanent link">#</a></h4>
<p>段首插入的结点。一般不要改动。</p>
<table>
<thead>
<tr>
<th>FIELD</th>
<th>TYPE</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>attr</td>
<td>node</td>
<td>list of attributes</td>
</tr>
<tr>
<td>pen_inter</td>
<td>number</td>
<td>local interline penalty (from \localinterlinepenalty)</td>
</tr>
<tr>
<td>pen_broken</td>
<td>number</td>
<td>local broken penalty (from \localbrokenpenalty)</td>
</tr>
<tr>
<td>dir</td>
<td>string</td>
<td>the direction of this par. see 8.2.15</td>
</tr>
<tr>
<td>box_left</td>
<td>node</td>
<td>the \localleftbox</td>
</tr>
<tr>
<td>box_left_width</td>
<td>number</td>
<td>width of the \localleftbox</td>
</tr>
<tr>
<td>box_right</td>
<td>node</td>
<td>the \localrightbox</td>
</tr>
<tr>
<td>box_right_width</td>
<td>number</td>
<td>width of the \localrightbox</td>
</tr>
</tbody>
</table>
<h4 id="0_hlist">0 hlist<a class="headerlink" href="#0_hlist" title="Permanent link">#</a></h4>
<p>横向的行盒子。</p>
<table>
<thead>
<tr>
<th>FIELD</th>
<th>TYPE</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>subtype</td>
<td>number</td>
<td>0 = unknown, 1 = line, 2 = box, 3 = indent, 4 = alignment, 5 = cell,6 = equation, 7 = equationnumber, 8 = math, 9 = mathchar, 0 = hextensible, 11 = vextensible, 12 = hdelimiter, 13 = delimiter, 14 =overdelimiter, 15 = underdelimiter, 16 = numerator, 17 = enominator, 18 = limits, 19 = fraction, 20 = nucleus, 21 = sup, 2 = sub,23 = degree, 24 = scripts, 25 = over, 26 = under, 27 = ccent, 28 =radical</td>
</tr>
<tr>
<td>attr</td>
<td>node</td>
<td>属性结点</td>
</tr>
<tr>
<td>width</td>
<td>number</td>
<td>盒子的宽度</td>
</tr>
<tr>
<td>height</td>
<td>number</td>
<td>盒子的高度</td>
</tr>
<tr>
<td>depth</td>
<td>number</td>
<td>盒子的深度</td>
</tr>
<tr>
<td>shift</td>
<td>number</td>
<td>垂直于字符前进方向的位移（效果相当于\lower和\raise，对于vlist则相当于\moveleft和\moveright）</td>
</tr>
<tr>
<td>glue_order</td>
<td>number</td>
<td>数字范围[0, 4]，表示胶的序号（0即f，1即fi，2即fil...4即filll？？）</td>
</tr>
<tr>
<td>glue_set</td>
<td>number</td>
<td>胶的设定值：计算后的胶的比率</td>
</tr>
<tr>
<td>glue_sign</td>
<td>number</td>
<td>0 = 正常, 1 = 拉伸, 2 = 收缩</td>
</tr>
<tr>
<td>head/list</td>
<td>node</td>
<td>本列表的第一个结点（两个名字等效）</td>
</tr>
<tr>
<td>dir</td>
<td>string</td>
<td>盒子的方向，参看 8.2.15</td>
</tr>
</tbody>
</table>
<p><strong>LMTX：</strong>还可能有字段：attr, class, depth, direction, doffset, glueorder, glueset, gluesign, height, hoffset, list, orientation, shift, state, width, woffset, xoffset and yoffset。其中，orientation, woffset, hoffset, doffset, xoffset and yoffset用于后端旋转/设定朝向和偏置，比如在直排中。</p>
<h4 id="1_vlist">1 vlist<a class="headerlink" href="#1_vlist" title="Permanent link">#</a></h4>
<p>竖向的列盒子。
与hlist相似。小类只有0，4，5。</p>
<h4 id="29_glyph">29 glyph<a class="headerlink" href="#29_glyph" title="Permanent link">#</a></h4>
<p>字模结点，输入文本用。</p>
<table>
<thead>
<tr>
<th>FIELD</th>
<th>TYPE</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>subtype</td>
<td>number</td>
<td>0=character, 1=ligature, 2=ghost, 3=left, 4=right</td>
</tr>
<tr>
<td>attr</td>
<td>node</td>
<td>属性结点</td>
</tr>
<tr>
<td>char</td>
<td>number</td>
<td>字符在字体中的索引</td>
</tr>
<tr>
<td>font</td>
<td>number</td>
<td>字体标识</td>
</tr>
<tr>
<td>lang</td>
<td>number</td>
<td>语言标识</td>
</tr>
<tr>
<td>left</td>
<td>number</td>
<td>冻结的\lefthyphenmnin值</td>
</tr>
<tr>
<td>right</td>
<td>number</td>
<td>冻结的\righthyphenmnin值</td>
</tr>
<tr>
<td>uchyph</td>
<td>boolean</td>
<td>冻结的\uchyph值</td>
</tr>
<tr>
<td>components</td>
<td>node</td>
<td>指向带子/合体字（ligature）组件</td>
</tr>
<tr>
<td>xoffset</td>
<td>number</td>
<td>水平偏置</td>
</tr>
<tr>
<td>yoffset</td>
<td>number</td>
<td>垂直偏置</td>
</tr>
<tr>
<td>width</td>
<td>number</td>
<td>字符原始宽度(只读)</td>
</tr>
<tr>
<td>height</td>
<td>number</td>
<td>字符原始高度(只读)</td>
</tr>
<tr>
<td>depth</td>
<td>number</td>
<td>字符原始深度(只读)</td>
</tr>
<tr>
<td>expansion_factor</td>
<td>number</td>
<td>要应用的扩展系数（段落构造时生成，供后端使用）</td>
</tr>
<tr>
<td>data</td>
<td>number</td>
<td>给用户预留的通用数据空间</td>
</tr>
</tbody>
</table>
<p><code>is_char</code>函数用于检查结点是不是小类小于256的字符结点。
其变体<code>is_glyph</code>，不检查小类是不是小于256，返回字符值/nil和id。</p>
<p><code>uses_font</code>函数输入一个结点和字体id，如果字符结点或断行结点引用了字体，则返回true。</p>
<p>属性attr可以携带跨越不同处理阶段的信息，一般用作标记，以便在后面的处理过程中能够识别。<a href="http://wiki.luatex.org/index.php/Attributes">参考</a>。比如存储边注标记，然后通过post_linebreak_filter回调，在段落构造好后再构造边注。参考<a href="http://wiki.luatex.org/index.php/Post_linebreak_filter">Post_linebreak_filter</a></p>
<p>n.char也是unicode码点（codepoint）字符，可以通过unicode.utf8.char(n.char)取得字符。</p>
<p>跟结点有关的一些命令（基元）：</p>
<table>
<thead>
<tr>
<th>COMMAND</th>
<th>NODE</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>\hbox</td>
<td>hlist</td>
<td>水平盒子</td>
</tr>
<tr>
<td>\vbox</td>
<td>vlist</td>
<td>基线在底部的垂直盒子</td>
</tr>
<tr>
<td>\vtop</td>
<td>vlist</td>
<td>基线在顶部的垂直盒子</td>
</tr>
<tr>
<td>\hskip</td>
<td>glue</td>
<td>horizontal skip with optional stretch and shrink</td>
</tr>
<tr>
<td>\vskip</td>
<td>glue</td>
<td>vertical skip with optional stretch and shrink</td>
</tr>
<tr>
<td>\kern</td>
<td>kern</td>
<td>水平或垂直调整用的skip</td>
</tr>
<tr>
<td>\discretionary</td>
<td>disc</td>
<td>分割。断词点 (前结点/pre, 后结点/post,  替换结点/replace)</td>
</tr>
<tr>
<td>\char</td>
<td>glyph</td>
<td>a character</td>
</tr>
<tr>
<td>\hrule</td>
<td>rule</td>
<td>a horizontal rule</td>
</tr>
<tr>
<td>\vrule</td>
<td>rule</td>
<td>a vertical rule</td>
</tr>
<tr>
<td>\textdir(ection)</td>
<td>dir</td>
<td>a change in text direction</td>
</tr>
</tbody>
</table>
<p>打开所有基元命令：</p>
<p>\directlua { tex.enableprimitives('',tex.extraprimitives()) }</p>
<h4 id="12_glue">12 glue<a class="headerlink" href="#12_glue" title="Permanent link">#</a></h4>
<p>胶，表示空格。
在传统的TEX中，skip（即glue）是唯一的复合值数据对象。TEX看到文本流中的空格时会插入skip；也可以通过\hskip和\vskip插入。表示一个skip的glue组件的结构叫<code>glue_spec</code>，有如下字段：</p>
<table>
<thead>
<tr>
<th>FIELD</th>
<th>TYPE</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>width</td>
<td>number</td>
<td>水平或垂直占位</td>
</tr>
<tr>
<td>stretch</td>
<td>number</td>
<td>额外的占位，或伸展量</td>
</tr>
<tr>
<td>stretchorder</td>
<td>number</td>
<td>拉伸量的系数/倍数（0即f，1即fi，2即fil...4即filll ？？）</td>
</tr>
<tr>
<td>shrink</td>
<td>number</td>
<td>额外（负值）占位，或收缩量</td>
</tr>
<tr>
<td>shrinkorder</td>
<td>number</td>
<td>收缩量的系数/倍数</td>
</tr>
</tbody>
</table>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">local</span> <span class="n">parfillskip</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;glue&quot;</span><span class="p">,</span> <span class="s2">&quot;parfillskip&quot;</span><span class="p">)</span>
<span class="n">parfillskip</span><span class="p">.</span><span class="n">stretch</span> <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">16</span> <span class="c1">-- 拉伸量65536</span>
<span class="n">parfillskip</span><span class="p">.</span><span class="n">stretchorder</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1">--拉伸倍数fil?</span>

<span class="c1">-- 不再使用胶性</span>
<span class="c1">-- parfillskip.spec = node.new(&quot;gluespec&quot;)</span>
<span class="c1">-- parfillskip.spec.stretch = 2^16</span>
<span class="c1">-- parfillskip.spec.stretch_order = 2</span>
</code></pre></div></td></tr></table></div>
<p>glue_spec（胶性）结点在寄存器中存储一套胶值。</p>
<p>胶结点：</p>
<table>
<thead>
<tr>
<th>FIELD</th>
<th>TYPE</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>subtype</td>
<td>number</td>
<td>0 = userskip, 1 = lineskip, 2 = baselineskip, 3 = parskip, 4 = abovedisplayskip, 5 = belowdisplayskip, 6 = abovedisplayshortskip, 7 = belowdisplayshortskip, 8 = leftskip, 9 = rightskip, 10 = topskip, 11 = splittopskip, 12 = tabskip, 13 = spaceskip, 14 = xspaceskip, 15 = parfillskip, 16 = mathskip, 17 = thinmuskip, 18 = medmuskip, 19 = thickmuskip, 98 = conditionalmathskip, 99 = muglue, 100 = leaders, 101 = cleaders, 102 = xleaders, 103 = gleaders</td>
</tr>
<tr>
<td>attr</td>
<td>node</td>
<td>属性结点</td>
</tr>
<tr>
<td>leader</td>
<td>node</td>
<td>指向起头的盒子或条线</td>
</tr>
</tbody>
</table>
<p>还有字段： width, stretch stretchorder, shrink, and shrinkorder</p>
<p>水平胶和垂直胶都用width，这是TEX的传统。</p>
<p>通常的词语间空格也导致一个spaceskip小类（通常是0号的userskip）。</p>
<h5 id="_5">汉字字间胶<a class="headerlink" href="#_5" title="Permanent link">#</a></h5>
<p>系统会在汉字/中文间插入\hskip 0pt plus 0.5em，即</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">g</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;glue&quot;</span><span class="p">)</span>
<span class="n">g</span><span class="p">.</span><span class="n">width</span><span class="o">=</span><span class="mi">0</span>
<span class="n">g</span><span class="p">.</span><span class="n">stretch</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">font</span><span class="p">.</span><span class="n">fonts</span><span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="n">font</span><span class="p">].</span><span class="n">size</span>
</code></pre></div></td></tr></table></div>
<h4 id="13_kern">13 kern<a class="headerlink" href="#13_kern" title="Permanent link">#</a></h4>
<p>字间/出格，字模之间的相对偏置关系。
由\kern命令、字体机制、数学机制生成的结点。</p>
<table>
<thead>
<tr>
<th>FIELD</th>
<th>TYPE</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>subtype</td>
<td>number</td>
<td>0 = fontkern, 1 = userkern, 2 = accentkern, 3 = italiccorrection</td>
</tr>
<tr>
<td>attr</td>
<td>node</td>
<td>属性结点</td>
</tr>
<tr>
<td>kern</td>
<td>number</td>
<td>固定的水平或垂直提升量</td>
</tr>
</tbody>
</table>
<p>右端凸排，就是在右端字符（比如<code>》</code>）结点后增加<kern rightmarginkern>；同样，左凸排，就是在右端字符（比如<code>《</code>）结点前增加<kern leftmarginkern>。注意处理这个位置原有的kern。</p>
<p>另有margin_kern(？？？)</p>
<h4 id="14_penalty">14 penalty<a class="headerlink" href="#14_penalty" title="Permanent link">#</a></h4>
<p>罚分，控制断行的标记。
由\penalty、nodes.penalty()命令生成。</p>
<table>
<thead>
<tr>
<th>FIELD</th>
<th>TYPE</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>subtype</td>
<td>number</td>
<td>0 = userpenalty, 1 = linebreakpenalty, 2 = linepenalty, 3 = wordpenalty, 4 = finalpenalty, 5 = noadpenalty, 6 = beforedisplaypenalty, 7 = afterdisplaypenalty, 8 = equationnumberpenalty</td>
</tr>
<tr>
<td>attr</td>
<td>node</td>
<td>属性结点中</td>
</tr>
<tr>
<td>penalty</td>
<td>number</td>
<td>惩罚值</td>
</tr>
</tbody>
</table>
<p>小类是非正式的，TEX并不使用它们。当你碰到断行罚分（linebreakpenalty）时，你应该想到，它是club、widow（落单词）和其他相关惩罚的的累加。</p>
<p>罚分用来控制断行（比如某些标点前后），-10000以下表示必须断行，10000以上表示禁止断行，其余中间值表示由引擎决定。</p>
<h4 id="2_rule">2 rule<a class="headerlink" href="#2_rule" title="Permanent link">#</a></h4>
<p>参看<a href="../2022-06-22-ConTeXt-rule%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">ConTeXt-rule学习笔记</a></p>
<p>条线，铅条，铅线。
LuaTEX会使用条线来存储可重用对象和图像，所以比tex \hrule和\vrule的小类多；user小类结点不可见，可以通过回调截取。支持的 字段有：attr, char, data, depth, font, height, left, right, width, xoffset and yoffset.</p>
<table>
<thead>
<tr>
<th>FIELD</th>
<th>TYPE</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>subtype</td>
<td>number</td>
<td>0 = normal, 1 = box, 2 = image, 3 = empty, 4 = user, 5 = over, 6 = under, 7 = fraction, 8 = radical, 9 = outline</td>
</tr>
<tr>
<td>attr</td>
<td>node</td>
<td>属性结点</td>
</tr>
<tr>
<td>width</td>
<td>number</td>
<td>条线宽度，特殊值<code>−1073741824</code>用来处理胶的尺寸</td>
</tr>
<tr>
<td>height</td>
<td>number</td>
<td>条线高度 (可以是负值)</td>
</tr>
<tr>
<td>depth</td>
<td>number</td>
<td>条线深度 (可以是负值)</td>
</tr>
<tr>
<td>left</td>
<td>number</td>
<td>左端移位 (宽度会减除它)</td>
</tr>
<tr>
<td>right</td>
<td>number</td>
<td>右端移位 (宽度会减除它)</td>
</tr>
<tr>
<td>dir</td>
<td>string</td>
<td>条线方向，参看 8.2.15</td>
</tr>
<tr>
<td>index</td>
<td>number</td>
<td>可用来引用的可选索引</td>
</tr>
<tr>
<td>transform</td>
<td>number</td>
<td>私有值 (也用来指定轮廓宽度)</td>
</tr>
</tbody>
</table>
<h4 id="3_insert">3 insert<a class="headerlink" href="#3_insert" title="Permanent link">#</a></h4>
<p>浮动对象的插入标记。
与\insert基本命令相关。</p>
<table>
<thead>
<tr>
<th>FIELD</th>
<th>TYPE</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>subtype</td>
<td>number</td>
<td>插入（insertion）类</td>
</tr>
<tr>
<td>attr</td>
<td>node</td>
<td>属性结点</td>
</tr>
<tr>
<td>cost</td>
<td>number</td>
<td>与本插入关联的惩罚（penalty）</td>
</tr>
<tr>
<td>height</td>
<td>number</td>
<td>插入的及高度</td>
</tr>
<tr>
<td>depth</td>
<td>number</td>
<td>插入的深度</td>
</tr>
<tr>
<td>head/list</td>
<td>node</td>
<td>插入体的第一个结点</td>
</tr>
</tbody>
</table>
<p>还有与关联的胶有关的字段：width, stretch, stretch_order,
shrink and shrink_order. 都是数字。</p>
<h4 id="4_mark">4 mark<a class="headerlink" href="#4_mark" title="Permanent link">#</a></h4>
<p>文本标记。
与\mark基本命令相关联。</p>
<table>
<thead>
<tr>
<th>FIELD</th>
<th>TYPE</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>subtype</td>
<td>number</td>
<td>未使用</td>
</tr>
<tr>
<td>attr</td>
<td>node</td>
<td>属性结点</td>
</tr>
<tr>
<td>class</td>
<td>number</td>
<td>mark类</td>
</tr>
<tr>
<td>mark</td>
<td>table</td>
<td>表示token列表</td>
</tr>
</tbody>
</table>
<h4 id="5_adjust">5 adjust<a class="headerlink" href="#5_adjust" title="Permanent link">#</a></h4>
<p>垂直间距（两行之间）调整标记。
与\vadjust基本命令相关联。</p>
<table>
<thead>
<tr>
<th>FIELD</th>
<th>TYPE</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>subtype</td>
<td>number</td>
<td>0 = normal, 1 = pre</td>
</tr>
<tr>
<td>attr</td>
<td>node</td>
<td>属性结点</td>
</tr>
<tr>
<td>head/list</td>
<td>node</td>
<td>调整后的材料</td>
</tr>
</tbody>
</table>
<h4 id="7_disc">7 disc<a class="headerlink" href="#7_disc" title="Permanent link">#</a></h4>
<p>词中的分割结点。与<code>\discretionary</code> and <code>\-</code>基本命令相关, 即连字符<code>-</code>，断词机制也会生成这样的结点。</p>
<table>
<thead>
<tr>
<th>FIELD</th>
<th>TYPE</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>subtype</td>
<td>number</td>
<td>0 = discretionary, 1 = explicit, 2 = automatic, 3 = regular, 4 = first, 5 = second</td>
</tr>
<tr>
<td>attr</td>
<td>node</td>
<td>属性结点</td>
</tr>
<tr>
<td>pre</td>
<td>node</td>
<td>指向断词前的文本</td>
</tr>
<tr>
<td>post</td>
<td>node</td>
<td>指向断词后后文本</td>
</tr>
<tr>
<td>replace</td>
<td>node</td>
<td>指向不断词的文本</td>
</tr>
<tr>
<td>penalty</td>
<td>number</td>
<td>与断词相关联的惩罚，通常时 \hyphenpenalty 或 \exhyphenpenalty</td>
</tr>
</tbody>
</table>
<h4 id="18_noad">18 noad<a class="headerlink" href="#18_noad" title="Permanent link">#</a></h4>
<p>数学noad结点。</p>
<h4 id="8_whatsit">8 whatsit前端小玩意<a class="headerlink" href="#8_whatsit" title="Permanent link">#</a></h4>
<p>小玩意儿，小东西。一种简单的结点，只有一个小类。他甚至比用户结点（user node，实际上很可能是这样）结点还小，使用极少的内存。怎么使用他全由你定，他是极简的。你可以分配一个小类，它可以有一些属性。完全有用户控制。</p>
<p>node.whatsits查询小类:</p>
<p>open(0), write(1), close(2), special(3), save_pos(6), late_lua(7), user_defined(8), pdf_literal(16), pdf_refobj(17), pdf_annot(18), pdf_start_link(19), pdf_end_link(20), pdf_dest(21), pdf_action(22), pdf_thread(23), pdf_start_thread(24), pdf_end_thread(25), pdf_thread_data(26), pdf_link_data(27), pdf_colorstack(28), pdf_setmatrix(29), pdf_save(30), pdf_restore(31), pdf_link_state(32).</p>
<p>有些是通用的，有些与所选后端dvi或pdf相关。</p>
<h5 id="user_defined">user_defined<a class="headerlink" href="#user_defined" title="Permanent link">#</a></h5>
<p>User_defined类小玩意结点，是唯一可以从Lua code生成或操控的。实际上，它们是对扩展机制的一种扩展。LuaTEX引擎将简单地跨过这些小玩意，而不去看其内容。</p>
<table>
<thead>
<tr>
<th>FIELD</th>
<th>TYPE</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>attr</td>
<td>node</td>
<td>list of attributes</td>
</tr>
<tr>
<td>user_id</td>
<td>number</td>
<td>id number</td>
</tr>
<tr>
<td>type</td>
<td>number</td>
<td>type of the value</td>
</tr>
<tr>
<td>value</td>
<td>number</td>
<td>a Lua number</td>
</tr>
<tr>
<td></td>
<td>node</td>
<td>a node list</td>
</tr>
<tr>
<td></td>
<td>string</td>
<td>a Lua string</td>
</tr>
<tr>
<td></td>
<td>table</td>
<td>a Lua table</td>
</tr>
</tbody>
</table>
<p>type可选六个值。可用string.byte("l")代替108。</p>
<table>
<thead>
<tr>
<th>VALUE</th>
<th>MEANING</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>97</td>
<td>a</td>
<td>list of attributes (a node list)</td>
</tr>
<tr>
<td>100</td>
<td>d</td>
<td>a Lua number</td>
</tr>
<tr>
<td>108</td>
<td>l</td>
<td>a Lua value (table, number, boolean, etc)</td>
</tr>
<tr>
<td>110</td>
<td>n</td>
<td>a node list</td>
</tr>
<tr>
<td>115</td>
<td>s</td>
<td>a Lua string</td>
</tr>
<tr>
<td>116</td>
<td>t</td>
<td>a Lua token list in Lua table form (a list of triplets)</td>
</tr>
</tbody>
</table>
<p>108是魔法类型。实际值可以是任何lua type。</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code>    <span class="kd">local</span> <span class="n">w</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;whatsit&quot;</span><span class="p">,</span><span class="s2">&quot;user_defined&quot;</span><span class="p">)</span>
    <span class="n">node</span><span class="p">.</span><span class="n">setattribute</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">333</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">v</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">hasattribute</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">333</span><span class="p">)</span>
    <span class="n">w</span><span class="p">.</span><span class="n">type</span><span class="o">=</span><span class="mi">108</span>
    <span class="n">w</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;hello world&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">subtype</span><span class="p">,</span> <span class="n">w</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span><span class="n">w</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">w</span><span class="p">.</span><span class="n">value</span><span class="p">,</span><span class="n">w</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="c1">--有些不起效</span>
</code></pre></div></td></tr></table></div>
<h4 id="6_boundary">6 boundary<a class="headerlink" href="#6_boundary" title="Permanent link">#</a></h4>
<p>（单词、凸排的）边界结点。
相关的基本命令是：\noboundary, \boundary, \protrusionboundary and \wordboundary</p>
<table>
<thead>
<tr>
<th>FIELD</th>
<th>TYPE</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>subtype</td>
<td>number</td>
<td>0 = cancel, 1 = user, 2 = protrusion, 3 = word</td>
</tr>
<tr>
<td>attr</td>
<td>node</td>
<td>属性结点</td>
</tr>
<tr>
<td>value</td>
<td>number</td>
<td>values 0–255 are reserved</td>
</tr>
</tbody>
</table>
<h4 id="10_dir">10 dir<a class="headerlink" href="#10_dir" title="Permanent link">#</a></h4>
<p>方向结点，标记正在灌注、需要改变方向的文本的部分，由命令\textdir生成。</p>
<table>
<thead>
<tr>
<th>FIELD</th>
<th>TYPE</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>attr</td>
<td>node</td>
<td>list of attributes</td>
</tr>
<tr>
<td>dir</td>
<td>string</td>
<td>TLT, TRT, RTT, or LTL(3个字母依次表示段落、行、字符的起始方向)</td>
</tr>
<tr>
<td>level</td>
<td>number</td>
<td>nesting level of this direction whatsit</td>
</tr>
</tbody>
</table>
<h4 id="28_margin_kern">28 margin_kern<a class="headerlink" href="#28_margin_kern" title="Permanent link">#</a></h4>
<p>边缘字间，是由突出（protrusion）引起的。</p>
<table>
<thead>
<tr>
<th>FIELD</th>
<th>TYPE</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>subtype</td>
<td>number</td>
<td>0 = left, 1 = right</td>
</tr>
<tr>
<td>attr</td>
<td>node</td>
<td>list of attributes</td>
</tr>
<tr>
<td>width</td>
<td>number</td>
<td>the advance of the kern</td>
</tr>
<tr>
<td>glyph</td>
<td>node</td>
<td>the glyph to be used</td>
</tr>
</tbody>
</table>
<h3 id="node">node库<a class="headerlink" href="#node" title="Permanent link">#</a></h3>
<p><strong>等于<code>nodes.nuts</code>???</strong></p>
<p><em>luatex手册</em> 8.7</p>
<h4 id="_6">导语<a class="headerlink" href="#_6" title="Permanent link">#</a></h4>
<p>结点库中包含一些处理结点和结点列表的便利工具，可用于创建、更换、拷贝、删除和插入luatex结点对象——排版器（typesetter）的核心对象。</p>
<p>在lua中，结点表示为<code>luatex.node</code>元数据类型的用户数据。</p>
<p>所有结点都有以下三个字段，其余字段则根据类型（whatsits根据小类）而定：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
    <span class="nb">next</span><span class="p">:...,</span>  <span class="c1">-- 下一个结点</span>
    <span class="n">id</span><span class="p">:...,</span>  <span class="c1">-- node type(数值，有些库函数可以接受字符串)</span>
    <span class="n">subtype</span><span class="p">:...,</span> <span class="c1">--小类（数值），比如用于区分whatsits(小玩意儿)</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>两个结点的比较，只是比较索引值，即使已经释放，仍被看作相同。</p>
<p>结点相关回调的一般方法：</p>
<ul>
<li>假设结点列表没有问题，双向链接正确（应用node.slide可修复）。</li>
<li><strong>插入结点时，确保你插入的解读是先前移除的一个，或是一个新的，或一个拷贝（深拷贝）。不要把一个结点插入两次。</strong></li>
<li><strong>如果永久移除一个结点，请确保也释放结点或列表。</strong></li>
<li>虽然你可以欺骗系统，但通常情况下，当你试图复制一个不存在的结点，或释放一个已经释放的结点时，你会触发一个错误。这种检查涉及一些开销，但目前的折中方案是可以接受的。</li>
<li>当你完成（回调）后，传回结果（如果需要）。你有责任确保列表有正确链接（为安全起见，可以再次应用node.slide）。原则上，在后续动作中不被接受的结点你也可以放在列表中。有些结点会被忽略，有些会触发错误，有时引擎会直接崩溃。</li>
</ul>
<p>从以上可以明确，<strong>结点的内存管理必须由用户显式操作。lua垃圾回收器看不到结点，对于不在使用的结点和列表，用户必须自行调用结点释放函数。结点在列表（结点双向链表）中不能被引用两次。</strong>一般情况下通过getter和setter来处理。</p>
<p>有关于已分配的结点内存的统计数据，这对追踪很方便。通常情况下，使用的结点数量并不多。一个页面的排版可能涉及到成千上万的结点，但大多数在页面被运出后就被释放了。与其他程序相比，结点的内存使用量并不是很高。因此，如果由于某种原因，你的应用程序（内存）泄漏了结点，如果在运行结束时，你失去了几百个结点，那也不是什么大问题。事实上，<strong>如果你创建了盒子，并制作了副本，但却没有很好地清除它们，你的运行结束时肯定会带着用过的结点，统计数据会提到这点。对于attribute和skips（胶性结点）来说也是如此，请保持当前状态只涉及正在使用的结点。</strong></p>
<h4 id="type">type结点类型<a class="headerlink" href="#type" title="Permanent link">#</a></h4>
<ul>
<li><table> t = node.types() --大类id:string的映射表（查表用node.type()）</li>
<li><string> type = node.type(<any> n) -- 类型id查类型名称；结点转字符串结点(string node)</li>
<li><number> id = node.id(<string> type) --类型名称查类型id</li>
<li><number> subtype = node.subtype(<string> type) -- 小类名称查id</li>
<li><table> t = node.whatsits()  --whatsits小类id:string的映射表</li>
<li><boolean|integer> t = node.is_node(<any> item) --结点索引</li>
</ul>
<h4 id="fields">fields结点字段<a class="headerlink" href="#fields" title="Permanent link">#</a></h4>
<ul>
<li><table> t = node.fields(<number> id) --查某类型的有效字段，也接受名称</li>
<li><table> t = node.fields(<number> id, <number> subtype) --查某小类的有效字段，也接受名称</li>
<li><boolean> t = node.has_field(<node> n, <string> field) --判断字段有无</li>
</ul>
<p>打印结点n的字段值：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="kr">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">fields</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">id</span><span class="p">))</span> <span class="kr">do</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">n</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>
<h4 id="new">new新建结点<a class="headerlink" href="#new" title="Permanent link">#</a></h4>
<ul>
<li><node> n =node.new(<number> id)</li>
<li><node> n =node.new(<number> id, <number> subtype) --小东西</li>
</ul>
<p>也可以接收字符串名称。字段被初始化为nil或0。</p>
<p>请确保这样生成的结点只使用一次；如果不以某种方式回传，则要释放（free）掉。</p>
<p>设置字体：n.font = fnt，
设置字符：n.char = chr</p>
<h4 id="free">free释放结点内存<a class="headerlink" href="#free" title="Permanent link">#</a></h4>
<ul>
<li><node> next =node.free(<node> n) -- 释放结点内存，返回后继结点</li>
<li>flushnode(<node> n) -- 释放结点内存，不返回后继结点</li>
<li>node.flushlist(<node> n) --直接冲洗结点n开头的整个列表</li>
</ul>
<p>请确保没有寄存器、next字段等指向要释放、冲洗的结点、列表，以及列表中的所有元素。</p>
<h4 id="copy">copy拷贝结点<a class="headerlink" href="#copy" title="Permanent link">#</a></h4>
<ul>
<li><node> m =node.copy(<node> n) --不会拷贝next字段</li>
<li><node> m =node.copy_list(<node> n)  --不会拷贝属性结点（通常也没有必要）</li>
<li><node> m =node.copy_list(<node> n, <node> m) --指定区间</li>
</ul>
<h4 id="next">next前后结点<a class="headerlink" href="#next" title="Permanent link">#</a></h4>
<ul>
<li><node> m =node.next(<node> n)</li>
<li><node> m =node.prev(<node> n)</li>
</ul>
<h4 id="current_attr">current_attr当前属性结点<a class="headerlink" href="#current_attr" title="Permanent link">#</a></h4>
<ul>
<li><node> m =node.current_attr()</li>
</ul>
<p>返回前激活的实际属性结点的引用，也就是说，其后可能会改变（比如通过tex.setattribute）。</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">local</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;glyph&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;glyph&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">current_attr</span><span class="p">()</span>
<span class="n">x1</span><span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">ca</span>
<span class="n">x2</span><span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">ca</span>
</code></pre></div></td></tr></table></div>
<h4 id="hpack">hpack打横包<a class="headerlink" href="#hpack" title="Permanent link">#</a></h4>
<p>这个函数通过把从结点n开始的列表打包成一个水平的盒子来创建一个新的hlist。只有一个参数时，用其组件的自然宽度创建盒子。在三个参数的形式中，info必须是扩充的或精确的，而w是要使用扩充的（\hbox spread）或精确的（\hbox to）宽度。第二个返回值是生成的盒子的坏度（badness）。</p>
<ul>
<li><node> h, <number> b =node.hpack(<node> n) --使用元素的自然宽度，返回b是新结点的badness</li>
<li><node> h, <number> b =node.hpack(<node> n, <number> w, <string> info) --info: 'additional'|'exactly',w: the additional
(\hbox spread) or exact (\hbox to) width to be used</li>
<li><node> h, <number> b =node.hpack(<node> n, <number> w, <string> info, <string> dir)</li>
</ul>
<p>注意：这个函数可能会有意想不到的副作用，比如更新一些 \marks 和 \inserts。还要注意的是，h的内容是原来的结点列表n：如果你调用node.free(h)，你也会释放结点列表本身，除非你事先明确地将list字段设置为nil。而且，以类似的方式，调用node.free(n)也会使h失效！</p>
<p>通常使用node.hpack把列表装入盒子中，这样会正常设置（一些自然属性）：</p>
<p>local box, _ = node.hpack(list,0,"exactly")</p>
<p>如果直接把列表绑定到盒子的列表头，则需要自行设置，比如施胶：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">local</span> <span class="n">box</span> <span class="o">=</span> <span class="n">node_new</span><span class="p">(</span><span class="n">hlist_id</span><span class="p">,</span> <span class="s2">&quot;box&quot;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">list</span>
<span class="n">box</span><span class="p">.</span><span class="n">glueorder</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">box</span><span class="p">.</span><span class="n">glueset</span> <span class="o">=</span> <span class="mf">6.6683349609375</span>
<span class="n">box</span><span class="p">.</span><span class="n">gluesign</span> <span class="o">=</span> <span class="mi">2</span>
</code></pre></div></td></tr></table></div>
<h4 id="vpack">vpack打竖包<a class="headerlink" href="#vpack" title="Permanent link">#</a></h4>
<ul>
<li><node> h, <number> b =node.vpack(<node> n)</li>
<li><node> h, <number> b =node.vpack(<node> n, <number> w, <string> info)</li>
<li><node> h, <number> b =node.vpack(<node> n, <number> w, <string> info, <string> dir)</li>
</ul>
<h4 id="_7">把行间距加入行中<a class="headerlink" href="#_7" title="Permanent link">#</a></h4>
<p>这是一个实验性的辅助工具，在考虑到基线和行距的情况下，将行距添加到行中。</p>
<ul>
<li><node> n, <number> delta =node.prepend_prevdepth(<node> n,<number> prevdepth)</li>
</ul>
<h4 id="dimensions">dimensions行尺寸<a class="headerlink" href="#dimensions" title="Permanent link">#</a></h4>
<p>以结点n开头的行，从头到尾（或到结点t之前）的、经过缩放后的点数（pt，浮点数）。</p>
<ul>
<li><number> w, <number> h, <number> d=node.dimensions(<node> n)</li>
<li><number> w, <number> h, <number> d=node.dimensions(<node> n, <string> dir)</li>
<li><number> w, <number> h, <number> d=node.dimensions(<node> n, <node> t)</li>
<li><number> w, <number> h, <number> d=node.dimensions(<node> n, <node> t, <string> dir)</li>
</ul>
<p>或增加胶参数：</p>
<ul>
<li><number> w, <number> h, <number> d=node.dimensions(<number> glue_set, <number> glue_sign, <number> glue_order,<node> n)</li>
<li><number> w, <number> h, <number> d=node.dimensions(<number> glue_set, <number> glue_sign, <number> glue_order,<node> n, <string> dir)</li>
<li><number> w, <number> h, <number> d=node.dimensions(<number> glue_set, <number> glue_sign, <number> glue_order,<node> n, <node> t)</li>
<li><number> w, <number> h, <number> d=node.dimensions(<number> glue_set, <number> glue_sign, <number> glue_order,<node> n, <node> t, <string> dir)</li>
</ul>
<p>以上考虑了加胶的情况，特别适用于获取加过盒子的结点子列表的实际宽度，比如：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\setbox</span>0 = <span class="k">\hbox</span> to 20pt <span class="nb">{</span>a b<span class="nb">}</span>
<span class="k">\directlua</span><span class="nb">{</span>print (node.dimensions(
    tex.box[0].glue<span class="nb">_</span>set,
    tex.box[0].glue<span class="nb">_</span>sign,
    tex.box[0].glue<span class="nb">_</span>order,
    tex.box[0].head,
    node.tail(tex.box[0].head)
)) <span class="nb">}</span>
</code></pre></div></td></tr></table></div>
<p>请记住，<strong>这是TEX中少数几个使用浮点数的地方之一</strong>，这意味着当你将hpack报告的宽度与尺寸进行比较时，你会得到四舍五入的微小差异。</p>
<p><strong>请注意：</strong>node.dimensions、n.width测量的实际上是测量范围内所有元素的标记宽度，而不是视觉看到的实际宽度。也就是说，如果有禁则导致的glue correctionskip（负值，表示刨除不得不附加在盒子边界外的字符宽度）等，算上它们，只是盒子宽度；刨除它们（只计算到最后一个字模）才是视觉宽度，才可以探测overfull。</p>
<p>清除行末负值干扰后，node.dimensions与重新hpack后得到的n.width一致；<strong>但此宽度不可用于调整旧行宽度，与视觉宽度不一致，而应记录清除的宽度总数，然后从旧行n.width中扣减。 TODO 有待进一步学习其原理！！!</strong></p>
<p>另有便利的查询(在LMTX中为：node.direct.rangedimensions)：</p>
<ul>
<li><number> w, <number> h, <number> d=node.rangedimensions(<node> parent, <node> first)</li>
<li><number> w, <number> h, <number> d=node.rangedimensions(<node> parent, <node> first, <node> last)</li>
</ul>
<h4 id="_8">数学列表转行列表<a class="headerlink" href="#_8" title="Permanent link">#</a></h4>
<p><node> h =node.mlist_to_hlist(<node> n, <string> display_type, <boolean> penalties)</p>
<p>跟回调函数<code>mlist_to_hlist</code>一样。</p>
<h4 id="tail">tail尾结点<a class="headerlink" href="#tail" title="Permanent link">#</a></h4>
<p>返回结点n开头的结点列表的最后一个结点。</p>
<p><node> m =node.tail(<node> n)</p>
<h4 id="slide">slide滑到尾结点<a class="headerlink" href="#slide" title="Permanent link">#</a></h4>
<p>返回结点n开头的结点列表的最后一个结点。同时会在结点之间生成前导各点的反向链条。</p>
<p><node> m =node.slide(<node> n)</p>
<h4 id="length">length结点计数<a class="headerlink" href="#length" title="Permanent link">#</a></h4>
<p>以结点n开头的结点列表的计数。</p>
<ul>
<li><number> i =node.length(<node> n)</li>
<li><number> i =node.length(<node> n, <node> m) --终止结点m不计算在内</li>
</ul>
<p>匹配类型id（字符串名称也可以）的版本：</p>
<ul>
<li><number> i =node.count(<number> id, <node> n)</li>
<li><number> i =node.count(<number> id, <node> n, <node> m)</li>
</ul>
<h4 id="_9">是不是字符、是不是字模<a class="headerlink" href="#_9" title="Permanent link">#</a></h4>
<p>字模结点的子类型预示着该字模是否已经变成了一个字符引用（character reference）。</p>
<ul>
<li><boolean> b =node.is_char(<node> n)</li>
<li><boolean> b =node.is_glyph(<node> n) # node.direct.is_glyph()</li>
</ul>
<p>似乎与手动检查id不同。</p>
<h4 id="traverse">traverse迭代结点列表<a class="headerlink" href="#traverse" title="Permanent link">#</a></h4>
<ul>
<li><node> t, id, subtype =node.traverse(<node> n)</li>
</ul>
<p>迭代从结点n开始的结点列表。</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">-- 典型用法</span>
<span class="kr">for</span> <span class="n">n</span> <span class="kr">in</span> <span class="n">node</span><span class="p">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">head</span><span class="p">)</span> <span class="kr">do</span>
    <span class="p">...</span>
<span class="kr">end</span>

<span class="c1">-- 等价于</span>
<span class="kr">do</span>
    <span class="kd">local</span> <span class="n">n</span>
    <span class="kd">local</span> <span class="kr">function</span> <span class="nf">f</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span><span class="n">var</span><span class="p">)</span>
        <span class="kd">local</span> <span class="n">t</span>
        <span class="kr">if</span> <span class="n">var</span> <span class="o">==</span> <span class="kc">nil</span> <span class="kr">then</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">head</span>
        <span class="kr">else</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">var</span><span class="p">.</span><span class="n">next</span>
        <span class="kr">end</span>
        <span class="kr">return</span> <span class="n">t</span>
    <span class="kr">end</span>
    <span class="kr">while</span> <span class="kc">true</span> <span class="kr">do</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">f</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="kr">if</span> <span class="n">n</span> <span class="o">==</span> <span class="kc">nil</span> <span class="kr">then</span> <span class="kr">break</span> <span class="kr">end</span>
        <span class="p">...</span>
    <span class="kr">end</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>
<h4 id="traverse_id">traverse_id<a class="headerlink" href="#traverse_id" title="Permanent link">#</a></h4>
<p>迭代结点列表中特定id的结点。</p>
<ul>
<li><node> t, subtype =node.traverse_id(<number> id, <node> n)</li>
</ul>
<p>即在node.traverse()基础上加入类型检查逻辑：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">...</span>
<span class="kr">while</span> <span class="ow">not</span> <span class="n">t</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span> <span class="kr">do</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">next</span>
<span class="kr">end</span>
<span class="p">...</span>
</code></pre></div></td></tr></table></div>
<h4 id="traverse_char">traverse_char<a class="headerlink" href="#traverse_char" title="Permanent link">#</a></h4>
<p>迭代结点列表中的字模结点。</p>
<p>字模结点（glyph nodes）：小类（subtype）小于256的结点。</p>
<p><node> n, font, char =node.traverse_char(<node> n)</p>
<p>返回列表，过滤所有字模(glyph)【？？？】：</p>
<p><node> n, font, char =node.traverse_glyph(<node> n)</p>
<h4 id="traverse_list">traverse_list<a class="headerlink" href="#traverse_list" title="Permanent link">#</a></h4>
<p>迭代列表中的hlist结点和vlist结点。</p>
<p><node> n, id, subtype, list =node.traverse_list(<node> n)</p>
<h4 id="_10">通过双向链接迭代<a class="headerlink" href="#_10" title="Permanent link">#</a></h4>
<p>Hans Hagen：不要在traverse中删除结点，以免造成内部的n.nex指向混乱，这样手动遍历：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">local</span> <span class="n">n</span> <span class="o">=</span> <span class="n">head</span>
<span class="kr">while</span> <span class="n">n</span> <span class="kr">do</span>
   <span class="p">...</span>
   <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">.</span><span class="n">next</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>
<h4 id="has_glyph">has_glyph<a class="headerlink" href="#has_glyph" title="Permanent link">#</a></h4>
<p>列表中的第一个字模或分割（disc）结点。</p>
<p><node> n =node.has_glyph(<node> n)</p>
<p>disc是加入连字符的点。</p>
<h4 id="first_glyph">first_glyph<a class="headerlink" href="#first_glyph" title="Permanent link">#</a></h4>
<p>返回列表的第一个字模结点。</p>
<p>字模结点：subtype为glyph的结点。</p>
<ul>
<li><node> n =node.first_glyph(<node> n)</li>
<li><node> n =node.first_glyph(<node> n, <node> m) --包含终点</li>
</ul>
<h4 id="end_of_math">end_of_math<a class="headerlink" href="#end_of_math" title="Permanent link">#</a></h4>
<p>下一个数学结点。</p>
<p><node> t =node.end_of_math(<node> start)</p>
<p>可能是起点。</p>
<h4 id="remove">remove<a class="headerlink" href="#remove" title="Permanent link">#</a></h4>
<p>从列表中移除当前结点。</p>
<p><node> head, current =node.remove(<node> head, <node> current)</p>
<p>得自行确定是不是列表的一部分。返回新的head和当前结点(或nil)。</p>
<p>不要在遍历（traverse）中删除结点，会搞乱n.next的指向。参考上面traverse部分。</p>
<h4 id="insert_before_insert_after">insert_before, insert_after<a class="headerlink" href="#insert_before_insert_after" title="Permanent link">#</a></h4>
<p>在结点前、后插入结点。</p>
<p><node> head, new =node.insert_before(<node> head, <node> current, <node> new)
<node> head, new =node.insert_after(<node> head, <node> current, <node> new)</p>
<p>head可以是nil。返回新的head。</p>
<p><strong>删除和插入节点时，列表头始终应该更新为返回的新列表头。除非你确定列表头不可能变动！！！</strong></p>
<h4 id="ligaturing">ligaturing应用合体字<a class="headerlink" href="#ligaturing" title="Permanent link">#</a></h4>
<ul>
<li><node> h, <node> t, <boolean> success =node.ligaturing(<node> n)</li>
<li><node> h, <node> t, <boolean> success =node.ligaturing(<node> n, <node> m)</li>
</ul>
<p>对指定结点列表应用TEX风格的合体字功能。h，新头；t，新尾。</p>
<h4 id="kerning">kerning应用字间<a class="headerlink" href="#kerning" title="Permanent link">#</a></h4>
<ul>
<li><node> h, <node> t, <boolean> success =node.kerning(<node> n)</li>
<li><node> h, <node> t, <boolean> success =node.kerning(<node> n, <node> m)</li>
</ul>
<p>对指定结点列表应用TEX风格的字距调整功能。h，新头；t，新尾（可能插入了kern node，词语边界可能有特殊的kerning）。</p>
<h4 id="_11">字模与字符结点转换<a class="headerlink" href="#_11" title="Permanent link">#</a></h4>
<ul>
<li>node.unprotect_glyph(<node> n)</li>
<li>node.unprotect_glyphs(<node> n,[<node> n]) -- 指定终点</li>
</ul>
<p>把所有字符结点的小类值减去256。在结点处理过程中把字符转换成字模（包含字形设计信息）。</p>
<ul>
<li>node.protect_glyph(<node> n)</li>
<li>node.protect_glyphs(<node> n,[<node> n])</li>
</ul>
<p>把所有字符结点的小类值加上256（如果值是1则只加255）。</p>
<h4 id="last_node">last_node<a class="headerlink" href="#last_node" title="Permanent link">#</a></h4>
<p>弹出当前列表最后一个结点。</p>
<p><node> n =node.last_node()</p>
<h4 id="write">write<a class="headerlink" href="#write" title="Permanent link">#</a></h4>
<p>在当前列表最后写入一个结点。</p>
<p>node.write(<node> n)</p>
<p>你应该保证当前是水平模式。</p>
<h4 id="_12">结点能否跳过<a class="headerlink" href="#_12" title="Permanent link">#</a></h4>
<p><boolean> skippable =node.protrusion_skippable(<node> n)</p>
<p>为了在字符突出（character protrusion）开启时发现行边界，可能用到此功能。</p>
<h4 id="setglue">setglue注胶<a class="headerlink" href="#setglue" title="Permanent link">#</a></h4>
<ul>
<li>node.setglue(<node> n)</li>
<li>node.setglue(<node> n,width,stretch,shrink,stretch_order,shrink_order)<ul>
<li>node.setglue(n,655360,false,65536)，只调整 width and shrink.</li>
</ul>
</li>
</ul>
<p>非数值等于0，即重置属性。</p>
<h4 id="getglue">getglue查看胶值<a class="headerlink" href="#getglue" title="Permanent link">#</a></h4>
<p><integer> width, <integer> stretch, <integer> shrink, <integer> stretch_order,<integer> shrink_order = node.getglue(<node> n)</p>
<h4 id="is_zero_glue">is_zero_glue空值胶<a class="headerlink" href="#is_zero_glue" title="Permanent link">#</a></h4>
<p><boolean> isglue =node.is_zero_glue(<node> n)</p>
<h4 id="_13">结点的两种取用模式<a class="headerlink" href="#_13" title="Permanent link">#</a></h4>
<p>变量引用（直接模式）和整数索引的互换：</p>
<ul>
<li><integer> d = node.todirect(<node> n))</li>
<li><node> n = node.tonode(<integer> d))</li>
</ul>
<p>直接模式使用键值操作属性：<code>nodeobject.char</code>。整数索引模式使用get... set... 方法，速度更快：<code>getfield(nodenumber,"char")</code></p>
<p>常用取用器（设置器是配套的）：</p>
<ul>
<li>getnext</li>
<li>getprev</li>
<li>getboth</li>
<li>getid</li>
<li>getsubtype</li>
<li>getfont</li>
<li>getchar</li>
<li>getwhd</li>
<li>getdisc</li>
<li>getlist</li>
<li>getleader</li>
<li>getfield</li>
<li>getbox</li>
<li>getoffsets</li>
</ul>
<p>界面<code>node.direct</code>中还有更多辅助工具。</p>
<h4 id="_14">属性的处理<a class="headerlink" href="#_14" title="Permanent link">#</a></h4>
<p><em>ltmx</em></p>
<p><strong>属性是将额外的信息与节点联系起来的一种方便方式。</strong>你可以在TEX端和Lua端给它们赋值，并在Lua端查阅它们。<strong>一个很大的优点是它们服从分组。它们是链接在一起的列表，通常对它们的检查是相当有效的，即使它们的用量很大。一个宏包必须在TEX端提供一些方法来管理这些属性，否则可能会发生冲突。</strong>类似的，还可以使用资产表。</p>
<p>对属性寄存器的赋值，会导致给结点设置过属性的列表赋值；这个应用很重要，因为附加到结点上的值基本上是一个（排序的）键值对散列数组。一般来说，通过使用node库中的专用函数来处理属性列表和属性是最容易的。</p>
<p>当前激活的属性列表：</p>
<p><node> m = node.currentattr()</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">local</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;glyph&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;glyph&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">currentattr</span><span class="p">()</span>
<span class="n">x1</span><span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">ca</span>
<span class="n">x2</span><span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">ca</span>
</code></pre></div></td></tr></table></div>
<ul>
<li><number> v = node.hasattribute(<node> n, <number> id)</li>
<li>
<p><number> v = node.hasattribute(<node> n, <number> id, <number> val)</p>
</li>
<li>
<p><number> v = node.getattribute(<node> n, <number> id)</p>
</li>
</ul>
<p>找到第一个有某属性的列表：</p>
<ul>
<li>
<p><number> v, <node> n = node.findattribute(<node> n, <number> id)</p>
</li>
<li>
<p>node.setattribute(<node> n, <number> id, <number> val)</p>
</li>
<li>
<p><number> v = node.unsetattribute(<node> n, <number> id)</p>
</li>
<li><number> v = node.unsetattribute(<node> n, <number> id, <number> val)</li>
</ul>
<p><a href="http://wiki.luatex.org/index.php/Attributes">以下参考</a></p>
<p>Attribute寄存器遵循计数器的规则，可以通过\the等命令来使用。</p>
<p>定义：</p>
<ul>
<li>\attribute ⟨16-bit number⟩ ⟨optional equals⟩ ⟨32-bit number⟩</li>
<li>\attributedef ⟨csname⟩ ⟨optional equals⟩ ⟨16-bit number⟩</li>
</ul>
<p>-"7FFFFFFF −2147483647 表示unset。</p>
<p>相同scope中生成的结点通过链接持有相同的Attribute键和值，这使得它很方便用于扩展。</p>
<p>使用结点Attributes给TeX和Lua传递信息，遵循分组规则，大量使用仍然相当高效。</p>
<p>\attributedef\myattribute=333
\myattribute=1</p>
<p>tex.getattribute(<register>)
tex.setattribute(["global",] <register>, <number>)</p>
<p>\attribute0=1
\setbox0=\hbox attr 2 = 3 {contents}</p>
<p>这个盒子（结点）及其内容的每个结点，具有attribute 0，值为1；但只有盒子结点具有attribute 2，值3。它的内容具有当前分配给该属性的任何值（很可能该属性未被设置）。</p>
<p>attr关键字应该在to和spread之前。</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">-- 给盒子设置资产表，携带字符char(效率较低，但可以使用复杂数据，比如表)</span>
<span class="kd">local</span> <span class="n">n_char</span> <span class="o">=</span> <span class="n">n</span><span class="p">.</span><span class="n">char</span>
<span class="kd">local</span> <span class="n">p</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">getproperty</span><span class="p">(</span><span class="n">hlist</span><span class="p">)</span>
<span class="kr">if</span> <span class="ow">not</span> <span class="n">p</span> <span class="kr">then</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">node</span><span class="p">.</span><span class="n">setproperty</span><span class="p">(</span><span class="n">hlist</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<span class="kr">end</span>
<span class="n">p</span><span class="p">.</span><span class="n">char</span> <span class="o">=</span> <span class="n">n_char</span>

<span class="c1">--给盒子设置属性{1：n.char}（效率更高，只能用整数）</span>
<span class="n">node</span><span class="p">.</span><span class="n">setattribute</span><span class="p">(</span><span class="n">hlist</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_char</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="property">结点资产Property表<a class="headerlink" href="#property" title="Permanent link">#</a></h4>
<p>除了属性，每个节点也可以有一个资产表（property table），你可以用setproperty函数给这个表赋值，用getproperty函数获取资产。<strong>管理资产比管理属性效率低，但方便使用复杂数据。</strong></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="err">\</span><span class="n">directlua</span> <span class="p">{</span>
    <span class="kd">local</span> <span class="n">n</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;glyph&quot;</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">getproperty</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">t</span> <span class="kr">then</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>
        <span class="n">node</span><span class="p">.</span><span class="n">setproperty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
    <span class="kr">end</span>
    <span class="n">t</span><span class="p">.</span><span class="n">one</span> <span class="o">=</span> <span class="s2">&quot;foo&quot;</span>
    <span class="n">t</span><span class="p">.</span><span class="n">two</span> <span class="o">=</span> <span class="s2">&quot;bar&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">getproperty</span><span class="p">(</span><span class="n">n</span><span class="p">).</span><span class="n">one</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">getproperty</span><span class="p">(</span><span class="n">n</span><span class="p">).</span><span class="n">two</span><span class="p">)</span>
    <span class="n">node</span><span class="p">.</span><span class="n">free</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>There are a few helper functions that you normally should not touch as user: getpropertiestable and will give the table that stores properties (using direct entries) and you can best notmess too much with that one either because LuaTEX itself will make sure that entries related tonodes will get wiped when nodes get freed, so that the Lua garbage collector can do its job. Infact, the main reason why we have this mechanism is that it saves the user (or macro package)some work. One can easily write a property mechanism in Lua where after a shipout propertiesgets cleaned up but it's not entirely trivial to make sure that with each freed node also its properties get freed, due to the fact that there can be nodes left over for a next page. And having acallback bound to the node deallocator would add way to much overhead.</p>
<p>When we copy a node list that has a table as property, there are several possibilities: we do thesame as a new node, we copy the entry to the table in properties (a reference), we do a deep copyof a table in the properties, we create a new table and give it the original one as a metatable.After some experiments (that also included timing) with these scenarios we decided that a deepcopy made no sense, nor did nilling. In the end both the shallow copy and the metatable variantwere both ok, although the second one is slower. The most important aspect to keep in mind isthat references to other nodes in properties no longer can be valid for that copy. We could usetwo tables (one unique and one shared) or metatables but that only complicates matters.</p>
<p>When defining a new node, we could already allocate a table but it is rather easy to do that atthe lua end e.g. using a metatable __index method. That way it is under macro package control.When deleting a node, we could keep the slot (e.g. setting it to false) but it could make memoryconsumption raise unneeded when we have temporary large node lists and after that only smalllists. Both are not done because in the end this is what happens now: when a node is copied,and it has a table as property, the new node will share that table. The copy gets its own tablewith the original table as metatable.</p>
<p>A few more experiments were done. For instance: copy attributes to the properties so that wehave fast access at the Lua end. In the end the overhead is not compensated by speed andconvenience, in fact, attributes are not that slow when it comes to accessing them. So this wasrejected.</p>
<p>Another experiment concerned a bitset in the node but again the gain compared to attributeswas neglectable and given the small amount of available bits it also demands a pretty strongagreement over what bit represents what, and this is unlikely to succeed in the TEX community. It doesn't pay off.</p>
<p>Just in case one wonders why properties make sense: it is not so much speed that we gain,but more convenience: storing all kinds of (temporary) data in attributes is no fun and thismechanism makes sure that properties are cleaned up when a node is freed. Also, the advantageof a more or less global properties table is that we stay at the Lua end. An alternative is to storea reference in the node itself but that is complicated by the fact that the register has somelimitations (no numeric keys) and we also don't want to mess with it too much.</p>
<h3 id="tex">TeX相关库<a class="headerlink" href="#tex" title="Permanent link">#</a></h3>
<h4 id="tex_1">tex库<a class="headerlink" href="#tex_1" title="Permanent link">#</a></h4>
<h5 id="_15">简介<a class="headerlink" href="#_15" title="Permanent link">#</a></h5>
<p>表<code>tex</code>包含了一大串虚拟的TEX内部参数，这些参数部分可以写入。这里说的 "虚拟 "意味着，这些条目在Lua中没有严格定义，而只是由一个元表（metatable）来控制的一个前端，元表操作实际的TEX值。因此，大多数的Lua表操作符（如<code>pairs</code>和<code>#</code>）对这类条目不起作用。目前，可以访问几乎所有你可以在<code>\the</code>之后使用的参数，单一标记（token）或TEX特殊标记。这不包括那些需要额外参数的参数，如<code>\the\scriptfont</code>。包含简单的整数和尺寸寄存器的子集是可写、可读的（如<code>\tracingcommands</code> 和 <code>\parindent</code>）。</p>
<h5 id="setget">内部参数值的set、get<a class="headerlink" href="#setget" title="Permanent link">#</a></h5>
<p>本节中的所有参数，可以使用名字作为tex表中的索引直接访问到，或者使用tex.get和tex.set访问。确切的参数和返回值取决于实际的参数，tex.set是否有任何作用也是如此。对于可以设置的参数，可以使用global作为tex.set的第一个参数；这使得赋值是全局的而不是局部的。</p>
<p><code>tex.set (["global",] &lt;string&gt; n, ...)</code></p>
<p><code>... = tex.get (&lt;string&gt; n)</code></p>
<p>Glue有点特别，因为涉及到五个值。返回值是一个glue_specnode，但是当你把false作为最后一个参数传给tex.get时，你会得到glue的宽度，当你传给true时，你会得到所有五个值。否则你会得到一个结点，它是内部值的一个副本，所以你要负责在Lua端释放它。当你设置胶数量时，你可以传递一个glue_spec或者最多五个数字。如果你传入true，你会得到5个胶值，而当你传入false时，你只得到宽度。</p>
<p><strong>整数参数，可读可写：</strong></p>
<ul>
<li>tex.adjdemerits</li>
<li>tex.binoppenalty</li>
<li>tex.brokenpenalty</li>
<li>tex.catcodetable</li>
<li>tex.clubpenalty</li>
<li>tex.day</li>
<li>tex.defaulthyphenchar</li>
<li>tex.defaultskewchar</li>
<li>tex.delimiterfactor</li>
<li>tex.displaywidowpenalty</li>
<li>tex.doublehyphendemerits</li>
<li>tex.endlinechar</li>
<li>tex.errorcontextlines</li>
<li>tex.escapechar</li>
<li>tex.exhyphenpenalty</li>
<li>tex.fam</li>
<li>tex.finalhyphendemerits</li>
<li>tex.floatingpenalty</li>
<li>tex.globaldefs</li>
<li>tex.hangafter</li>
<li>tex.hbadness</li>
<li>tex.holdinginserts</li>
<li>tex.hyphenpenalty</li>
<li>tex.interlinepenalty</li>
<li>tex.language</li>
<li>tex.lastlinefit</li>
<li>tex.lefthyphenmin</li>
<li>tex.linepenalty</li>
<li>tex.localbrokenpenalty</li>
<li>tex.localinterlinepenalty</li>
<li>tex.looseness</li>
<li>tex.mag</li>
<li>tex.maxdeadcycles</li>
<li>tex.month</li>
<li>tex.newlinechar</li>
<li>tex.outputpenalty</li>
<li>tex.pausing</li>
<li>tex.postdisplaypenalty</li>
<li>tex.predisplaydirection</li>
<li>tex.predisplaypenalty</li>
<li>tex.pretolerance</li>
<li>tex.relpenalty</li>
<li>tex.righthyphenmin</li>
<li>tex.savinghyphcodes</li>
<li>tex.savingvdiscards</li>
<li>tex.showboxbreadth</li>
<li>tex.showboxdepth</li>
<li>tex.time</li>
<li>tex.tolerance</li>
<li>tex.tracingassigns</li>
<li>tex.tracingcommands</li>
<li>tex.tracinggroups</li>
<li>tex.tracingifs</li>
<li>tex.tracinglostchars</li>
<li>tex.tracingmacros</li>
<li>tex.tracingnesting</li>
<li>tex.tracingonline</li>
<li>tex.tracingoutput</li>
<li>tex.tracingpages</li>
<li>tex.tracingparagraphs</li>
<li>tex.tracingrestores</li>
<li>tex.tracingscantokens</li>
<li>tex.tracingstats</li>
<li>tex.uchyph</li>
<li>tex.vbadness</li>
<li>tex.widowpenalty</li>
<li>tex.year</li>
</ul>
<p><strong>整数参数，只读：</strong></p>
<ul>
<li>tex.deadcycles</li>
<li>tex.insertpenalties</li>
<li>tex.parshape</li>
<li>tex.interlinepenalties</li>
<li>tex.clubpenalties</li>
<li>tex.widowpenalties</li>
<li>tex.displaywidowpenalties</li>
<li>tex.prevgraf</li>
<li>tex.spacefactor</li>
</ul>
<p><strong>尺寸参数：</strong></p>
<p>尺寸参数接受Lua数字（表示缩放过的点数）或字符串（包含次数）。其结果总是缩放过的点数。<strong>以下可读可写：</strong></p>
<ul>
<li>tex.boxmaxdepth</li>
<li>tex.delimitershortfall</li>
<li>tex.displayindent</li>
<li>tex.displaywidth</li>
<li>tex.emergencystretch</li>
<li>tex.hangindent</li>
<li>tex.hfuzz</li>
<li>tex.hoffset</li>
<li>tex.hsize</li>
<li>tex.lineskiplimit</li>
<li>tex.mathsurround</li>
<li>tex.maxdepth</li>
<li>tex.nulldelimiterspace</li>
<li>tex.overfullrule</li>
<li>tex.pagebottomoffset</li>
<li>tex.pageheight</li>
<li>tex.pageleftoffset</li>
<li>tex.pagerightoffset</li>
<li>tex.pagetopoffset</li>
<li>tex.pagewidth</li>
<li>tex.parindent</li>
<li>tex.predisplaysize</li>
<li>tex.scriptspace</li>
<li>tex.splitmaxdepth</li>
<li>tex.vfuzz</li>
<li>tex.voffset</li>
<li>tex.vsize</li>
<li>tex.prevdepth</li>
<li>tex.prevgraf</li>
<li>tex.spacefactor</li>
</ul>
<p><strong>以下只读：</strong></p>
<ul>
<li>tex.pagedepth</li>
<li>tex.pagefilllstretch</li>
<li>tex.pagefillstretch</li>
<li>tex.pagefilstretch</li>
<li>tex.pagegoal</li>
<li>tex.pageshrink</li>
<li>tex.pagestretch</li>
<li>tex.pagetotal</li>
</ul>
<p>对只读参数进行设置会覆盖原参数。</p>
<p>对于prevdepth, prevgraf and spacefactor的操作，通常通过tex.nest表来操作。</p>
<p><strong>方向参数：</strong></p>
<ul>
<li>tex.bodydir</li>
<li>tex.mathdir</li>
<li>tex.pagedir</li>
<li>tex.pardir</li>
<li>tex.textdir</li>
</ul>
<p><strong>胶参数：</strong></p>
<ul>
<li>tex.abovedisplayshortskip</li>
<li>tex.abovedisplayskip</li>
<li>tex.baselineskip</li>
<li>tex.belowdisplayshortskip</li>
<li>tex.belowdisplayskip</li>
<li>tex.leftskip</li>
<li>tex.lineskip</li>
<li>tex.parfillskip</li>
<li>tex.parskip</li>
<li>tex.rightskip</li>
<li>tex.spaceskip</li>
<li>tex.splittopskip</li>
<li>tex.tabskip</li>
<li>tex.topskip</li>
<li>tex.xspaceskip</li>
</ul>
<p><strong>Muglue胶参数：</strong></p>
<ul>
<li>tex.medmuskip</li>
<li>tex.thickmuskip</li>
<li>tex.thinmuskip</li>
</ul>
<p><strong>tocken列表参数：</strong></p>
<ul>
<li>tex.errhelp</li>
<li>tex.everycr</li>
<li>tex.everydisplay</li>
<li>tex.everyeof</li>
<li>tex.everyhbox</li>
<li>tex.everyjob</li>
<li>tex.everymath</li>
<li>tex.everypar</li>
<li>tex.everyvbox</li>
<li>tex.output</li>
</ul>
<h5 id="_16">转换命令<a class="headerlink" href="#_16" title="Permanent link">#</a></h5>
<p>只读，返回字符串。</p>
<ul>
<li>tex.eTeXVersion</li>
<li>tex.eTeXrevision</li>
<li>tex.formatname</li>
<li>tex.jobname</li>
<li>tex.luatexbanner</li>
<li>tex.luatexrevision</li>
<li>tex.fontname(number)</li>
<li>tex.uniformdeviate(number)</li>
<li>tex.number(number)</li>
<li>tex.romannumeral(number)</li>
<li>tex.fontidentifier(number)</li>
</ul>
<h5 id="last_item">last item命令<a class="headerlink" href="#last_item" title="Permanent link">#</a></h5>
<p>只读，返回数字。</p>
<ul>
<li>tex.lastpenalty</li>
<li>tex.lastkern</li>
<li>tex.lastskip</li>
<li>tex.lastnodetype</li>
<li>tex.inputlineno</li>
<li>tex.lastxpos</li>
<li>tex.lastypos</li>
<li>tex.randomseed</li>
<li>tex.luatexversion</li>
<li>tex.eTeXminorversion</li>
<li>tex.eTeXversion</li>
<li>tex.currentgrouplevel</li>
<li>tex.currentgrouptype</li>
<li>tex.currentiflevel</li>
<li>tex.currentiftype</li>
<li>tex.currentifbranch</li>
</ul>
<h5 id="set_get_and_is">取用寄存器：set<em>, get</em> and is*<a class="headerlink" href="#set_get_and_is" title="Permanent link">#</a></h5>
<p>TEX的属性（\attribute）的寄存器可以使用tex表的2X5个虚拟子表来访问和写入：</p>
<ul>
<li>tex.attribute</li>
<li>tex.count</li>
<li>tex.dimen</li>
<li>tex.skip</li>
<li>tex.glue</li>
<li>tex.muskip</li>
<li>tex.muglue</li>
<li>tex.toks</li>
</ul>
<p>可以使用与控制序列\attributedef, \countdef, \dimendef, \skipdef, \toksdef相关的名字作为这些表的索引（LuaTeX启动时会查询）：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">tex</span><span class="p">.</span><span class="n">count</span><span class="p">.</span><span class="n">scratchcounter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">enormous</span> <span class="o">=</span> <span class="n">tex</span><span class="p">.</span><span class="n">dimen</span><span class="p">[</span><span class="s1">&#39;maxdimen&#39;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
<p>此功能最终还可用于<chardef tokens>和展开为数字的宏。</p>
<p>count和attribute寄存器接受、返回Lua数字。</p>
<p>dimension寄存器Lua数字（缩放后的点数）或字符串（内含绝对尺寸，禁用em and ex and px），结果始终是缩放后的点数。</p>
<p><strong>除了以上的数字描述形式，还有一一对应set、get函数形式，比如：</strong></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">tex</span><span class="p">.</span><span class="n">setskip</span> <span class="p">([</span><span class="s2">&quot;global&quot;</span><span class="p">,]</span> <span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span> <span class="n">n</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">s</span><span class="p">)</span>
<span class="n">tex</span><span class="p">.</span><span class="n">setskip</span> <span class="p">([</span><span class="s2">&quot;global&quot;</span><span class="p">,]</span> <span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">s</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">tex</span><span class="p">.</span><span class="n">getskip</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span> <span class="n">n</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">tex</span><span class="p">.</span><span class="n">getskip</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">s</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h5 id="code_getsetcodes">字符code寄存器: [get|set]*code[s]<a class="headerlink" href="#code_getsetcodes" title="Permanent link">#</a></h5>
<p>通过tex的六个虚拟字表读写TEX字符code表(\lccode, \uccode, \sfcode, \catcode, \mathcode, \delcode)：</p>
<ul>
<li>tex.lccode</li>
<li>tex.uccode</li>
<li>tex.sfcode</li>
<li>tex.catcode</li>
<li>tex.mathcode</li>
<li>tex.delcode</li>
</ul>
<p>对应的get、set形式：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">tex</span><span class="p">.</span><span class="n">setsfcode</span> <span class="p">([</span><span class="s2">&quot;global&quot;</span><span class="p">,]</span> <span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span> <span class="n">n</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span> <span class="n">s</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">tex</span><span class="p">.</span><span class="n">getsfcode</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span> <span class="n">n</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h5 id="box_getsetbox">Box寄存器: [get|set]box<a class="headerlink" href="#box_getsetbox" title="Permanent link">#</a></h5>
<p>以数组形式设置和查询由\hbox, \vbox or \vtop生成的box实例：</p>
<p>tex.box</p>
<p>对应的set、get形式：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">tex</span><span class="p">.</span><span class="n">setbox</span><span class="p">([</span><span class="s2">&quot;global&quot;</span><span class="p">,]</span> <span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span> <span class="n">n</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">s</span><span class="p">)</span>
<span class="n">tex</span><span class="p">.</span><span class="n">setbox</span><span class="p">([</span><span class="s2">&quot;global&quot;</span><span class="p">,]</span> <span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">cs</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">s</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">tex</span><span class="p">.</span><span class="n">getbox</span><span class="p">(</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span> <span class="n">n</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">tex</span><span class="p">.</span><span class="n">getbox</span><span class="p">(</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">cs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>通过赋值方式引用盒子，要保证被引用盒子始终有效。或用深拷贝：</p>
<p>tex.box[0] = node.copy_list(tex.box[2])</p>
<h5 id="boxe_usesaveboxresource_and_getboxresourcedimensions">重用boxe: [use|save]boxresource and getboxresourcedimensions<a class="headerlink" href="#boxe_usesaveboxresource_and_getboxresourcedimensions" title="Permanent link">#</a></h5>
<p>寄存盒子以便使用、重用：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">local</span> <span class="n">index</span> <span class="o">=</span> <span class="n">tex</span><span class="p">.</span><span class="n">saveboxresource</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">attributes</span><span class="p">,</span><span class="n">resources</span><span class="p">,</span><span class="n">immediate</span><span class="p">,</span><span class="nb">type</span><span class="p">,</span><span class="n">margin</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>生成引用：</p>
<p>local reused = tex.useboxresource(n,wd,ht,dp)</p>
<p>获取尺寸（width, height, depth and margin）：</p>
<p>local w, h, d, m = tex.getboxresourcedimensions(n)</p>
<h5 id="triggerbuildpage">triggerbuildpage<a class="headerlink" href="#triggerbuildpage" title="Permanent link">#</a></h5>
<p>在有东西要建立的情况下，调用内部函数来建立一个页面。</p>
<h5 id="splitbox">splitbox<a class="headerlink" href="#splitbox" title="Permanent link">#</a></h5>
<p>分割盒子：</p>
<p>local vlist = tex.splitbox(n,height,mode)</p>
<p>剩余部分留在原盒子中，返回一个包装过的vlist。本操作与\vsplit对应。mode可以是additional or exactly，关联分割出的盒子。</p>
<h5 id="accessing_math_parameters_getsetmath">Accessing math parameters: [get|set]math<a class="headerlink" href="#accessing_math_parameters_getsetmath" title="Permanent link">#</a></h5>
<h5 id="special_list_heads_getsetlist">Special list heads: [get|set]list<a class="headerlink" href="#special_list_heads_getsetlist" title="Permanent link">#</a></h5>
<h5 id="semantic_nest_levels_getnest_and_ptr">Semantic nest levels: getnest and ptr<a class="headerlink" href="#semantic_nest_levels_getnest_and_ptr" title="Permanent link">#</a></h5>
<h5 id="print_functions">Print functions<a class="headerlink" href="#print_functions" title="Permanent link">#</a></h5>
<h5 id="_17">辅助函数<a class="headerlink" href="#_17" title="Permanent link">#</a></h5>
<p><number> n = tex.sp(<number> o)
<number> n = tex.sp(<string> s)</p>
<p>用数字或字符串表示的公开尺寸，转换为缩放过的点数。</p>
<h5 id="functions_for_dealing_with_primitives">Functions for dealing with primitives<a class="headerlink" href="#functions_for_dealing_with_primitives" title="Permanent link">#</a></h5>
<p>开启基元命令（置于前缀表中）：</p>
<ul>
<li>tex.enableprimitives(<string> prefix, <table> primitive names)</li>
</ul>
<p>提取基元命令：</p>
<ul>
<li><table> t = tex.extraprimitives(<string> s, ...)</li>
<li><table> t = tex.primitives() 所有命令的表</li>
</ul>
<p>例子：</p>
<p>tex.enableprimitives("",
            tex.extraprimitives(
                "omega", "aleph", "luatex"))</p>
<p>tex.enableprimitives("luatex",
            tex.extraprimitives(
                "omega", "aleph", "luatex"))</p>
<p>tex.enableprimitives("luatex",tex.extraprimitives("luatex"))</p>
<p>t = tex.extraprimitives("tex")</p>
<p>查询所有基元：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">t</span> <span class="o">=</span> <span class="n">tex</span><span class="p">.</span><span class="n">primitives</span><span class="p">()</span>
<span class="kr">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="kr">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="kr">do</span>
    <span class="nb">print</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>
<h5 id="_18">内核功能界面<a class="headerlink" href="#_18" title="Permanent link">#</a></h5>
<h6 id="badness">badness<a class="headerlink" href="#badness" title="Permanent link">#</a></h6>
<p><number> b = tex.badness(<number> t, <number> s)</p>
<p>用于断行时进行计算劣质/坏性（badness）。</p>
<p>t and s是缩放值。the function returns the badness for when total t is supposed to be made from amounts that sum to s. 返回数近似<span class="arithmatex">\(100(𝑡/𝑠)^3\)</span>。</p>
<h6 id="texresetparagraph">tex.resetparagraph<a class="headerlink" href="#texresetparagraph" title="Permanent link">#</a></h6>
<p>重置段落。</p>
<h6 id="linebreak">linebreak分行<a class="headerlink" href="#linebreak" title="Permanent link">#</a></h6>
<p>见源码<code>node-ltp.lua</code></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">local</span> <span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">nodelist</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">table</span><span class="o">&gt;</span> <span class="n">info</span> <span class="o">=</span> <span class="n">tex</span><span class="p">.</span><span class="n">linebreak</span><span class="p">(</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">listhead</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">table</span><span class="o">&gt;</span> <span class="n">parameters</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>2022-07-26，在使用<code>tex.linebreak()</code>前，可以使用准备函数<code>tex.preparelinebreak()</code>，为你的结点列表准备必要的东西：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code>&lt;par vmodepar&gt; -- 用户必须实现自行准备，否则无法找到插入点
&lt;glue parinitleftskip&gt;
&lt;glue parinitrightskip&gt;
&lt;glue indentskip&gt; -- 用户必须实现自行准备，否则无法找到插入点
...
&lt;penalty linepenalty&gt; -- infinite penalty，原列表最后一个胶会被删除
&lt;glue parfillleftskip&gt;
&lt;glue parfillskip&gt; -- 与parfillrightskip相同
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">local</span> <span class="n">h</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">parinitleftskip</span><span class="p">,</span> <span class="n">parinitrightskip</span><span class="p">,</span> <span class="n">parfillleftskip</span><span class="p">,</span> <span class="n">parfillrightskip</span> <span class="o">=</span> <span class="n">tex</span><span class="p">.</span><span class="n">preparelinebreak</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">new_head</span> <span class="o">=</span> <span class="n">tex</span><span class="p">.</span><span class="n">linebreak</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
<span class="n">tex</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="n">new_head</span><span class="p">)</span> <span class="c1">-- 查看结果</span>
</code></pre></div></td></tr></table></div>
<p>表参数parameters：</p>
<table>
<thead>
<tr>
<th>NAME</th>
<th>TYPE</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>tracingparagraphs</td>
<td>number</td>
<td>如果是正值，则生成断行算法跟踪，见log</td>
</tr>
<tr>
<td>hsize</td>
<td>number</td>
<td>在垂直盒子中排版时所用的行宽。以sp计</td>
</tr>
<tr>
<td>emergencystretch</td>
<td>number</td>
<td>（为前两遍断行失败后尝试第三遍时）段落各行应用的额外拉伸。以sp计，比如0.1 * hsize</td>
</tr>
<tr>
<td>pardir</td>
<td>string</td>
<td>段落方向</td>
</tr>
<tr>
<td>hangafter</td>
<td>number</td>
<td>如果是正数，表示缩进开始前的行数；如果是负数，其绝对值是指从段落的第一行开始的缩进行数。默认值为1，在每个段落后恢复默认值1。</td>
</tr>
<tr>
<td>hangindent</td>
<td>number</td>
<td>如果是正数，表示从左页边距开始缩进；如果是负数，是从右页边距开始缩进的负数。默认值为0pt，在每个段落之后都会恢复。以sp计</td>
</tr>
<tr>
<td>leftskip</td>
<td>glue_spec node</td>
<td>行左胶的胶性结点</td>
</tr>
<tr>
<td>rightskip</td>
<td>glue_spec node</td>
<td>行右胶的胶性结点</td>
</tr>
<tr>
<td>parshape</td>
<td>table</td>
<td>段落形状表</td>
</tr>
<tr>
<td>pretolerance</td>
<td>number</td>
<td>不断词段落的容忍值（坏性），tex默认100</td>
</tr>
<tr>
<td>tolerance</td>
<td>number</td>
<td>断词段落中各行的容忍值（坏性），tex默认200</td>
</tr>
<tr>
<td>looseness</td>
<td>number</td>
<td>本段必须比理想行数多出这么多行</td>
</tr>
<tr>
<td>lastlinefit</td>
<td>number</td>
<td>段落末行的调整率，乘以1000</td>
</tr>
<tr>
<td>pdfadjustspacing</td>
<td>number</td>
<td></td>
</tr>
<tr>
<td>pdfprotrudechars</td>
<td>number</td>
<td></td>
</tr>
<tr>
<td>interlinepenalty</td>
<td>number or table</td>
<td>行间罚点，TEX默认为0，可以是像 \interlinepenalties 样的数组构成的表</td>
</tr>
<tr>
<td>linepenalty</td>
<td>number</td>
<td>每个断行的罚点，tex默认10</td>
</tr>
<tr>
<td>hyphenpenalty</td>
<td>number</td>
<td>在一个断词点/连字符处断行的罚点，TEX默认为50</td>
</tr>
<tr>
<td>exhyphenpenalty</td>
<td>number</td>
<td>当断点前文本为空时，在水平行连字符条目处分行的罚点，TEX默认为50</td>
</tr>
<tr>
<td>clubpenalty</td>
<td>number or table</td>
<td>段首孤行罚点，TEX默认为150，可以是像 \clubpenalties  样的数组构成的表</td>
</tr>
<tr>
<td>widowpenalty</td>
<td>number or table</td>
<td>断尾孤行罚点，TEX默认为150，可以是像 \widowpenalties 样的数组构成的表</td>
</tr>
<tr>
<td>brokenpenalty</td>
<td>number</td>
<td>在断词行后分页的额外罚点，TEX默认为100</td>
</tr>
<tr>
<td>finalhyphendemerits</td>
<td>number</td>
<td>倒数第二行有连字时附加的罚点，TEX默认为5000</td>
</tr>
<tr>
<td>doublehyphendemerits</td>
<td>number</td>
<td>连续两行以连字符结束的罚点，TEX默认为10000</td>
</tr>
<tr>
<td>adjdemerits</td>
<td>number</td>
<td>毗连两行的视觉不协调（Badness分类号差别大于1）的罚点，TEX默认为10000</td>
</tr>
</tbody>
</table>
<p>你必须自行确保 listhead 是一个合适的段落列表，这个函数不会向它添加任何结点。确切地说，如果你想替换内核的断行行为，你可能需要做以下工作（如果你没有在pre_linebreak_filter或linebreak_filter回调中工作，<strong>或者当从listhead开始的原始列表是以水平模式生成的</strong>）：</p>
<ol>
<li>添加一个"缩进盒子indent box"，或许在开始时再添加一个par结点（仅当你需要它们时）；</li>
<li>用一个无限罚分来替换最后的胶（如果最后一个结点不是胶，则添加这样一个罚分）；</li>
<li>在该罚分结点之后添加一个胶结点表示\parfillskip；<strong>黄注：此时是各行拉伸胶宽、两端对齐模式。如果要模仿系统一般模式——各行平均收缩胶宽、末行左对齐，则要在parfillskip前再添加一个hskip，宽度和收缩均同textwidth（或hsize？？）行宽；反之则宽度为0，拉伸为textwidth。</strong></li>
<li>确保所有的prev指针都是正确的。</li>
</ol>
<p>结果是一个结点列表，如果你想把它分配给一个\vbox，它仍然需要vpack。返回的info信息表包含四个值，都是数字：</p>
<ul>
<li>prevdepth： 断行后段落最后一行的深度；</li>
<li>prevgraf：  断行后段落的行数；</li>
<li>looseness：  断行后段落的实际松性looseness（比理想行数多出的行数）</li>
<li>demerits：  所选方案的总缺点demerits</li>
</ul>
<p>请注意，有几件事你不能用这个函数来干预。除了通过pdfadjustspacing之外，你不能影响字体的伸缩，因为它的设置是在其他地方进行的。hbadness和hfuzz等同此。所有这些都在hpack程序中，它通过globals获取自己的变量。</p>
<p>例：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">-- 断行宽度10em</span>
<span class="kd">local</span> <span class="n">new_head</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">tex</span><span class="p">.</span><span class="n">linebreak</span><span class="p">(</span><span class="n">copy_head</span><span class="p">,</span> <span class="p">{</span> <span class="n">hsize</span> <span class="o">=</span>  <span class="n">tex</span><span class="p">.</span><span class="n">sp</span><span class="p">(</span><span class="s2">&quot;10em&quot;</span><span class="p">)})</span>
</code></pre></div></td></tr></table></div>
<p>断行后：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1"># 一般行末尾是两个胶：</span>
&lt;node<span class="w"> </span>:<span class="w">   </span><span class="m">5582</span><span class="w"> </span>&lt;<span class="o">=</span><span class="w">   </span><span class="nv">5594</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w">   </span><span class="m">6210</span><span class="w"> </span>:<span class="w"> </span>glue<span class="w"> </span>rightskip&gt;
&lt;node<span class="w"> </span>:<span class="w">   </span><span class="m">5594</span><span class="w"> </span>&lt;<span class="o">=</span><span class="w">   </span><span class="nv">6210</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w">    </span>nil<span class="w"> </span>:<span class="w"> </span>glue<span class="w"> </span>righthangskip&gt;
<span class="c1"># 末行末尾是三个胶：</span>
&lt;node<span class="w"> </span>:<span class="w">   </span><span class="m">6157</span><span class="w"> </span>&lt;<span class="o">=</span><span class="w">   </span><span class="nv">6162</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w">   </span><span class="m">6198</span><span class="w"> </span>:<span class="w"> </span>glue<span class="w"> </span>parfillleftskip&gt;
&lt;node<span class="w"> </span>:<span class="w">   </span><span class="m">6162</span><span class="w"> </span>&lt;<span class="o">=</span><span class="w">   </span><span class="nv">6198</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w">   </span><span class="m">6180</span><span class="w"> </span>:<span class="w"> </span>glue<span class="w"> </span>rightskip&gt;
&lt;node<span class="w"> </span>:<span class="w">   </span><span class="m">6198</span><span class="w"> </span>&lt;<span class="o">=</span><span class="w">   </span><span class="nv">6180</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w">    </span>nil<span class="w"> </span>:<span class="w"> </span>glue<span class="w"> </span>righthangskip&gt;
</code></pre></div></td></tr></table></div>
<p>配置示例（可能比较老旧）：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">local</span> <span class="n">main_text_tbl</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">hsize</span> <span class="o">=</span> <span class="n">text_width</span><span class="p">,</span>

    <span class="c1">--The header will be centered.</span>
    <span class="n">leftskip</span>                 <span class="o">=</span> <span class="n">util</span><span class="p">.</span><span class="n">filll</span><span class="p">(),</span>
    <span class="n">rightskip</span>                <span class="o">=</span> <span class="n">util</span><span class="p">.</span><span class="n">filll</span><span class="p">(),</span>

    <span class="n">parindent</span>                <span class="o">=</span> <span class="n">tex</span><span class="p">.</span><span class="n">parindent</span><span class="p">,</span>
    <span class="n">parfillskipstretch</span>       <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">parfillskipstretch_order</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>

    <span class="n">font</span>           <span class="o">=</span> <span class="n">main_text_font</span><span class="p">,</span>
    <span class="n">space</span>          <span class="o">=</span> <span class="n">font</span><span class="p">.</span><span class="n">fonts</span><span class="p">[</span><span class="n">main_text_font</span><span class="p">].</span><span class="n">parameters</span><span class="p">.</span><span class="n">space</span><span class="p">,</span>
    <span class="n">space_stretch</span>  <span class="o">=</span> <span class="n">font</span><span class="p">.</span><span class="n">fonts</span><span class="p">[</span><span class="n">main_text_font</span><span class="p">].</span><span class="n">parameters</span><span class="p">.</span><span class="n">space_stretch</span><span class="p">,</span>
    <span class="n">space_shrink</span>   <span class="o">=</span> <span class="n">font</span><span class="p">.</span><span class="n">fonts</span><span class="p">[</span><span class="n">main_text_font</span><span class="p">].</span><span class="n">parameters</span><span class="p">.</span><span class="n">space_shrink</span><span class="p">,</span>

    <span class="n">lang</span>           <span class="o">=</span> <span class="n">tex</span><span class="p">.</span><span class="n">language</span><span class="p">,</span>
    <span class="n">lefthyphenmin</span>  <span class="o">=</span> <span class="n">tex</span><span class="p">.</span><span class="n">lefthyphenmin</span><span class="p">,</span>
    <span class="n">righthyphenmin</span> <span class="o">=</span> <span class="n">tex</span><span class="p">.</span><span class="n">righthyphenmin</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><a href="https://www.mail-archive.com/luatex@tug.org/msg03398.html">段落形状parshape</a></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">-- 系统段落形状 tex.parshape ？？？空值</span>

<span class="kr">function</span> <span class="nf">do_linebreak</span><span class="p">(</span> <span class="n">nodelist</span><span class="p">,</span><span class="n">hsize</span><span class="p">,</span><span class="n">parameters</span> <span class="p">)</span>
  <span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span> <span class="ow">or</span> <span class="p">{}</span>

  <span class="kd">local</span> <span class="n">pdfignoreddimen</span>
  <span class="n">pdfignoreddimen</span>    <span class="o">=</span> <span class="o">-</span><span class="mi">65536000</span>

  <span class="kd">local</span> <span class="n">default_parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">hsize</span> <span class="o">=</span> <span class="n">hsize</span><span class="p">,</span>
    <span class="n">emergencystretch</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">hsize</span><span class="p">,</span>
    <span class="n">hyphenpenalty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">linepenalty</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">pretolerance</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">tolerance</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
    <span class="n">doublehyphendemerits</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">pdfeachlineheight</span> <span class="o">=</span> <span class="n">pdfignoreddimen</span><span class="p">,</span>
    <span class="n">pdfeachlinedepth</span>  <span class="o">=</span> <span class="n">pdfignoreddimen</span><span class="p">,</span>
    <span class="n">pdflastlinedepth</span>  <span class="o">=</span> <span class="n">pdfignoreddimen</span><span class="p">,</span>
    <span class="n">pdfignoreddimen</span>   <span class="o">=</span> <span class="n">pdfignoreddimen</span><span class="p">,</span>
    <span class="n">parshape</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">40</span><span class="o">*</span><span class="mi">2</span><span class="o">^</span><span class="mi">16</span><span class="p">},{</span><span class="mi">0</span><span class="p">,</span><span class="n">hsize</span><span class="p">}</span> <span class="p">}</span> <span class="c1">-- {{缩进,行宽},..}</span>
  <span class="p">}</span>
  <span class="nb">setmetatable</span><span class="p">(</span><span class="n">parameters</span><span class="p">,{</span><span class="n">__index</span><span class="o">=</span><span class="n">default_parameters</span><span class="p">})</span>
  <span class="kd">local</span> <span class="n">j</span> <span class="o">=</span> <span class="n">tex</span><span class="p">.</span><span class="n">linebreak</span><span class="p">(</span><span class="n">nodelist</span><span class="p">,</span><span class="n">parameters</span><span class="p">)</span>

<span class="p">...</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>
<h6 id="shipout">shipout<a class="headerlink" href="#shipout" title="Permanent link">#</a></h6>
<p>tex.shipout(<number> n)</p>
<p>把n号盒子送到输出文件，清除盒子寄存器。</p>
<h6 id="getpagestate">getpagestate<a class="headerlink" href="#getpagestate" title="Permanent link">#</a></h6>
<p>以整数值报告当前页的阶段（state）: empty, box_there or inserts_only。</p>
<h6 id="getlocallevel">getlocallevel<a class="headerlink" href="#getlocallevel" title="Permanent link">#</a></h6>
<p>以整数值报告局部循环的当前水平。出错用。</p>
<h5 id="randomizers">Randomizers<a class="headerlink" href="#randomizers" title="Permanent link">#</a></h5>
<h5 id="functions_related_to_synctex">Functions related to synctex<a class="headerlink" href="#functions_related_to_synctex" title="Permanent link">#</a></h5>
<h4 id="token">token库<a class="headerlink" href="#token" title="Permanent link">#</a></h4>
<h5 id="_19">扫描器<a class="headerlink" href="#_19" title="Permanent link">#</a></h5>
<p><em>参见CLD的宏</em></p>
<p>token库提供了拦截输入并在Lua级别处理它的方法。该库提供了一个基本的扫描器基础设施，可以用来<strong>编写接受各种参数的宏</strong>。这个接口的目的是保持通用性，并且性能相当好。人们可以在没有太多开销的情况下建立额外的分析器。由于LuaTEX的主要原则是提供一套最小的工具，而不是解决方案，所以要看宏包编写者如何从中受益。扫描器函数可能是最吸引人的。</p>
<table>
<thead>
<tr>
<th>FUNCTION</th>
<th>ARGUMENT</th>
<th>RESULT</th>
</tr>
</thead>
<tbody>
<tr>
<td>scan_keyword</td>
<td>string</td>
<td>returns true if the given keyword is gobbled; as with the regular TEX keyword scanner this is case insensitive (and ascii based)</td>
</tr>
<tr>
<td>scan_keywordcs</td>
<td>string</td>
<td>returns true if the given keyword is gobbled; this variant is case sensitive and also suitable for utf8</td>
</tr>
<tr>
<td>scan_int</td>
<td></td>
<td>returns an integer</td>
</tr>
<tr>
<td>scan_real</td>
<td></td>
<td>returns a number from e.g. 1, 1.1, .1 with optional collapsed signs</td>
</tr>
<tr>
<td>scan_float</td>
<td></td>
<td>returns a number from e.g. 1, 1.1, .1, 1.1E10, , .1e-10 with optional collapsed signs</td>
</tr>
<tr>
<td>scan_dimen</td>
<td>infinity, mu-units</td>
<td>returns a number representing a dimension and or two numbers being the filler and order</td>
</tr>
<tr>
<td>scan_glue</td>
<td>mu-units</td>
<td>returns a glue spec node</td>
</tr>
<tr>
<td>scan_toks</td>
<td>definer, expand</td>
<td>returns a table of tokens tokens</td>
</tr>
<tr>
<td>scan_code</td>
<td>bitset</td>
<td>returns a character if its category is in the given bitset(representing catcodes)</td>
</tr>
<tr>
<td>scan_string</td>
<td></td>
<td>returns a string given between {}, as \macro or as sequence of characters with catcode 11 or 12</td>
</tr>
<tr>
<td>scan_argument</td>
<td>boolean</td>
<td>this one is simular to scanstring but also accepts a \cs</td>
</tr>
<tr>
<td>scan_word</td>
<td></td>
<td>returns a sequence of characters with catcode 11 or 12 as string</td>
</tr>
<tr>
<td>scan_csname</td>
<td></td>
<td>returns foo after scanning \foo</td>
</tr>
<tr>
<td>scan_list</td>
<td></td>
<td>picks up a box specification and returns a [h</td>
</tr>
</tbody>
</table>
<p>当扫描token时，表示我们我们正在定义一个宏，在这种情况下，结果也将提供关于预期的参数的信息，在结果中，这将由一个表示异议的分隔符分开。expansion旗标决定了列表是否会被扩展。</p>
<p>scan_argument函数会扩展给定的参数。当扫描一个带括号的参数时，可以通过传递false（默认为true）来禁止扩展。在控制序列的情况下，通过false将导致单级扩展（宏的含义）。</p>
<p>lua界面，以字符串的形式传送参数：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\directlua</span> <span class="nb">{</span>
function mymacro(n)
    ...
end
<span class="nb">}</span>
<span class="k">\define</span><span class="na">[1]</span><span class="k">\mymacro</span><span class="nb">{</span><span class="c">%</span>
    <span class="k">\directlua</span> <span class="nb">{</span>
        mymacro(<span class="k">\number\dimexpr</span>#1)
    <span class="nb">}</span><span class="c">%</span>
<span class="nb">}</span>
<span class="k">\mymacro</span><span class="nb">{</span>12pt<span class="nb">}</span>
<span class="k">\mymacro</span><span class="nb">{</span><span class="k">\dimen</span>0<span class="nb">}</span>
</code></pre></div></td></tr></table></div>
<p>从输入流中扫描参数：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\directlua</span> <span class="nb">{</span>
function mymacro()
    --直接扫描命令后参数，不需要再转换，对于数字和尺寸会高效一些，但也有限
    local d = token.scan<span class="nb">_</span>dimen()
    ...
end
<span class="nb">}</span>
<span class="k">\define</span><span class="na">[1]</span><span class="k">\mymacro</span><span class="nb">{</span><span class="c">%</span>
    <span class="k">\directlua</span> <span class="nb">{</span>
        mymacro()
    <span class="nb">}</span><span class="c">%</span>
<span class="nb">}</span>
<span class="k">\mymacro</span> 12pt
<span class="k">\mymacro</span> <span class="k">\dimen</span>0
</code></pre></div></td></tr></table></div>
<h5 id="token_1">生成token<a class="headerlink" href="#token_1" title="Permanent link">#</a></h5>
<p>local t = token.create("relax")</p>
<p>生成一个带有\relax基元属性的token。可用的token属性包括：</p>
<table>
<thead>
<tr>
<th>NAME</th>
<th>EXPLANATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>command</td>
<td>一个代表内部命令的数字</td>
</tr>
<tr>
<td>cmdname</td>
<td>命令的类型，比如catcode字符，确定内部处理的分类器</td>
</tr>
<tr>
<td>csname</td>
<td>控制序列(如果可用)</td>
</tr>
<tr>
<td>id</td>
<td>token的id</td>
</tr>
<tr>
<td>tok</td>
<td>TEX中存储的完整的token数字</td>
</tr>
<tr>
<td>active</td>
<td>布尔值，表示token的激活状态</td>
</tr>
<tr>
<td>expandable</td>
<td>布尔值，表示表示token(宏)能否展开</td>
</tr>
<tr>
<td>protected</td>
<td>布尔值，表示token(宏)受保护</td>
</tr>
<tr>
<td>mode</td>
<td>数值，表示一个字符或实体</td>
</tr>
<tr>
<td>index</td>
<td>数值，从0x0000到0xFFFF，表示一个TEX寄存器索引</td>
</tr>
</tbody>
</table>
<p>可以通过getter get_<fieldname> 获取token的这些属性。</p>
<h5 id="_20">宏<a class="headerlink" href="#_20" title="Permanent link">#</a></h5>
<p><em>参见CLD的宏</em></p>
<p><code>token.set_macro</code>函数可以接受四个参数：</p>
<p>token.set_macro("csname","content")
token.set_macro("csname","content","global")
token.set_macro("csname")</p>
<p>第一个参数可以是catcodetable标识符：</p>
<p>token.set_macro(catcodetable,"csname","content")
token.set_macro(catcodetable,"csname","content","global")
token.set_macro(catcodetable,"csname")</p>
<p>等价于：</p>
<p>\def\csname{content}
\gdef\csname{content}
\def\csname{}</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\directlua</span><span class="nb">{</span>token.set<span class="nb">_</span>macro(&#39;foo&#39;, &#39;GREEN&#39;)<span class="nb">}</span>
</code></pre></div></td></tr></table></div>
<p>等价于：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\newcommand*\foo</span><span class="nb">{</span>GREEN<span class="nb">}</span>
</code></pre></div></td></tr></table></div>
<p>宏输出命令的转义：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>token.set<span class="nb">_</span>macro(&quot;mymacro&quot;,[-[<span class="k">\string\emph</span><span class="nb">{</span>content<span class="nb">}</span>]-])
</code></pre></div></td></tr></table></div>
<p>\chardef（无效者会被忽略）：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">set_char</span><span class="p">(</span><span class="s2">&quot;csname&quot;</span><span class="p">,</span><span class="n">number</span><span class="p">)</span>
<span class="n">set_char</span><span class="p">(</span><span class="s2">&quot;csname&quot;</span><span class="p">,</span><span class="n">number</span><span class="p">,</span><span class="s2">&quot;global&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>生成指向Lua函数(存在表中)的token，可用<code>lua.get_functions_table</code>来取用。这是<code>\luadef</code>的伴侣。</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">set_lua</span><span class="p">(</span><span class="s2">&quot;mycode&quot;</span><span class="p">,</span><span class="n">id</span><span class="p">)</span>
<span class="n">set_lua</span><span class="p">(</span><span class="s2">&quot;mycode&quot;</span><span class="p">,</span><span class="n">id</span><span class="p">,</span><span class="s2">&quot;global&quot;</span><span class="p">,</span><span class="s2">&quot;protected&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="pdfwhatsit">PDF后端物件（whatsit）<a class="headerlink" href="#pdfwhatsit" title="Permanent link">#</a></h3>
<p>获取位置：pdf.getpos()</p>
<h3 id="fonts">Fonts 字体<a class="headerlink" href="#fonts" title="Permanent link">#</a></h3>
<p>更多细节参看<em>font manual(s)</em></p>
<p>当前字体id/设置当前字体id<code>font.current()</code> <code>fonts.currentid()</code> </p>
<p>当前字体数据 <code>fonts.current()</code></p>
<p>指定id的字体数据 <code>local tfmdata = fonts.identifiers[number]</code></p>
<p>字体数据表如下（有些是下级表的快捷方式）：</p>
<table>
<thead>
<tr>
<th>keys</th>
<th>type</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>ascender</td>
<td>number</td>
<td>the height of a line conforming the font</td>
</tr>
<tr>
<td>descender</td>
<td>number</td>
<td>the depth of a line conforming the font</td>
</tr>
<tr>
<td>italicangle</td>
<td>number</td>
<td>the angle of the italic shapes (if present)</td>
</tr>
<tr>
<td>designsize</td>
<td>number</td>
<td>the design size of the font (if known)</td>
</tr>
<tr>
<td>size</td>
<td>number</td>
<td>the size in scaled points if the font instance</td>
</tr>
<tr>
<td>factor</td>
<td>number</td>
<td>the multiplication factor for unscaled dimensions</td>
</tr>
<tr>
<td>hfactor</td>
<td>number</td>
<td>the horizontal multiplication factor</td>
</tr>
<tr>
<td>vfactor</td>
<td>number</td>
<td>the vertical multiplication factor</td>
</tr>
<tr>
<td>extend</td>
<td>number</td>
<td>the horizontal scaling to be used by the backend</td>
</tr>
<tr>
<td>slant</td>
<td>number</td>
<td>the slanting to be applied by the backend</td>
</tr>
<tr>
<td>characters</td>
<td>table</td>
<td>the scaled character (glyph) information (tfm)</td>
</tr>
<tr>
<td>descriptions</td>
<td>table</td>
<td>未缩放的原始字模信息(otf, afm, tfm)</td>
</tr>
<tr>
<td>indices</td>
<td>table</td>
<td>the mapping from unicode slot to glyph index</td>
</tr>
<tr>
<td>unicodes</td>
<td>table</td>
<td>the mapoing from glyph names to unicode</td>
</tr>
<tr>
<td>marks</td>
<td>table</td>
<td>a hash table with glyphs that are marks as entry</td>
</tr>
<tr>
<td>parameters</td>
<td>table</td>
<td>the font parameters as TEX likes them</td>
</tr>
<tr>
<td>mathconstants</td>
<td>table</td>
<td>the OPENTYPE math parameters</td>
</tr>
<tr>
<td>mathparameters</td>
<td>table</td>
<td>a reference to the MathConstants table</td>
</tr>
<tr>
<td>shared</td>
<td>table</td>
<td>a table with information shared between instances</td>
</tr>
<tr>
<td>unique</td>
<td>table</td>
<td>a table with information unique for this instance</td>
</tr>
<tr>
<td>unscaled</td>
<td>table</td>
<td>the unscaled (intermediate) table</td>
</tr>
<tr>
<td>goodies</td>
<td>table</td>
<td>the CONTEXT specific extra font information</td>
</tr>
<tr>
<td>fonts</td>
<td>table</td>
<td>the table with references to other fonts</td>
</tr>
<tr>
<td>cidinfo</td>
<td>table</td>
<td>a table with special information for the backend</td>
</tr>
<tr>
<td>filename</td>
<td>string</td>
<td>the full path of the loaded font</td>
</tr>
<tr>
<td>fontname</td>
<td>string</td>
<td>the font name as specified in the font (limited in size)</td>
</tr>
<tr>
<td>fullname</td>
<td>string</td>
<td>the complete font name as specified in the font</td>
</tr>
<tr>
<td>name</td>
<td>string</td>
<td>the (short) name of the font</td>
</tr>
<tr>
<td>psname</td>
<td>string</td>
<td>the (unique) name of the font as used by the backend</td>
</tr>
<tr>
<td>hash</td>
<td>string</td>
<td>the hash that makes this instance unique</td>
</tr>
</tbody>
</table>
<p><strong>获取结点的字体名称和字符</strong></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="n">fonts</span><span class="p">.</span><span class="n">hashes</span><span class="p">.</span><span class="n">identifiers</span><span class="p">[</span><span class="n">n</span><span class="p">.</span><span class="n">font</span><span class="p">].</span><span class="n">properties</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span>
    <span class="n">fonts</span><span class="p">.</span><span class="n">hashes</span><span class="p">.</span><span class="n">identifiers</span><span class="p">[</span><span class="n">n</span><span class="p">.</span><span class="n">font</span><span class="p">].</span><span class="n">characters</span><span class="p">[</span><span class="n">n</span><span class="p">.</span><span class="n">char</span><span class="p">].</span><span class="n">tounicode</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="luatex_1">luatex字体常识<a class="headerlink" href="#luatex_1" title="Permanent link">#</a></h3>
<p>见于 <em>Fonts out of ConTEXt: explaining luatex and mkiv</em></p>
<p>在TEX中，字体是抽象的，引擎只关心：</p>
<ul>
<li>字符如何映射到字模 mapping to glyphs</li>
<li>如何以及何时构建合体字 ligature building</li>
<li>每个字模的尺寸  dimensions<ul>
<li>基线 baseline，行内各字模间对齐的位置</li>
<li>高 height，基线上的高度</li>
<li>深 depth，基线下的高度</li>
<li>字间 kerning</li>
</ul>
</li>
</ul>
<p>字模外框（bounding box）的宽度并不是字模定义上的宽度。Type1和OpenType字体(泛指otf、ttf、ttc)每个字模有advance width，这才是所用的宽度。OpenType字体没有高度和深度，需要从外框推导。</p>
<p>LuaTEX因为有旧引擎的包袱，从输入字符到后端字体应用需要经过多重映射；但ConTEXt MkIV使用utf，输入直接映射到字模。</p>
<p>TEX中没有空格，输入的空格会转换成胶 glue。</p>
<p>用户通过语言和脚本（languages and scripts）来控制字体特性。</p>
<p>虚拟字体是使用Lua表来定义的。又因为字体往往比较大，因此预先以Lua表的形式进行缓存处理，在安装新版字体或更新字体加载器时自动更新缓存。在内存中，每个缩放尺寸的字体实例需要单独生成。</p>
<p>定义字体时会定义从字符转换为字模的模式(mode)，四种模式：none，base，node，auto。</p>
<p>LuaTEX构造器的基本/base模式如下：</p>
<ol>
<li>给结点列表断词(加入分割/disc/discretionary结点) hyphenate the node list（传统TEX在分行过程中断词）</li>
<li>构建合字 build ligatures</li>
<li>注入字间 inject kerns</li>
<li>可能要分行 optionally break into lines</li>
</ol>
<p>强制使用基本模式：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c">% 定义base模式，应用ligatures and kerns</span>
<span class="c">% OpenType字体还可应用其他特性</span>
<span class="k">\definefontfeature</span><span class="na">[basemode][mode=base,kern=yes,liga=yes]</span>
<span class="k">\definefont</span><span class="na">[MyTitleFont][SerifBold*basemode at 12pt]</span>
<span class="k">\definedfont</span><span class="na">[Serif*default at 36pt]</span> <span class="c">%定义并立即运用</span>
</code></pre></div></td></tr></table></div>
<p>在结点/Node模式中，引起不处理字间，不构造合字；而是通过Lua巡视结点列表，根据需要处理。</p>
<p>如果无法决断使用何种模式，为安全起见，请全都使用结点/node模式，功能强大，但比较慢。在 ConTEXt中，还可使用自动/auto模式，会自动根据script and language进行分析，决定使用base模式还是node模式。</p>
<p>有时，比如为了呈现字面文本(verbatim)0，可用none模式，不会应用合字、字间和替换。</p>
<p>node模式可以动态地添加、减去、替换、重置：</p>
<ul>
<li>\addfeature</li>
<li>\subtractfeature</li>
<li>\replacefeature</li>
<li>\resetfeature</li>
<li>\feature[more|less|new|local|old|reset][] % 通用命令，双参数</li>
</ul>
<p>分割结点（discretionary nodes）是由断词引擎（hyphenation engine）加入的，或由用户直接加入或通过宏加入。</p>
<p>通常说来，cjk字体比较大，但规则简单（比如无需替换）。cjk脚本比较复杂，但另一方面也是简单的：因为不需要应用特性，所以字体部分是相当闲逸的。因为字模大，信息浓度高，每页的处理时间跟拉丁文字相差不多。<strong>对于大多数cjk，基本模式（Base mode）已经够用。</strong></p>
<p>阿拉伯脚本则相反，需要分析、替换、定位，都是时效最低的。比如用Husayni字体，开启30个特性，平均每个特性5个规则，一个300个字符的段落就要执行45,000个动作。如果是多字体，就更不用说了。</p>
<p>可以定义Lua fonts，使用ConTEXt提供的各种辅助函数。</p>
<p>字体特性（features，如字间、合字）包括字体本身提供的，也包括ConTEXt提供的。</p>
<p>通常通过<code>\definefontfeature</code>定义特性集，再绑定到字体实例，如此来使用特性，而不是显式应用某个具体的特性。</p>
<p>字体信息存储在<code>fonts.hashes</code>中，打印结点n的字符字体包框信息：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">-- 打印结点n的字体描述信息</span>
<span class="kd">local</span> <span class="n">fonthashes</span> <span class="o">=</span> <span class="n">fonts</span><span class="p">.</span><span class="n">hashes</span>
<span class="kd">local</span> <span class="n">font_id_table</span> <span class="o">=</span> <span class="n">fonthashes</span><span class="p">.</span><span class="n">identifiers</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;:::n 包含字符:::&quot;</span><span class="p">,</span> <span class="n">nodes</span><span class="p">.</span><span class="n">toutf</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<span class="c1">-- 打印结点的所有字段信息</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;::::::node.fields(n.id):::::&#39;</span><span class="p">)</span>
<span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="kr">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">fields</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">id</span><span class="p">))</span> <span class="kr">do</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">n</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
<span class="kr">end</span>
<span class="c1">-- 打印结点字模描述信息</span>
<span class="n">desc</span> <span class="o">=</span> <span class="n">font_id_table</span><span class="p">[</span><span class="n">n</span><span class="p">.</span><span class="n">font</span><span class="p">].</span><span class="n">descriptions</span><span class="p">[</span><span class="n">n</span><span class="p">.</span><span class="n">char</span><span class="p">]</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;::::::n.char font desc:::::&#39;</span><span class="p">)</span>
<span class="kr">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="kr">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="kr">do</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
<span class="kr">end</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;:::::BoundingBox:::::&#39;</span><span class="p">)</span>
<span class="kr">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="kr">in</span> <span class="nb">pairs</span> <span class="p">(</span><span class="n">desc</span><span class="p">.</span><span class="n">boundingbox</span><span class="p">)</span> <span class="kr">do</span>
    <span class="c1">-- 以基线左点为原点，依次是x1、y1，x2、y2</span>
    <span class="nb">print</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>
<p><strong>结点n（字符为<code>，</code>，宋体12pt）详情：</strong></p>
<p>:::n 包含字符:::        ，</p>
<p>::::::node.fields(n.id):::::</p>
<ul>
<li>id      28</li>
<li>subtype 32768</li>
<li>attr    &lt;node :    nil &lt;=   1220 =&gt;   1222 : attribute list&gt;</li>
<li>char    65292</li>
<li>font    1 # 字体</li>
<li>language        56</li>
<li>lhmin   2</li>
<li>rhmin   2</li>
<li>uchyph  1</li>
<li>state   0</li>
<li>left    0</li>
<li>right   0</li>
<li>xoffset 0</li>
<li>yoffset 0</li>
<li>xscale  1000 # x标尺</li>
<li>yscale  1000 # y标尺</li>
<li>width   786000 # 字体原始宽度1000的786倍，以下尺寸同理</li>
<li>height  80958 # 高</li>
<li>depth   145410 # 深</li>
<li>total   226368 # 净高（height+depth）</li>
<li>expansion       0</li>
<li>data    0</li>
<li>script  1</li>
<li>hyphenate       499519</li>
<li>options 128</li>
<li>next    &lt;node :   1233 &lt;=    550 =&gt;   1013 : kern userkern&gt;</li>
<li>prev    &lt;node :    684 &lt;=    512 =&gt;   1233 : kern userkern&gt;</li>
</ul>
<p>fonts.hashes.quads[n.font] # 方铅/字框宽度 78600，等于n.width</p>
<p>::::fonts.hashes.identifiers[n.font]字体详情::::</p>
<ul>
<li>parameters      table: 000004431ff4b000  # 处理后的字体参数表<ul>
<li>units   1000 # 每个em的单元数(units_per_em)</li>
<li>factor  786 # 缩放因子/倍数</li>
<li>vfactor 786 # 垂直缩放因子/倍数</li>
<li>hfactor 786  # 高度缩放因子/倍数</li>
<li>quad    786000 # 方铅宽度（descender + ascender; units * hfactor）</li>
<li>descender       157200 # 字模格子的深度</li>
<li>ascender        628800 # 字模格子的高度</li>
<li>size    786432 # 尺寸（？？？）</li>
<li>scaledpoints    786432 # 伸缩后pt</li>
<li>textsize        786432</li>
<li>forcedsize      0</li>
<li>slantfactor     0.0</li>
<li>extrafactor     1</li>
<li>extendfactor    1.0</li>
<li>squeezefactor   1.0</li>
<li>designsize      655360.0</li>
<li>minsize 655360.0</li>
<li>maxsize 655360.0</li>
<li>extraspace      65500.0</li>
<li>spaceshrink     65500.0 # 收缩空（等于左右空白？？？）</li>
<li>spacestretch    98250.0 # 拉伸空 spaceshrink * 1.5</li>
<li>space   196500 # 等于spacestretch * 2</li>
<li>mathsize        0</li>
<li>expansion       table: 0000050c3f0e5dc0</li>
<li>mode    0</li>
<li>xheight 301824 # 小写x高度</li>
<li>slant   0.0</li>
<li>width   0</li>
</ul>
</li>
<li>descriptions    table: 000004431ff4afc0 # 各字模的原始描述表<ul>
<li>65292 # 字符号码，即n.char<ul>
<li>unicode 65292 # 字符号码</li>
<li>index   7629</li>
<li>height  103  # 高</li>
<li>depth   185  # 深</li>
<li>width   1000 # 外框宽度</li>
<li>vheight 1301 # 外框高度</li>
<li>tsb     883  # topsidebearing 上字肩（字上的承条/留空高度）</li>
<li>boundingbox     table: 00000241d041c3c0 # 内框两个顶点(左下、右上)的坐标，原点为基线左端<ul>
<li>1       181 # x1</li>
<li>2       -185 # y1</li>
<li>3       330 # x2</li>
<li>4       103 # y2</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>characters      table: 000004431ff4af80<ul>
<li>所包含的各字符</li>
</ul>
</li>
<li>specification   table: 000004431b506ec0<ul>
<li>hash    stsong @  @ unknown</li>
<li>cs      3&gt;mschinese-12pt-rm-tf-0--0</li>
<li>forcedname      stsong.ttf</li>
<li>method  *</li>
<li>global  true</li>
<li>mathsize        0</li>
<li>scalemode       2</li>
<li>detail  chinese</li>
<li>source  ttf # 字体源格式</li>
<li>id      1</li>
<li>size    786432</li>
<li>name    stsong # 字体名称</li>
<li>filename        c:/windows/fonts/stsong.ttf</li>
<li>goodies</li>
<li>lookup  file</li>
<li>features        table: 000002c736ce6600</li>
<li>specification   Serif sa 1</li>
<li>sub</li>
<li>resolved</li>
<li>forced  ttf</li>
<li>textsize        786432</li>
</ul>
</li>
<li>properties      table: 000004431ff4b080<ul>
<li>finalized       true</li>
<li>hasmath false</li>
<li>fontname        STSong</li>
<li>privates        table: 000003c60ece5480</li>
<li>psname  STSong</li>
<li>hash    stsong @  @ unknown @ 786432</li>
<li>id      1</li>
<li>format  truetype</li>
<li>language        dflt</li>
<li>writingmode     horizontal</li>
<li>mode    base</li>
<li>filename        c:/windows/fonts/stsong.ttf # 字体文件名</li>
<li>name    stsong</li>
<li>subfont 1</li>
<li>script  dflt</li>
<li>fullname        STSong-2</li>
</ul>
</li>
<li>shared  table: 000004431ff4ad80<ul>
<li>rawdata table: 00000549d5478d80</li>
<li>features        table: 00000549d734ad40</li>
<li>processes       table: 00000549d734af00</li>
<li>dynamics        table: 00000549d734adc0</li>
</ul>
</li>
<li>original        Serif sa 1</li>
<li>fonts   table: 00000443200e5340<ul>
<li>1       table: 00000234148e5380</li>
</ul>
</li>
<li>writingmode     horizontal</li>
<li>resources       table: 000004431c343980<ul>
<li>features        table: 00000206d5724440</li>
<li>classes table: 00000206d56a1f00</li>
<li>foundtables     table: 00000206d5724540</li>
<li>private 983040</li>
<li>marks   table: 00000206d57246c0</li>
<li>alreadydone     table: 00000206d4bab500</li>
<li>sublookups      table: 00000206d5724a80</li>
<li>filename        c:/windows/fonts/stsong.ttf</li>
<li>foundfilename   c:/windows/fonts/stsong.ttf</li>
<li>marksets        table: 00000206d5724700</li>
<li>version Version 1.02</li>
<li>sequences       table: 00000206d5724740</li>
<li>unicodes        table: 00000206d5724b00</li>
<li>duplicates      table: 00000206d5724400</li>
<li>markclasses     table: 00000206d5724680</li>
</ul>
</li>
<li>unscaled        table: 000004431ff4ad00<ul>
<li>characters      table: 0000030837362a00</li>
<li>cache_version   1.01</li>
<li>resources       table: 0000030838843a40</li>
<li>changed table: 000003083bb49d00</li>
<li>properties      table: 00000308373627c0</li>
<li>descriptions    table: 0000030837362840</li>
<li>parameters      table: 0000030837362a40</li>
<li>shared  table: 000003083bb49c80</li>
<li>goodies table: 0000030837362900</li>
<li>mathparameters  table: 0000030837362a80</li>
</ul>
</li>
<li>goodies table: 000004431ce15f80<ul>
<li>空</li>
</ul>
</li>
</ul>
<p><strong>合字（略）</strong></p>
<p><strong>Goodies（略）</strong></p>
<p><strong>Tracing</strong></p>
<p>缺失字符时跟踪信息：</p>
<ul>
<li>\enabletrackers[fonts.missing=replace]</li>
<li>\enabletrackers[fonts.missing=remove]</li>
<li>\enabletrackers[fonts.missing]</li>
</ul>
<p><strong>拼字Composing（略）</strong></p>
<h3 id="lua_1">执行lua代码<a class="headerlink" href="#lua_1" title="Permanent link">#</a></h3>
<p><strong>代码使用方式</strong></p>
<ul>
<li>行内代码</li>
<li>用\catcode、dofile()引入代码文件</li>
</ul>
<p><strong>代码入口基元</strong></p>
<ul>
<li><code>\directlua{tex.print("Hi there")}</code></li>
<li><code>\latelua{}</code></li>
<li><code>\lateluafunction{}</code></li>
<li><code>\luaescapestring{}</code></li>
</ul>
<p><strong>引用函数表与定义表：</strong></p>
<ul>
<li><code>\luafunction</code></li>
<li><code>\luafunctioncall</code></li>
<li><code>\luadef</code></li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\directlua</span> <span class="nb">{</span>
    local t = lua.get<span class="nb">_</span>functions<span class="nb">_</span>table()
    t[1] = function() tex.print(&quot;!&quot;) end
    t[2] = function() tex.print(&quot;?&quot;) end
<span class="nb">}</span>
<span class="k">\luafunction</span>1
<span class="k">\luafunction</span>2
</code></pre></div></td></tr></table></div>
<p><strong><code>\luabytecode</code> and <code>\luabytecodecall</code></strong></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\directlua</span> <span class="nb">{</span>
    lua.bytecode[9998] = function(s)
    tex.sprint(s*token.scan<span class="nb">_</span>int())
    end
    lua.bytecode[5555] = function(s)
    tex.sprint(s*token.scan<span class="nb">_</span>dimen())
    end
<span class="nb">}</span>


<span class="k">\luabytecode</span> 9998 5
<span class="k">\luabytecode</span> 5555 5sp
<span class="k">\luabytecodecall</span>9998 5
<span class="k">\luabytecodecall</span>5555 5sp
</code></pre></div></td></tr></table></div>
<h3 id="directlua">预先展开：\directlua代码执行机制<a class="headerlink" href="#directlua" title="Permanent link">#</a></h3>
<ul>
<li>category codes and TeX tokens: converting text to tokens and tokens to text;</li>
</ul>
<p><img alt="category codes and TeX tokens" src="https://images.ctfassets.net/nrgyaltdicpt/2FW0xuwip1z4jlSnBrUYl/5c4c9a4bf893bda2a2f36b14eb8df4b4/list_schematic--plain.svg" /></p>
<ul>
<li>TeX’s expansion process (and preventing expansion);</li>
</ul>
<p><img alt="TeX’s expansion process" src="https://images.ctfassets.net/nrgyaltdicpt/1aq6zBld5wwFynP0UDXNm9/6c8134952ff14e7eacf82606bfa448eb/processing_code--minimal--plain.svg" /></p>
<p><strong>LuaTeX引擎会把代码预先交由TeX展开/求值，结果文本再作为lua代码交给lua引擎解释</strong></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\def\aa</span><span class="nb">{</span>tex<span class="nb">}</span>
<span class="k">\def\bb</span><span class="nb">{</span>.<span class="nb">}</span>
<span class="k">\def\cc</span><span class="nb">{</span>print<span class="nb">}</span>
<span class="k">\def\dd</span><span class="nb">{</span>(&quot;Hello&quot;)<span class="nb">}</span>
<span class="k">\directlua</span><span class="nb">{</span>
    <span class="k">\aa\bb\cc\dd</span>
<span class="nb">}</span>
<span class="c">% 等价于</span>
<span class="k">\directlua</span><span class="nb">{</span>tex.print(&quot;Hello&quot;)<span class="nb">}</span>
</code></pre></div></td></tr></table></div>
<p><strong>展开实际上是LuaTeX的一个API，即Lua与TeX交换数据的方式</strong></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\count</span>75=1564 <span class="c">% TeX世界中的数据</span>
<span class="k">\directlua</span><span class="nb">{</span>
    local x=<span class="k">\number\count</span>75 <span class="k">\space</span> <span class="c">% 等号右边会展开，即把TeX数据传给Lua；\space是输入空格的命令，也可以省略</span>
    tex.print(&quot;x= &quot;..x)
    local y = (2*x-65)/5
    tex.print(&quot; and y = &quot;..y)
<span class="nb">}</span>
</code></pre></div></td></tr></table></div>
<p>展开会生成的Lua代码：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">local</span> <span class="n">x</span><span class="o">=</span><span class="mi">1564</span> <span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;x= &quot;</span><span class="o">..</span><span class="n">x</span><span class="p">)</span> <span class="kd">local</span> <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="mi">65</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span> <span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; and y = &quot;</span><span class="o">..</span><span class="n">y</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>在控制台打印：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\directlua</span><span class="nb">{</span>
    local foo=[-[local x=<span class="k">\number\count</span>75
    tex.print(&quot;x= &quot;..x)
    local y = (2*x-65)/5
    tex.print(&quot; and y = &quot;..y)]-]
    print(foo)
<span class="nb">}</span>
</code></pre></div></td></tr></table></div>
<p>Overleaf的控制台打印用<code>texio.write(foo)</code></p>
<h3 id="directluascan_tokstoken">\directlua预处理（scan_toks()）中不展开的权标（token）<a class="headerlink" href="#directluascan_tokstoken" title="Permanent link">#</a></h3>
<ul>
<li><strong>速记命令权标/shorthand command tokens</strong>: 此类命令权标源于用TeX基元\chardef, \mathchardef, \countdef, \dimendef, \skipdef, \muskipdef, \toksdef所定义的控制序列（下表的command，表示数值）：<ul>
<li>\chardef ⟨command⟩ = ⟨numeric value⟩</li>
<li>\mathchardef ⟨command⟩ = ⟨numeric value⟩</li>
<li>\countdef ⟨command⟩ = ⟨numeric value⟩</li>
<li>\dimendef ⟨command⟩ = ⟨numeric value⟩</li>
<li>\skipdef ⟨command⟩ = ⟨numeric value⟩</li>
<li>\muskipdef ⟨command⟩ = ⟨numeric value⟩</li>
<li>\toksdef ⟨command⟩ = ⟨numeric value⟩</li>
</ul>
</li>
<li><strong>不展开的权标</strong>: 此类命令权标源于会展开的命令，但\directlua已经对它们:<ul>
<li>显式指令不予展开，比如<code>\noexpand</code>或<code>\unexpanded</code>命令压制展开。</li>
<li>通过处理序列予以注入权标，如<code>\the\toks</code>等。</li>
</ul>
</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\chardef\mydollar</span>=`<span class="k">\$</span> 
<span class="k">\directlua</span><span class="nb">{</span>
    local x =[-[I paid <span class="k">\mydollar</span>30.]-] 
    texio.write(x)
<span class="nb">}</span>
<span class="c">% I paid \mydollar 30</span>
</code></pre></div></td></tr></table></div>
<p><strong>注意：</strong> TeX中的<code>\%, \&amp;, \#, \$</code>是用\chardef定义的，因此不可展开：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\chardef\#</span>=`<span class="k">\#</span>
<span class="k">\chardef\$</span>=`<span class="k">\$</span>
<span class="k">\chardef\%</span>=`<span class="k">\%</span>
<span class="k">\chardef\&amp;</span>=`<span class="k">\&amp;</span>
<span class="c">% I paid \mydollar 30</span>
</code></pre></div></td></tr></table></div>
<p><code>`\</code>表示取得其后代码值的数字字符。但在LaTeX中这些都是宏，可展开。</p>
<h3 id="lua_2">避免lua代码展开导致的问题<a class="headerlink" href="#lua_2" title="Permanent link">#</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c">% TeX宏会吞掉后面的空格</span>
<span class="k">\directlua</span><span class="nb">{</span>
    myvar = <span class="k">\macro</span>
  anothervar = 2
<span class="nb">}</span>
<span class="c">% 得到`yvar = 1anothervar = 2`</span>

<span class="c">% Lua注释的短路问题</span>
<span class="k">\directlua</span><span class="nb">{</span>
  myvar = 1
--  anothervar = 2
  onelastvar = 3
<span class="nb">}</span>
<span class="c">% 得到`myvar = 1 -- anothervar = 2 onelastvar = 3`</span>
<span class="c">% 导致注释后的所有行无效</span>

<span class="c">% 以上续行问题可以用 `\endlinechar=10` 重新定义换行符</span>
</code></pre></div></td></tr></table></div>
<p><a href="http://wiki.luatex.org/index.php/Writing_Lua_in_TeX">更多</a></p>
<ul>
<li><code>\noexpand⟨token⟩</code>: 阻止单个⟨token⟩展开;</li>
<li><code>\unexpanded{⟨material⟩}</code>: 阻止所有权标展开;</li>
<li><code>\protected</code>: 宏定义前缀，阻止宏在某些环境，如\directlua, \write, \edef中展开。</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\directlua</span><span class="nb">{</span>local x= &quot;<span class="k">\noexpand\TeX</span>&quot;<span class="nb">}</span>
<span class="c">% 传给Lua的是：</span>
<span class="c">% local x= &quot;\TeX &quot;</span>
<span class="c">% **空格是\directlua的tokenlist_to_cstring()生成的**</span>

<span class="k">\def\macroA</span><span class="nb">{</span>&quot;This unprotected macro contains a string&quot;<span class="nb">}</span>
<span class="k">\protected\def\macroB</span><span class="nb">{</span>&quot;This protected macro also contains a string&quot;<span class="nb">}</span>
<span class="k">\directlua</span><span class="nb">{</span>
    local x=<span class="k">\macroA</span>..<span class="k">\macroB</span>
<span class="nb">}</span>
<span class="c">% local x=&quot;This unprotected macro contains a string&quot;..\macroB</span>

<span class="k">\let\\\relax</span> <span class="c">%重定义\\的意义以避免展开问题</span>
</code></pre></div></td></tr></table></div>
<h3 id="directluathetoks">\directlua中的\the\toks<a class="headerlink" href="#directluathetoks" title="Permanent link">#</a></h3>
<p><code>\toks</code>指向权标寄存器暂存的权标列表，列表是原样保存的，用<code>\the\toks</code>插入前不会预先展开。</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\def\mymacro</span><span class="nb">{</span><span class="k">\TeX</span><span class="nb">}</span>
<span class="k">\directlua</span><span class="nb">{</span>
    local x=&quot;<span class="k">\mymacro</span>&quot;
<span class="nb">}</span>
<span class="c">% 得到：</span>
<span class="c">% local x = &quot;T\kern -.1667em\lower .5ex\hbox {E}\kern -.125emX&quot;</span>

<span class="k">\toks</span>100=<span class="nb">{</span><span class="k">\TeX</span><span class="nb">}</span>
<span class="k">\directlua</span><span class="nb">{</span>
    local x=&quot;<span class="k">\the\toks</span>100&quot;
<span class="nb">}</span>
<span class="c">% 得到：</span>
<span class="c">% local x = &quot;\TeX &quot;</span>
</code></pre></div></td></tr></table></div>
<h3 id="_21">其他展开技术<a class="headerlink" href="#_21" title="Permanent link">#</a></h3>
<ul>
<li><code>\string</code></li>
<li><code>\detokenize{}</code>, <code>\string</code>的多权标版本</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\directlua</span><span class="nb">{</span>
    local x=&quot;I will use <span class="k">\string\newcommand</span>&quot; 
    print(x)
<span class="nb">}</span>
<span class="c">% 有转义问题：</span>
<span class="c">% local x=&quot;I will use \newcommand&quot; print(x)</span>
<span class="c">% I will use</span>
<span class="c">% ewcommand</span>
</code></pre></div></td></tr></table></div>
<h3 id="lua_3">Lua转义序列<a class="headerlink" href="#lua_3" title="Permanent link">#</a></h3>
<ul>
<li>标准序列：<code>\n</code> (newline), <code>\r</code> (carriage return), <code>\\</code> (backslash), <code>\"</code> (double quote), <code>\t</code> (horizontal tab), <code>\v</code> (vertical tab) and <code>\'</code> (single quote);</li>
<li>\xXX, XX是十六进制数;</li>
<li>\ddd, where ddd is a sequence of up to three decimal digits;</li>
<li>\u{XXX}，用十六进制数表述的UTF-8字符</li>
</ul>
<p><strong>长括号来救急：</strong></p>
<ul>
<li>"this is a string.\nI'll now start on a new line."</li>
<li>长括号文本不会转义： [-[I am a long brackets\n string]-]</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\protected\def\newtest</span>#1<span class="nb">{</span>The argument: #1<span class="nb">}</span>
<span class="k">\directlua</span><span class="nb">{</span>
    tex.print([-[<span class="k">\newtest</span><span class="nb">{</span>Hello<span class="nb">}</span>]-])
<span class="nb">}</span>
<span class="c">% The argument: Hello</span>
</code></pre></div></td></tr></table></div>
<h3 id="_22">以页面为单位的信息收集与统计<a class="headerlink" href="#_22" title="Permanent link">#</a></h3>
<ol>
<li>通过标签与实际页码的关系确定信息位置 <strong>（需要多次编译才准确，并注意核对）</strong></li>
<li>通过页面引用取得页码，不能使用<strong>在文档中不准确的\thepage</strong></li>
<li>通过\refcount宏包的可展开命令\getrefnumber, \getpagerefnumber取得页码等可操作的数据，而不是通过\pageref（无法展开，仅文档中呈现，而无法作为值保存、处理）</li>
<li>埋设标签和收集信息可以包装成一个命令 <strong>（不能双重包装）</strong></li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\documentclass</span><span class="na">[a4paper]</span><span class="nb">{</span>ctexrep<span class="nb">}</span><span class="c">%</span>

<span class="c">% 在页眉页脚中通过\thepage过滤、使用表中数据</span>
<span class="k">\usepackage</span><span class="nb">{</span>fancyhdr<span class="nb">}</span>
<span class="k">\fancyfoot</span><span class="na">[C]</span><span class="nb">{</span>
    第<span class="k">\thepage</span><span class="nb">{}</span>页共<span class="c">%</span>
    <span class="k">\directlua</span><span class="nb">{</span><span class="c">%</span>
        sum = t[<span class="k">\thepage</span>] or &quot;？？&quot; <span class="c">% 设置默认值方便核对</span>
        tex.print(sum) <span class="c">%</span>
    <span class="nb">}</span><span class="c">%</span>
    题，做对<span class="k">\_\_\_\_</span>题<span class="c">%</span>
<span class="nb">}</span> <span class="c">%</span>
<span class="k">\pagestyle</span><span class="nb">{</span>fancy<span class="nb">}</span> <span class="c">% 应用页面样式</span>
<span class="c">%</span>
<span class="k">\usepackage</span><span class="nb">{</span>refcount<span class="nb">}</span><span class="c">%</span>
<span class="k">\setrefcountdefault</span><span class="nb">{</span>??<span class="nb">}</span> <span class="c">% 未定义标签的默认值，方便核对</span>
<span class="c">% 定义表、计数器</span>
<span class="k">\directlua</span><span class="nb">{</span> t = <span class="nb">{}</span> <span class="nb">}</span>
<span class="c">%</span>
<span class="c">% 按页的标签计数</span>
<span class="k">\newcommand*</span><span class="nb">{</span><span class="k">\countup</span><span class="nb">}</span>[1]<span class="nb">{</span>
    <span class="k">\directlua</span><span class="nb">{</span>
        t[#1] = t[#1] or 0;
        t[#1] = t[#1] + 1;
    <span class="nb">}</span><span class="c">%</span>
<span class="nb">}</span>
<span class="c">%</span>
<span class="k">\begin</span><span class="nb">{</span>document<span class="nb">}</span><span class="c">%</span>

<span class="c">% 标签一般埋设在特定类别的条目，在一般文本行首、末可能会出错？？？？</span>
这里有标签 <span class="k">\label</span><span class="nb">{</span> 1 <span class="nb">}</span> 标签所在页码： <span class="k">\getpagerefnumber</span><span class="nb">{</span> 1 <span class="nb">}</span> 或 <span class="k">\pageref</span><span class="nb">{</span> 1 <span class="nb">}</span><span class="c">%</span>

<span class="c">% 收集  标签id，存入表中键值为页码的单元</span>
<span class="k">\directlua</span><span class="nb">{</span>t[<span class="k">\getpagerefnumber</span><span class="nb">{</span> 1 <span class="nb">}</span>] = t[<span class="k">\getpagerefnumber</span><span class="nb">{</span> 1 <span class="nb">}</span>] or 0; t[<span class="k">\getpagerefnumber</span><span class="nb">{</span> 1 <span class="nb">}</span>] = t[<span class="k">\getpagerefnumber</span><span class="nb">{</span> 1 <span class="nb">}</span>] + 1 <span class="nb">}</span><span class="c">%</span>
<span class="c">% pylatex代码：</span>
<span class="c">% doc.append(NoEscape(fr&#39;&#39;&#39;\directlua{{</span>
<span class="c">%     t[\getpagerefnumber{{ {label_id} }}] = t[\getpagerefnumber{{ {label_id} }}] or 0;</span>
<span class="c">%     t[\getpagerefnumber{{ {label_id} }}] = t[\getpagerefnumber{{ {label_id} }}] + 1;</span>
<span class="c">%     }}&#39;&#39;&#39;))</span>

<span class="c">% 或包装成命令（不能装入\getpagerefnumber形成多重包装）</span>
<span class="c">% \countup{ \getpagerefnumber{ 1 } }%</span>
<span class="c">% pylatex代码：</span>
<span class="c">% doc.append(NoEscape(fr&quot;\countup{{ \getpagerefnumber{{ {label_id} }} }}&quot;))</span>

<span class="k">\par</span><span class="c">%</span>

<span class="k">\end</span><span class="nb">{</span>document<span class="nb">}</span><span class="c">%</span>
</code></pre></div></td></tr></table></div>
<p><strong>\directlua包装成\command时要避免多重嵌套。</strong>
\command\directlua\command双重包装会引起第三遍编译（pdf能观察到）：
第一遍编译，因引用变动而引起第二遍编译，此时正确取数；
但是又意外地引发第三次编译，无法取数，如下：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\newcommand*</span><span class="nb">{</span><span class="k">\countup</span><span class="nb">}</span>[1]<span class="nb">{</span>
    <span class="c">% 以下lua包装可以直接放在文档中，但不能再包装成命令</span>
    <span class="k">\directlua</span><span class="nb">{</span>
        t[<span class="k">\getpagerefnumber</span><span class="nb">{</span> #1 <span class="nb">}</span>] = t[<span class="k">\getpagerefnumber</span><span class="nb">{</span> #1 <span class="nb">}</span>] or 0;
        t[<span class="k">\getpagerefnumber</span><span class="nb">{</span> #1 <span class="nb">}</span>] = t[<span class="k">\getpagerefnumber</span><span class="nb">{</span> #1 <span class="nb">}</span>] + 1;
    <span class="nb">}</span><span class="c">%</span>
<span class="nb">}</span>
<span class="c">% 这样使用</span>
<span class="k">\countup</span><span class="nb">{</span> 1 <span class="nb">}</span><span class="c">%</span>
</code></pre></div></td></tr></table></div>
<p>可以这样：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\newcommand*</span><span class="nb">{</span><span class="k">\countup</span><span class="nb">}</span>[1]<span class="nb">{</span>
    <span class="k">\directlua</span><span class="nb">{</span>
        t[#1] = t[#1] or 0;
        t[#1] = t[#1] + 1;
    <span class="nb">}</span><span class="c">%</span>
<span class="nb">}</span>
<span class="c">% 这样使用：</span>
<span class="k">\countup</span><span class="nb">{</span> <span class="k">\getpagerefnumber</span><span class="nb">{</span> 1 <span class="nb">}</span> <span class="nb">}</span><span class="c">%</span>
</code></pre></div></td></tr></table></div>
<h4 id="_23">不可能在主文件中精确引用页码计数器<a class="headerlink" href="#_23" title="Permanent link">#</a></h4>
<p><strong>vid Carlisle：你几乎不可能在主文件中精确引用页码计数器（page counter），只有在输出进程（output routine，此时输出页面）中才能精确地知道。Luatex没有改变TeX的这种基本模式。</strong></p>
<p>可以通过埋设标签的方式实现，每处用一个\label{id}关联，第二轮运行时就可以通过\pageref{id}从Lua或TeX引用。</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\documentclass</span><span class="nb">{</span>article<span class="nb">}</span>
<span class="k">\directlua</span><span class="nb">{</span>j=0<span class="nb">}</span>
<span class="k">\newcommand\printluapage</span><span class="nb">{</span><span class="c">%</span>
    <span class="k">\directlua</span><span class="nb">{</span>
       for i = 1, 60 do
         j=j+1
         tex.print(&#39;<span class="k">\string\\</span>pageref<span class="nb">{</span>foo&#39; .. j .. &#39;<span class="nb">}</span>  <span class="k">\string\\</span>label<span class="nb">{</span>foo&#39; .. j .. &#39;<span class="nb">}</span>&#39;) 
         tex.print([-[<span class="k">\par</span>]-])
       end
       <span class="nb">}</span><span class="c">%</span>
<span class="nb">}</span>

<span class="k">\begin</span><span class="nb">{</span>document<span class="nb">}</span>
<span class="k">\printluapage</span>

New command

<span class="k">\printluapage</span>

New command

<span class="k">\printluapage</span>
<span class="k">\end</span><span class="nb">{</span>document<span class="nb">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="_24">标点压缩临时方案<a class="headerlink" href="#_24" title="Permanent link">#</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\usepackage</span><span class="nb">{</span>luacode<span class="nb">}</span>
<span class="c">%%% 消除中文問號及驚嘆號後面多餘的空白。</span>
<span class="k">\def\exsp</span>#1<span class="nb">{</span><span class="k">\unskip</span>#1<span class="k">\hspace</span><span class="nb">{</span>0em<span class="nb">}}</span>
<span class="k">\begin</span><span class="nb">{</span>luacode<span class="nb">}</span>
function dosub(s)
    s = string.gsub(s, &#39;！&#39;, &#39;<span class="k">\\</span>exsp！&#39;)
    s = string.gsub(s, &#39;？&#39;, &#39;<span class="k">\\</span>exsp？&#39;)
    return(s)
end
<span class="k">\end</span><span class="nb">{</span>luacode<span class="nb">}</span>
<span class="c">% 对输入调用查找替换</span>
<span class="k">\AtBeginDocument</span><span class="nb">{</span><span class="c">%</span>
    <span class="k">\luaexec</span><span class="nb">{</span>luatexbase.add<span class="nb">_</span>to<span class="nb">_</span>callback(&quot;process<span class="nb">_</span>input<span class="nb">_</span>buffer&quot;, dosub, &quot;dosub&quot;)<span class="nb">}</span><span class="c">%</span>
<span class="nb">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="_25">速度问题<a class="headerlink" href="#_25" title="Permanent link">#</a></h3>
<p><strong>使用本地变量而不是原始名字：</strong></p>
<p>nodetraverseid = node.traverse_id</p>
<p><a href="https://news.ycombinator.com/item?id=15150356"><strong>如果少一些LaTeX/宏展开，多一些lua，会快得多</strong></a></p>
<p>by svat on Sept 1, 2017</p>
<p>The book A Gentle Introduction to TeX is 97 pages long (number of pages in the output). To produce the typeset output from <code>gentle.tex</code>, on my laptop,</p>
<ul>
<li>tex takes 0.15 seconds</li>
<li>pdftex takes 0.37 seconds</li>
<li>luatex (1.0.4) takes 0.46 seconds</li>
</ul>
<p>All of these are reasonably fast, and I think getting a full book in less than half a second is acceptable. (My browser takes longer than that to render most things.)</p>
<p><strong>What's the catch? This book is written in plain TeX. The slowness comes when you use LaTeX:</strong> it's not unusual to have even single-page documents that take longer for LaTeX to generate. The whole LaTeX approach is to have a package for everything, load everything you may want, providing all the features, etc — and all of this implemented in TeX macro expansion in painful and hard-to-refactor ways.</p>
<p>This is something LuaTeX will help with actually: LuaTeX makes TeX less monolithic by providing hooks (callbacks), and many things can now be implemented in easier-to-read Lua code as hooks into the right parts of TeX's execution, rather than setting everything up at the start so that after macros are expanded the right thing happens. If there's less use of LaTeX and elaborate macros, things should get faster.</p>
<h3 id="tex_without_tex_revised_and_expanded"><a href="http://wiki.luatex.org/index.php/TeX_without_TeX_revised_and_expanded">TeX_without_TeX_revised_and_expanded</a><a class="headerlink" href="#tex_without_tex_revised_and_expanded" title="Permanent link">#</a></h3>
<h2 id="luametatexlmtx">LuaMetaTEX（LMTX）<a class="headerlink" href="#luametatexlmtx" title="Permanent link">#</a></h2>
<p>本部分主要学习：<em>LuaMetaTEX Reference Manual</em></p>
<h3 id="_26">引言<a class="headerlink" href="#_26" title="Permanent link">#</a></h3>
<p>参见见官网<a href="https://wiki.contextgarden.net/LMTX">LMTX</a></p>
<p>LuaMetaTEX是更精瘦和干练的(leaner and meaner)LuaTEX，移除了大量的部件和依赖。主要为ConTeXt所用，可以说是新版的ConTeXt。目前兼容LuaTEX。</p>
<p>LuaMetaTeX（lmtx）引擎整合了TEX文本渲染引擎、MetaPost图形引擎和Lua脚本解释器，或可联想Lua, MetaPost, TeX, XML。LuaMetaTeX是主要为ConTeXt创建的引擎，基于并兼容LuaTeX，而有优化：</p>
<ul>
<li>除了三个核心libc和libm运行时外，没有外部依赖。</li>
<li>没有PDF后端代码，而由ConTeXt的Lua代码生成pdf。</li>
<li>没有字体加载器lua界面库，(OpenType)字体加载由ConTeXt的Lua代码处理。</li>
<li>没有(poppler-based)图像和pdf文件的lua界面库(后者用epdf代替)</li>
<li>各种扩展已经做成lua界面库</li>
</ul>
<p>需要安装最新的ConTeXt实现<a href="http://www.pragma-ade.com/install.htm">CONTEXT LMTX</a>（ConTeXt Minimals &gt; ConTeXt Standalone &gt; LMTX），<strong>很慢。在看到下载压缩包的时候，可以用下载工具手动下载，解压到相应的位置，再重启安装程序。重新安装即可更新到最新版。</strong> 预计TeX Live 2022中会加入LuaMetaTeX。</p>
<p>安装包中的设置系统路径的工具<code>setpath.bat</code>似乎无效，需要手动设置。</p>
<p>查看版本：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>context<span class="w"> </span>--version<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>luametatex<span class="w"> </span>--version
</code></pre></div></td></tr></table></div>
<p>编译时，<code>context test.mkiv</code> 默认使用LuaMetaTeX。可指定使用luatex： <code>context --luatex test.mkiv</code></p>
<h3 id="_27">字体<a class="headerlink" href="#_27" title="Permanent link">#</a></h3>
<p>给前端传送字体时只是传送尺寸。</p>
<p>与LuaTEX不同，LuaMetaTeX没有内建后端，所以不使用虚拟字体信息。</p>
<p>对于Lua代码来说，所有字体都表示为表（table），内部则是C结构；包含如下键：</p>
<table>
<thead>
<tr>
<th>KEY</th>
<th>VALUE TYPE</th>
<th>DESCRIPTION</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>string</td>
<td>度量 (文件) 名称</td>
</tr>
<tr>
<td>original</td>
<td>string</td>
<td>日志和反馈中使用的名字</td>
</tr>
<tr>
<td>designsize</td>
<td>number</td>
<td>期望的尺寸 (默认: 655360 == 10pt)</td>
</tr>
<tr>
<td>size</td>
<td>number</td>
<td>要求的缩放 (默认同 designsize)</td>
</tr>
<tr>
<td>characters</td>
<td>table</td>
<td>本字体定义的字模</td>
</tr>
<tr>
<td>fonts</td>
<td>table</td>
<td>本地使用的字体</td>
</tr>
<tr>
<td>parameters</td>
<td>hash</td>
<td>默认7个参数均为0</td>
</tr>
<tr>
<td>stretch</td>
<td>number</td>
<td>the ‘stretch’</td>
</tr>
<tr>
<td>shrink</td>
<td>number</td>
<td>the ‘shrink’</td>
</tr>
<tr>
<td>step</td>
<td>number</td>
<td>the ‘step’</td>
</tr>
<tr>
<td>textcontrol</td>
<td>bitset</td>
<td>this controls various code paths in the text engine</td>
</tr>
<tr>
<td>hyphenchar</td>
<td>number</td>
<td>默认: TEX's \hyphenchar</td>
</tr>
<tr>
<td>skewchar</td>
<td>number</td>
<td>默认: TEX's \skewchar</td>
</tr>
<tr>
<td>nomath</td>
<td>boolean</td>
<td>this key allows a minor speedup for text fonts; if it is present and true, then LuaTEX will not check the charac­ter entries for math-specific keys</td>
</tr>
<tr>
<td>oldmath</td>
<td>boolean</td>
<td>this key flags a font as representing an old school TEX math font and disables the OpenType code path</td>
</tr>
<tr>
<td>mathcontrol</td>
<td>bitset</td>
<td>this controls various code paths in the math engine, like enforcing the traditional code path</td>
</tr>
<tr>
<td>compactmath</td>
<td>boolean</td>
<td>experimental: use the smaller chain to locate a character</td>
</tr>
<tr>
<td>textscale</td>
<td>number</td>
<td>数学文本中的缩放</td>
</tr>
<tr>
<td>scriptscale</td>
<td>number</td>
<td>数学脚本中的缩放</td>
</tr>
<tr>
<td>scriptscriptscale</td>
<td>number</td>
<td>数学脚本的缩放脚本</td>
</tr>
</tbody>
</table>
<p>其中，parameters是哈希表，但包含7个便捷索引：slant, space, spacestretch, spaceshrink, xheight（小写x高度）, quad(方铅宽度，即em), extraspace。比如，通过结点字体（n.font）这样取得最终属性：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">fonts</span><span class="p">.</span><span class="n">hashes</span><span class="p">.</span><span class="n">identifiers</span><span class="p">[</span><span class="n">n</span><span class="p">.</span><span class="n">font</span><span class="p">].</span><span class="n">parameters</span><span class="p">.</span><span class="n">xheight</span>
</code></pre></div></td></tr></table></div>
<p>其中，characters表（字体定义的字模），整数键，字模结点的字符代码会引用这些键。包括如下键：</p>
<table>
<thead>
<tr>
<th>KEY</th>
<th>TYPE</th>
<th>DESCRIPTION</th>
</tr>
</thead>
<tbody>
<tr>
<td>width</td>
<td>number</td>
<td>width in sp (default 0)</td>
</tr>
<tr>
<td>height</td>
<td>number</td>
<td>height in sp (default 0)</td>
</tr>
<tr>
<td>depth</td>
<td>number</td>
<td>depth in sp (default 0)</td>
</tr>
<tr>
<td>italic</td>
<td>number</td>
<td>italic correction in sp (default 0)</td>
</tr>
<tr>
<td>topaccent</td>
<td>number</td>
<td>top accent alignment place in sp (default zero)</td>
</tr>
<tr>
<td>botaccent</td>
<td>number</td>
<td>bottom accent alignment place, in sp (default zero)</td>
</tr>
<tr>
<td>leftprotruding</td>
<td>number</td>
<td>left protruding factor (\lpcode)</td>
</tr>
<tr>
<td>rightprotruding</td>
<td>number</td>
<td>right protruding factor (\rpcode)</td>
</tr>
<tr>
<td>expansion</td>
<td>number</td>
<td>expansion factor (\efcode)</td>
</tr>
<tr>
<td>next</td>
<td>number</td>
<td>‘next larger’ character index</td>
</tr>
<tr>
<td>extensible</td>
<td>table</td>
<td>constituent parts of an extensible recipe</td>
</tr>
<tr>
<td>vvariants</td>
<td>table</td>
<td>constituent parts of a vertical variant set</td>
</tr>
<tr>
<td>hvariants</td>
<td>table</td>
<td>constituent parts of a horizontal variant set</td>
</tr>
<tr>
<td>kerns</td>
<td>table</td>
<td>kerning information</td>
</tr>
<tr>
<td>ligatures</td>
<td>table</td>
<td>ligaturing information</td>
</tr>
<tr>
<td>mathkern</td>
<td>table</td>
<td>math cut-in specifications</td>
</tr>
<tr>
<td>smaller</td>
<td>number</td>
<td>the next smaller math size character</td>
</tr>
</tbody>
</table>
<p>比如字符‘f’(整数102)在字体cmr10中，10pt时（缩放后的尺寸）：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">[</span><span class="mi">102</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span>    <span class="o">=</span> <span class="mi">200250</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">455111</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;italic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50973</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;kerns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">[</span><span class="mi">63</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50973</span><span class="p">,</span>
        <span class="p">[</span><span class="mi">93</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50973</span><span class="p">,</span>
        <span class="p">[</span><span class="mi">39</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50973</span><span class="p">,</span>
        <span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50973</span><span class="p">,</span>
        <span class="p">[</span><span class="mi">41</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50973</span>
    <span class="p">},</span>
    <span class="p">[</span><span class="s2">&quot;ligatures&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">[</span><span class="mi">102</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="s2">&quot;char&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
        <span class="p">[</span><span class="mi">108</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="s2">&quot;char&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
        <span class="p">[</span><span class="mi">105</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="s2">&quot;char&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>等宽字体没有带子和字间（ligatures and kerns），一般不处理这两个问题。</p>
<h3 id="luafont">Lua中的font库<a class="headerlink" href="#luafont" title="Permanent link">#</a></h3>
<p>参看<em>LuaTEX manual</em></p>
<h3 id="_28">朝向与旋转（竖排、直书）<a class="headerlink" href="#_28" title="Permanent link">#</a></h3>
<p>参见开发文档<a href="http://www.pragma-ade.com/general/manuals/followingup.pdf">followingup</a>的第6节，Directions。</p>
<p>LMTX使用两个结点列表dir（direction，列表流的方向），从左到右和从右到左，而不是luatex的四个（TLT, TRT, RTT, LTL）；而主要使用box的6种orientation（朝向、方向）实现特殊方向的排版。</p>
<h3 id="_29">模块开发<a class="headerlink" href="#_29" title="Permanent link">#</a></h3>
<p>参考</p>
<ul>
<li><a href="https://wiki.contextgarden.net/Modules">社区文档</a></li>
<li><a href="https://wiki.contextgarden.net/Module_Parameters">模块参数</a><ul>
<li>\currentmoduleparameter{color} 模块内展开</li>
<li>\moduleparameter{bgcolor}{color} 全局使用，比如在定义中</li>
</ul>
</li>
</ul>
<h2 id="lua_in_context">Lua in ConTeXt<a class="headerlink" href="#lua_in_context" title="Permanent link">#</a></h2>
<p>本部分主要学习如下资料的笔记：</p>
<ul>
<li><em>ConTeXt Lua documents</em></li>
<li><a href="https://wiki.contextgarden.net/Programming_in_LuaTeX"><em>Programming in LuaTeX</em></a></li>
</ul>
<h3 id="_30">引言<a class="headerlink" href="#_30" title="Permanent link">#</a></h3>
<p><strong>ConTeXt Lua 的两种运行方式：</strong></p>
<ul>
<li>镶嵌在ConTeXt文档中执行</li>
<li>用context直接执行<code>.cld</code>文档</li>
</ul>
<p><strong>ConTeXt文档中Lua代码的主要问题是：代码先由TeX展开，再给Lua处理。这意味着，所有Lua代码，甚至分行和注释，首先必须在TeX中合法；其次，展开后要在Lua中合法！因此要注意：</strong></p>
<ul>
<li>断行视作空格；</li>
<li>特殊TeX字符，如&amp;, #, $, {, }等，需要转义。</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\ctxlua</span>
  <span class="nb">{</span>-- A Lua comment
   tex.print(&quot;This is not printed&quot;)<span class="nb">}</span>
<span class="k">\ctxlua</span>
  <span class="nb">{</span><span class="c">% A Tex comment</span>
   tex.print(&quot;This is printed&quot;)<span class="nb">}</span>

<span class="c">% This doesn&#39;t work:</span>
<span class="c">%\ctxlua</span>
<span class="c">%  {local t = {1,2,3,4}</span>
<span class="c">%   tex.print(&quot;length &quot; .. #t)}</span>
<span class="c">% should be:</span>
<span class="k">\ctxlua</span>
  <span class="nb">{</span>local t = <span class="nb">{</span>1,2,3,4<span class="nb">}</span>
   tex.print(&quot;length &quot; .. <span class="k">\string</span>#t)<span class="nb">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="context_interfacing">ConTeXt文档中的代码执行界面 Interfacing<a class="headerlink" href="#context_interfacing" title="Permanent link">#</a></h3>
<ul>
<li><code>\startluacode...\stopluacode</code>，模块式，如定义函数</li>
<li><code>\ctxlua</code>，或<code>\ctxluacode</code>（更多准备），行内式，如执行函数</li>
</ul>
<p>以上都是在LuaTeX基元<code>\directlua</code>之上包装的；绝不要直接使用<code>\directlua</code>。</p>
<p>命名空间commands的快捷方式:</p>
<ul>
<li><code>\ctxcommand{thisorthat("...")}</code>，等于<code>\ctxlua{commands.thisorthat("...")}</code></li>
</ul>
<p>命名空间context的快捷方式：</p>
<ul>
<li><code>\cldcontext{myfunction(5)}</code>直接获得函数返回值，等价于<code>\ctxlua{context(myfunction(5))}</code></li>
<li><code>\cldprocessfile#1{\directlua{context.runfile("#1")}}</code></li>
<li><code>\cldloadfile#1   {\directlua{context.loadfile("#1")}}</code></li>
<li><code>\cldcontext#1    {\directlua{context(#1)}}</code></li>
<li><code>\cldcommand#1    {\directlua{context.#1}}</code></li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\startluacode</span>
    -- The unknown command <span class="k">\undefined</span> will cause this entire block to fail.

    -- Print a countdown &#39;10, 8, ..., 0!&#39;
    -- `..` is Lua for string concatenation
    for i = 10, 2, -2 do
        context(i .. &quot;, &quot;)
    end
    context(&quot;0!&quot;)

    -- <span class="k">\\</span>par is equivalent to a blank line in the input
    -- (Notice the escaped backslash: TeX won&#39;t mind the above comment.)
    context.par()

    -- Look! we can use # and <span class="s">$</span><span class="nb"> with impunity</span><span class="o">!</span>
<span class="nb">    context</span><span class="o">(</span><span class="nb">&quot;Unless we print them, then we must </span><span class="nv">\\</span><span class="nb">#</span><span class="nv">\\</span><span class="s">$</span><span class="k">\\</span><span class="nb">&amp;</span> print the escape characters, too.&quot;)
<span class="k">\stopluacode</span>
</code></pre></div></td></tr></table></div>
<p>ctx函数与ctx宏/ctx定义：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c">% ctx函数</span>
<span class="k">\startctxfunction</span> MyFunctionA
    context(&quot; A1 &quot;)
<span class="k">\stopctxfunction</span>
<span class="k">\ctxfunction</span><span class="nb">{</span>MyFunctionA<span class="nb">}</span>

<span class="c">% ctx函数定义（宏）</span>
<span class="k">\startctxfunctiondefinition</span> MyFunctionB
    context(&quot; B2 &quot;)
<span class="k">\stopctxfunctiondefinition</span>
<span class="k">\MyFunctionB</span>
</code></pre></div></td></tr></table></div>
<h3 id="_31">引入外部代码<a class="headerlink" href="#_31" title="Permanent link">#</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\startluacode</span>
-- include the file my-lua-lib.lua
require(&quot;my-lua-lib&quot;)
<span class="k">\stopluacode</span>
</code></pre></div></td></tr></table></div>
<h3 id="_32">使用命名空间<a class="headerlink" href="#_32" title="Permanent link">#</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\startluacode</span>
    -- if userdata doesn&#39;t exist yet, create it
    userdata = userdata or <span class="nb">{}</span>
    -- define a shorter synonym
    u = userdata

    -- create my custom function inside the userdata namespace
    function u.myfunction()
        -- do stuff
    end        
<span class="k">\stopluacode</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>userdata      = userdata      or { } -- for users (e.g. functions etc)</li>
<li>documentdata  = documentdata  or { } -- for users (e.g. raw data)</li>
<li>moduledata    = moduledata    or { } -- only for development team</li>
<li>parametersets = parametersets or { } -- experimental for team</li>
<li>thirddata     = thirddata     or { } -- only for third party modules</li>
</ul>
<p>用子命名空间向用户暴露自己的数据：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code>moduledata[&#39;mymodule&#39;] = <span class="nb">{</span> <span class="nb">}</span>
mm = moduledata.mymodule
function mm.mainfunction()
    -- do stuff
end
</code></pre></div></td></tr></table></div>
<h3 id="_33">库<a class="headerlink" href="#_33" title="Permanent link">#</a></h3>
<p>用表组织在一起的功能。</p>
<p><strong>Lua库：</strong>string, table, lpeg, math, io and os<br />
<strong>LUATEX库：</strong>node, tex and texio.  </p>
<h3 id="_34">输出文本<a class="headerlink" href="#_34" title="Permanent link">#</a></h3>
<p>一般使用<code>context(...)</code>，等价于<code>tex.print(string.format(...))</code></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\startluacode</span>
    name = &quot;Jane&quot;
    date = &quot;today&quot;
    context(&quot;Hello <span class="c">%s, how are you %s?&quot;, name, date)</span>
    -- Becomes &#39;Hello Jane, how are you today?&#39;
<span class="k">\stopluacode</span>
</code></pre></div></td></tr></table></div>
<p>更原始的：</p>
<ul>
<li><code>tex.print()</code>（多个参数，或一个表，每项一行）</li>
<li><code>tex.sprint()</code>（多个参数，或一个表，所有项合成一个string）</li>
</ul>
<p>显示输入文件及其路径。参考： https://tex.stackexchange.com/questions/132303/is-there-a-context-command-to-print-the-path-of-the-file-in-which-it-is-evoked</p>
<ul>
<li>\ctxlua{context(environment.inputfilename)}</li>
<li>\ctxlua{context(lfs.currentdir())}</li>
</ul>
<p>拼接成完整路径：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>local fullname = file.join(lfs.currentdir(), environment.inputfilename)
print(fullname)
local pwd = file.dirname(fullname)
print(pwd)
</code></pre></div></td></tr></table></div>
<h3 id="context_commands">ConTeXt commands<a class="headerlink" href="#context_commands" title="Permanent link">#</a></h3>
<p>大部分ConTeXt命令可以通过<code>context.command</code>的形式取得，方括号参数改用表来表示，花括号参数改用字符串。</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\startluacode</span>
    context.chapter(<span class="nb">{</span>first<span class="nb">}</span>, &quot;Some title&quot;)
    context.startcolumns(<span class="nb">{</span>n = 3, rule = &quot;on&quot;<span class="nb">}</span>)
        context(&quot;Hello one&quot;)
    context.column()
        context(&quot;Hello two&quot;)
    context.column()
        context(&quot;Hello three&quot;)
    context.stopcolumns()
<span class="k">\stopluacode</span>
</code></pre></div></td></tr></table></div>
<p>等价于：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\chapter</span><span class="na">[first]</span><span class="nb">{</span>Some title<span class="nb">}</span>
<span class="k">\startcolumns</span><span class="na">[n=3, rule=on]</span>
    Hello one
<span class="k">\column</span>
    Hello two
<span class="k">\column</span>
    Hello three
<span class="k">\stopcolumns</span>
</code></pre></div></td></tr></table></div>
<h3 id="contextlua">传递参数和缓存: ConTeXt命令给Lua提供的钩子<a class="headerlink" href="#contextlua" title="Permanent link">#</a></h3>
<p>先定义Lua函数：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\startluacode</span>
    -- remember, using the userdata namespace prevents conflicts
    userdata = userdata or <span class="nb">{}</span>

    function userdata.surroundwithdashes(str)
        context(&quot;--&quot; .. str .. &quot;--&quot;)
    end
<span class="k">\stopluacode</span>
</code></pre></div></td></tr></table></div>
<p>然后定义同一个TeX命令来展开\ctxlua回调:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\def\surroundwd</span>#1<span class="c">%</span>
    <span class="nb">{</span><span class="k">\ctxlua</span><span class="nb">{</span>userdata.surroundwithdashes([==[#1]==])<span class="nb">}}</span>
</code></pre></div></td></tr></table></div></p>
<p><code>[==[#1]==]</code>长字符串比引号更健壮。</p>
<p>先定义Lua函数</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\startluacode</span>
    userdata = userdata or <span class="nb">{}</span>

    function userdata.verynarrow(buffer)
        -- equivalent to <span class="k">\startnarrower</span><span class="na">[10em]</span>
        context.startnarrower(<span class="nb">{</span>&quot;10em&quot;<span class="nb">}</span>)
            context(buffer)
        context.stopnarrower()
    end
<span class="k">\stopluacode</span>
</code></pre></div></td></tr></table></div>
<p>定义缓存的开始命令：</p>
<p>https://wiki.contextgarden.net/Buffers_in_LuaTeX</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\def\startverynarrow</span><span class="c">%</span>
  <span class="nb">{</span><span class="k">\dostartbuffer</span>
    [verynarrow]      <span class="c">% buffer name</span>
    [startverynarrow] <span class="c">% command where buffer starts</span>
    [stopverynarrow]<span class="nb">}</span> <span class="c">% command where buffer ends</span>
                      <span class="c">% also: command invoked when buffer stops</span>
</code></pre></div></td></tr></table></div>
<p>定义结束命令\stopverynarrow，并当前完成的缓存传递给Lua函数verynarrow：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\def\stopverynarrow</span>
  <span class="nb">{</span><span class="k">\ctxlua</span>
     <span class="nb">{</span>userdata.verynarrow(buffers.getcontent(&#39;verynarrow&#39;))<span class="nb">}}</span>
</code></pre></div></td></tr></table></div>
<h3 id="_35">用例<a class="headerlink" href="#_35" title="Permanent link">#</a></h3>
<p>计算正弦</p>
<p>\def\COSINE#1%
  {\ctxlua{context(math.cos(#1<em>2</em>math.pi/360))}}</p>
<p><span class="arithmatex">\(\pi = \ctxlua{context(math.pi)}\)</span> </p>
<p><span class="arithmatex">\(\pi = \ctxlua{context("\letterpercent.6f", math.pi)}\)</span></p>
<p>\setupcolors[state=start]
\setupTABLE[each][each][width=2em,height=2em,align={middle,middle}]<br />
\setupTABLE[r][1][background=color,backgroundcolor=gray]<br />
\setupTABLE[c][1][background=color,backgroundcolor=gray]</p>
<p>循环而无需担忧展开：</p>
<p>\startluacode
context.bTABLE()
  context.bTR()
    context.bTD() context("<span class="arithmatex">\((+)\)</span>") context.eTD()
    for j=1,6 do
      context.bTD() context(j) context.eTD()
    end
  context.eTR()
  for i=1,6 do
    context.bTR()
    context.bTD() context(i) context.eTD()
    for j=1,6 do
      context.bTD() context(i+j) context.eTD()
    end
    context.eTR()
  end
context.eTABLE()
\stopluacode</p>
<h3 id="_36">字符串操作<a class="headerlink" href="#_36" title="Permanent link">#</a></h3>
<p>https://wiki.contextgarden.net/String_manipulation</p>
<h3 id="_37">表格操作<a class="headerlink" href="#_37" title="Permanent link">#</a></h3>
<p>https://wiki.contextgarden.net/Table_manipulation</p>
<h3 id="io">IO<a class="headerlink" href="#io" title="Permanent link">#</a></h3>
<p>https://wiki.contextgarden.net/Extensions_to_the_Lua_I/O_library</p>
<h3 id="contextluacontext">在ConTeXt外部运行Lua（可使用ConTeXt环境）<a class="headerlink" href="#contextluacontext" title="Permanent link">#</a></h3>
<p>https://wiki.contextgarden.net/Running_Lua_Code_Externally</p>
<p><code>mtxrun --script dummy.lua</code></p>
<h2 id="cld_context_lua_documents">CLD: ConTeXt Lua Documents<a class="headerlink" href="#cld_context_lua_documents" title="Permanent link">#</a></h2>
<p>ConTeXt Lua Documents (CLD)是从Lua脚本中使用TeX的方式。可以实现纯Lua、不需要TeX代码的排版。适合自动排版。</p>
<p>本部分主要学习如下资料的笔记：</p>
<ul>
<li>官方文档<em>ConTeXt Lua Documents</em></li>
<li><a href="https://wiki.contextgarden.net/CLD">官网CLD</a></li>
<li>官方参考手册<em>context reference manual</em></li>
<li>命令文档<em>ConTEXt commands</em></li>
<li>中文支持项目（如实现标点压缩）<a href="https://github.com/liyanrui/zhfonts">zhfonts</a>，及相关文章<a href="http://liyanrui.is-programmer.com/2009/11/28/chinese-punctations-compression-with-luatex.13608.html">ConTeXt MkIV 中文标点间距压缩问题的解决方案</a></li>
</ul>
<h3 id="_38">执行方式<a class="headerlink" href="#_38" title="Permanent link">#</a></h3>
<p>极简文件<code>test.cld</code>：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">context</span><span class="p">.</span><span class="n">starttext</span><span class="p">()</span>
<span class="n">context</span><span class="p">.</span><span class="n">chapter</span><span class="p">(</span><span class="s2">&quot;Hello There!&quot;</span><span class="p">)</span>
<span class="n">context</span><span class="p">.</span><span class="n">stoptext</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>cld文件的执行：<code>context test.cld</code>，或自定后缀而加运行选项<code>--forcecld</code>。其余选项：</p>
<ul>
<li>--forcecld</li>
<li>--forcelua</li>
<li>--forcexml</li>
<li>--forcemp</li>
</ul>
<h3 id="_39">常用函数<a class="headerlink" href="#_39" title="Permanent link">#</a></h3>
<p><strong>cld函数与文档命令往往一一对应：</strong></p>
<ul>
<li>context.chapter("Some title") 对应\chapter{Some title}</li>
<li>context.chapter({ "first" }, "Some title") 对应\chapter[first]{Some title}</li>
<li>context.startchapter({ title = "Some title", label = "first" }) 对应\startchapter[title={Some title},label=first]</li>
<li>context.pagenumber("pagenumber")</li>
</ul>
<p>文本被看作tex输入：</p>
<ul>
<li>context.mathematics([-[\sqrt{2^3}]-]) </li>
</ul>
<p>分行、分段：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">context</span><span class="p">.</span><span class="n">startlines</span><span class="p">()</span>
<span class="n">context</span><span class="p">(</span><span class="s2">&quot;line 1&quot;</span><span class="p">)</span> <span class="n">context</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="n">context</span><span class="p">(</span><span class="s2">&quot;line 2&quot;</span><span class="p">)</span> <span class="n">context</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="n">context</span><span class="p">(</span><span class="s2">&quot;line 3&quot;</span><span class="p">)</span> <span class="n">context</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="n">context</span><span class="p">(</span><span class="s2">&quot;line 4</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">context</span><span class="p">.</span><span class="n">stoplines</span><span class="p">()</span>
<span class="c1">-- 分段</span>
<span class="n">context</span><span class="p">.</span><span class="n">par</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>插入pdf的一部分：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="err">\</span><span class="n">startluacode</span>
<span class="kr">for</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="mi">17</span> <span class="kr">do</span>
    <span class="n">context</span><span class="p">.</span><span class="n">externalfigure</span><span class="p">({</span><span class="s2">&quot;filename.pdf&quot;</span><span class="p">},{</span><span class="n">page</span><span class="o">=</span><span class="n">s</span><span class="p">})</span>
<span class="kr">end</span>
<span class="err">\</span><span class="n">stopluacode</span>
</code></pre></div></td></tr></table></div>
<p>所有命令：</p>
<p>https://source.contextgarden.net/tex/context/base/mkiv/cldf-ini.lua</p>
<h3 id="_40">传递函数<a class="headerlink" href="#_40" title="Permanent link">#</a></h3>
<p>TeX中定义的命令<code>\mycommand{Myvariable}</code>，可以在Lua中命名空间<code>context</code>下直接使用<code>context.mycommand("Myvariable")</code></p>
<h3 id="cld">CLD双向传递变量<a class="headerlink" href="#cld" title="Permanent link">#</a></h3>
<p>参考： https://wiki.contextgarden.net/CLD_passing_variables#Variables</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\startTEXpage</span><span class="na">[offset=5mm]</span>

<span class="k">\setvariable</span><span class="nb">{</span>Namespace<span class="nb">}{</span>Key<span class="nb">}{</span>30<span class="nb">}</span>

<span class="k">\startluacode</span>
local value = tokens.getters.macro(tokens.getters.macro(&quot;??variables&quot;) .. &quot;Namespace:Key&quot;)
value = 3*value
context(&quot;Type: &quot; .. type(value))
context.par()
context(&quot;Result is &quot; .. value)
<span class="k">\stopluacode</span>

<span class="k">\stopTEXpage</span>

Result is <span class="k">\getvariable</span><span class="nb">{</span>Namespace<span class="nb">}{</span>Key<span class="nb">}</span>.
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\startTEXpage</span><span class="na">[offset=5mm]</span>

<span class="k">\startluacode</span>
local value = 30
value = 3 * value
context(&quot;Type: &quot; .. type(value))
context.par()
context.setvariable(&quot;Namespace&quot;, &quot;Key&quot;, value)
<span class="k">\stopluacode</span>

Result is <span class="k">\getvariable</span><span class="nb">{</span>Namespace<span class="nb">}{</span>Key<span class="nb">}</span>.

<span class="k">\stopTEXpage</span>
</code></pre></div></td></tr></table></div>
<p>多过/多遍处理所需数据的存取参考<code>\setdataset</code>。</p>
<h3 id="_41">直接输出<a class="headerlink" href="#_41" title="Permanent link">#</a></h3>
<p>仅在特殊情况下使用。</p>
<p>仅仅是(给环境)传递参数，不做操作：<code>context.direct("one","two")</code>，等同于<code>context(false,"one","two")</code>（无可选参数，而只有输入内容）</p>
<h3 id="catcodes">特种码 Catcodes<a class="headerlink" href="#catcodes" title="Permanent link">#</a></h3>
<p>输出文本<code>$x=1$</code>而不是数学公式：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">context</span><span class="p">.</span><span class="n">pushcatcodes</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
<span class="n">context</span><span class="p">(</span><span class="s2">&quot;$x=1$&quot;</span><span class="p">)</span>
<span class="n">context</span><span class="p">.</span><span class="n">popcatcodes</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>catcode regimes:</p>
<ul>
<li>ctx, ctxcatcodes, context:   the normal CONTEXT catcode regime</li>
<li>prt, prtcatcodes, protect:    the CONTEXT protected regime, used for modules</li>
<li>tex, texcatcodes, plain:     the traditional (plain) TEX regime</li>
<li>txt, txtcatcodes, text:      the CONTEXT regime but with less special characters</li>
<li>vrb, vrbcatcodes, verbatim:   a regime specially meant for verbatim</li>
<li>xml, xmlcatcodes:             a regime specially meant for XML processing</li>
</ul>
<h3 id="_42">以函数而不是语句作为参数<a class="headerlink" href="#_42" title="Permanent link">#</a></h3>
<p>context.framed( {
    frame = "on",
    offset = "5mm",
    align = "middle"
    },
    -- 不用<code>context.input("knuth")</code>，而用：
    function() context.input("knuth") end
)</p>
<h3 id="trial_typesetting">试排 Trial typesetting<a class="headerlink" href="#trial_typesetting" title="Permanent link">#</a></h3>
<p>试排状态（Trial typesetting，比如处理天头、地脚、表格单元，寻找最佳答案），退出时会清空缓存。但可用<code>return true</code>转存：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kr">function</span><span class="p">()</span>
    <span class="n">context</span><span class="p">(</span><span class="s2">&quot;whatever&quot;</span><span class="p">)</span>
    <span class="kr">return</span> <span class="kc">true</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>
<p>只要碰到结果不满意的情况，即可<code>return true</code>。但这样可能导致缓存过大，这时可以强制清空:<code>context.restart()</code></p>
<p>判断试排状态：</p>
<p><boolean> b = context.trialtypesetting()</p>
<h3 id="steppers_luatex">Steppers 从Lua临时进入TeX<a class="headerlink" href="#steppers_luatex" title="Permanent link">#</a></h3>
<p>未中断Lua</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">context</span><span class="p">.</span><span class="n">stepwise</span> <span class="p">(</span><span class="kr">function</span><span class="p">()</span>
    <span class="n">context</span><span class="p">.</span><span class="n">startitemize</span><span class="p">()</span>
        <span class="n">context</span><span class="p">.</span><span class="n">startitem</span><span class="p">()</span>
            <span class="n">context</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;BEFORE 1&quot;</span><span class="p">)</span>
        <span class="n">context</span><span class="p">.</span><span class="n">stopitem</span><span class="p">()</span>
            <span class="n">context</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">setbox0</span><span class="se">\\</span><span class="s2">hbox{!!!!}&quot;</span><span class="p">)</span>
        <span class="n">context</span><span class="p">.</span><span class="n">startitem</span><span class="p">()</span>
            <span class="n">context</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;%p&quot;</span><span class="p">,</span><span class="n">tex</span><span class="p">.</span><span class="n">getbox</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">width</span><span class="p">)</span>
        <span class="n">context</span><span class="p">.</span><span class="n">stopitem</span><span class="p">()</span>
        <span class="c1">-- ...</span>
    <span class="n">context</span><span class="p">.</span><span class="n">stopitemize</span><span class="p">()</span>
<span class="kr">end</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="modes">Modes 模式匹配<a class="headerlink" href="#modes" title="Permanent link">#</a></h3>
<p>processing time 测试：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">context</span><span class="p">.</span><span class="n">doifmodeelse</span><span class="p">(</span> <span class="s2">&quot;screen&quot;</span><span class="p">,</span>
    <span class="kr">function</span><span class="p">()</span>
        <span class="p">...</span> <span class="c1">-- mode == screen</span>
    <span class="kr">end</span><span class="p">,</span>
    <span class="kr">function</span><span class="p">()</span>
        <span class="p">...</span> <span class="c1">-- mode ~= screen</span>
    <span class="kr">end</span>
<span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>每个run只测试一次：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kr">if</span> <span class="n">tex</span><span class="p">.</span><span class="n">modes</span><span class="p">[</span><span class="s2">&quot;screen&quot;</span><span class="p">]</span> <span class="kr">then</span>
<span class="p">...</span>
<span class="kr">else</span>
<span class="p">...</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>
<p>常用模式：</p>
<ul>
<li>tex.modes["mymode"]</li>
<li>tex.modes["*mymode"]</li>
<li>tex.systemmodes["mymode"]</li>
<li>tex.constants["someconstant'] 非公开，可能改变</li>
</ul>
<h3 id="token_2">Token列表<a class="headerlink" href="#token_2" title="Permanent link">#</a></h3>
<p>TeX:<code>\toks0 = {Don't get \inframed{framed}!}</code></p>
<p>lua:<code>context(tex.toks[0])</code></p>
<p>实际上是以文本形式保存的：<code>context("&lt; %s &gt;",tex.toks[0])</code></p>
<p>但却不能反过来，存入文本形式的内容：<code>tex.toks[0] = [-[\framed{oeps}]-]</code>，这样这能得到文本</p>
<h3 id="node_1">Node列表<a class="headerlink" href="#node_1" title="Permanent link">#</a></h3>
<p>TeX：<code>\setbox0 = \hbox{Don't get \inframed{framed}!}</code>，然后用<code>\box0</code>输出，或用<code>\copy0</code>持有拷贝。</p>
<p>lua端则：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">-- 引用、拷贝（结点必须free）</span>
<span class="n">context</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">context</span><span class="p">.</span><span class="n">direct</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">--或</span>
<span class="n">context</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">--或</span>
<span class="n">context</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">copy_list</span><span class="p">(</span><span class="n">tex</span><span class="p">.</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="c1">-- 输出</span>
<span class="n">context</span><span class="p">(</span><span class="n">tex</span><span class="p">.</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">context</span><span class="p">(</span><span class="n">tex</span><span class="p">.</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">width</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p><strong>遍历node和任务挂载：</strong></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\startluacode</span>
local hlist<span class="nb">_</span>code = nodes.nodecodes.hlist
local glyphs = nodes.nodecodes.glyph
function userdata.processmystuff(head)
    -- 遍历结点
    for n in node.traverse(head) do
        print(n.subtype)
    end
    -- 遍历glyphs结点id
    for n in node.traverse<span class="nb">_</span>id(glyphs,head) do
        print(n)
        --<span class="c">% nodes.tracers.colors.set(, &quot;red&quot;)</span>
   end
   return head, true
end

--把`userdata.processmystuff`函数挂载到processors回调的normalizers类别中。
nodes.tasks.appendaction(&quot;processors&quot;, &quot;after&quot;, &quot;userdata.processmystuff&quot;)
--停用
nodes.tasks.disableaction(&quot;processors&quot;, &quot;userdata.processmystuff&quot;)
<span class="k">\stopluacode</span>

用例:

<span class="k">\startluacode</span>
--启用
nodes.tasks.enableaction(&quot;processors&quot;, &quot;userdata.processmystuff&quot;)
<span class="k">\stopluacode</span>

我和你。

<span class="k">\startluacode</span>
--停用
nodes.tasks.disableaction(&quot;processors&quot;, &quot;userdata.processmystuff&quot;)
<span class="k">\stopluacode</span>
</code></pre></div></td></tr></table></div>
<h3 id="_43">回调函数<a class="headerlink" href="#_43" title="Permanent link">#</a></h3>
<p>本节内容见<a href="../2022-02-23-luametatex-callback-playground/">LuaTeX回调游乐场</a></p>
<h3 id="_44">页面布局与框架布局<a class="headerlink" href="#_44" title="Permanent link">#</a></h3>
<p>设置版面布局，随机生成图形：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="err">\</span><span class="n">startluacode</span>
<span class="c1">--数字转尺寸</span>
<span class="kd">local</span> <span class="n">todimen</span><span class="p">,</span> <span class="n">random</span> <span class="o">=</span> <span class="n">number</span><span class="p">.</span><span class="n">todimen</span><span class="p">,</span> <span class="nb">math.random</span>

<span class="c1">-- 开始一个页面</span>
<span class="n">context</span><span class="p">.</span><span class="n">startTEXpage</span><span class="p">()</span>

<span class="c1">--纸张尺寸</span>
<span class="kd">local</span> <span class="n">paperwidth</span> <span class="o">=</span> <span class="n">tex</span><span class="p">.</span><span class="n">dimen</span><span class="p">.</span><span class="n">paperwidth</span>
<span class="kd">local</span> <span class="n">paperheight</span> <span class="o">=</span> <span class="n">tex</span><span class="p">.</span><span class="n">dimen</span><span class="p">.</span><span class="n">paperheight</span>
<span class="kd">local</span> <span class="n">nofsteps</span> <span class="o">=</span> <span class="mi">25</span>
<span class="kd">local</span> <span class="n">firstcolor</span> <span class="o">=</span> <span class="s2">&quot;darkblue&quot;</span>
<span class="kd">local</span> <span class="n">secondcolor</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span>

<span class="c1">--定义和设置整体框架布局</span>
<span class="n">context</span><span class="p">.</span><span class="n">definelayer</span><span class="p">({</span> <span class="s2">&quot;titlepage&quot;</span> <span class="p">})</span>
<span class="n">context</span><span class="p">.</span><span class="n">setuplayer</span><span class="p">(</span>
    <span class="p">{</span> <span class="s2">&quot;titlepage&quot;</span> <span class="p">},</span>
    <span class="p">{</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">todimen</span><span class="p">(</span><span class="n">paperwidth</span><span class="p">),</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">todimen</span><span class="p">(</span><span class="n">paperheight</span><span class="p">),</span>
<span class="p">})</span>
<span class="n">context</span><span class="p">.</span><span class="n">setlayerframed</span><span class="p">(</span>
    <span class="p">{</span> <span class="s2">&quot;titlepage&quot;</span> <span class="p">},</span>
    <span class="p">{</span> <span class="n">offset</span> <span class="o">=</span> <span class="s2">&quot;-5pt&quot;</span> <span class="p">},</span>
    <span class="p">{</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">todimen</span><span class="p">(</span><span class="n">paperwidth</span><span class="p">),</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">todimen</span><span class="p">(</span><span class="n">paperheight</span><span class="p">),</span>
        <span class="n">background</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span><span class="p">,</span>
        <span class="n">backgroundcolor</span> <span class="o">=</span> <span class="n">firstcolor</span><span class="p">,</span>
        <span class="n">backgroundoffset</span> <span class="o">=</span> <span class="s2">&quot;10pt&quot;</span><span class="p">,</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;&quot;</span>
<span class="p">)</span>
<span class="c1">--定义和设置小图框架布局</span>
<span class="kd">local</span> <span class="n">settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
    <span class="n">background</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span><span class="p">,</span>
    <span class="n">backgroundcolor</span> <span class="o">=</span> <span class="n">secondcolor</span><span class="p">,</span>
    <span class="n">foregroundcolor</span> <span class="o">=</span> <span class="n">firstcolor</span><span class="p">,</span>
    <span class="n">foregroundstyle</span> <span class="o">=</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="kr">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nofsteps</span> <span class="kr">do</span>
    <span class="kr">for</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nofsteps</span> <span class="kr">do</span>
        <span class="n">context</span><span class="p">.</span><span class="n">setlayerframed</span><span class="p">(</span>
            <span class="p">{</span> <span class="s2">&quot;titlepage&quot;</span> <span class="p">},</span>
            <span class="p">{</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">todimen</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">paperwidth</span> <span class="o">/</span><span class="n">nofsteps</span><span class="p">),</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">todimen</span><span class="p">((</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">paperheight</span><span class="o">/</span><span class="n">nofsteps</span><span class="p">),</span>
                <span class="c1">--旋转角度</span>
                <span class="n">rotation</span> <span class="o">=</span> <span class="n">random</span><span class="p">(</span><span class="mi">360</span><span class="p">),</span>
            <span class="p">},</span>
            <span class="n">settings</span><span class="p">,</span>
            <span class="s2">&quot;CLD&quot;</span>
        <span class="p">)</span>
    <span class="kr">end</span>
<span class="kr">end</span>
<span class="c1">--？？？</span>
<span class="n">context</span><span class="p">.</span><span class="n">tightlayer</span><span class="p">({</span> <span class="s2">&quot;titlepage&quot;</span> <span class="p">})</span>
<span class="n">context</span><span class="p">.</span><span class="n">stopTEXpage</span><span class="p">()</span>
<span class="kr">return</span> <span class="kc">true</span>
<span class="err">\</span><span class="n">stopluacode</span>
</code></pre></div></td></tr></table></div>
<h3 id="_45">列表<a class="headerlink" href="#_45" title="Permanent link">#</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">context</span><span class="p">.</span><span class="n">startitemize</span> <span class="p">{</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;packed&quot;</span><span class="p">,</span> <span class="s2">&quot;two&quot;</span> <span class="p">}</span>
<span class="kr">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span> <span class="kr">do</span>
    <span class="n">context</span><span class="p">.</span><span class="n">startitem</span><span class="p">()</span>
    <span class="n">context</span><span class="p">(</span><span class="s2">&quot;this is item %i&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="n">context</span><span class="p">.</span><span class="n">stopitem</span><span class="p">()</span>
<span class="kr">end</span>
<span class="n">context</span><span class="p">.</span><span class="n">stopitemize</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<h3 id="_46">表格<a class="headerlink" href="#_46" title="Permanent link">#</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">local</span> <span class="n">one</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">align</span> <span class="o">=</span> <span class="s2">&quot;middle&quot;</span><span class="p">,</span>
    <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="kd">local</span> <span class="n">two</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">align</span> <span class="o">=</span> <span class="s2">&quot;middle&quot;</span><span class="p">,</span>
    <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span>
    <span class="n">background</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span><span class="p">,</span>
    <span class="n">backgroundcolor</span> <span class="o">=</span> <span class="s2">&quot;darkblue&quot;</span><span class="p">,</span>
    <span class="n">foregroundcolor</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="kd">local</span> <span class="n">random</span> <span class="o">=</span> <span class="nb">math.random</span>
<span class="c1">-- 表格开始</span>
<span class="n">context</span><span class="p">.</span><span class="n">bTABLE</span> <span class="p">{</span> <span class="n">framecolor</span> <span class="o">=</span> <span class="s2">&quot;darkblue&quot;</span> <span class="p">}</span>
<span class="kr">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span> <span class="kr">do</span>
    <span class="c1">-- 表行开始</span>
    <span class="n">context</span><span class="p">.</span><span class="n">bTR</span><span class="p">()</span>
    <span class="kr">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span> <span class="kr">do</span>
        <span class="kd">local</span> <span class="n">r</span> <span class="o">=</span> <span class="n">random</span><span class="p">(</span><span class="mi">99</span><span class="p">)</span>
        <span class="c1">-- 单元格开始</span>
        <span class="n">context</span><span class="p">.</span><span class="n">bTD</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="ow">and</span> <span class="n">one</span> <span class="ow">or</span> <span class="n">two</span><span class="p">)</span>
        <span class="n">context</span><span class="p">(</span><span class="s2">&quot;%2i&quot;</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">context</span><span class="p">.</span><span class="n">eTD</span><span class="p">()</span>
    <span class="kr">end</span>
    <span class="n">context</span><span class="p">.</span><span class="n">eTR</span><span class="p">()</span>
<span class="kr">end</span>
<span class="n">context</span><span class="p">.</span><span class="n">eTABLE</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p><img alt="" src="../img/LuaTeX-CLD%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2021-12-23-21-35-31.png" /></p>
<h3 id="_47">放置图片<a class="headerlink" href="#_47" title="Permanent link">#</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">context</span><span class="p">.</span><span class="n">placefigure</span><span class="p">(</span>
    <span class="s2">&quot;caption&quot;</span><span class="p">,</span>
    <span class="c1">--这里也可以生成表格，或表格中嵌入图像</span>
    <span class="kr">function</span><span class="p">()</span> <span class="n">context</span><span class="p">.</span><span class="n">externalfigure</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;cow.pdf&quot;</span> <span class="p">}</span> <span class="p">)</span> <span class="kr">end</span>
<span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="_48">风格<a class="headerlink" href="#_48" title="Permanent link">#</a></h3>
<ul>
<li>粗体 context.bold("important")</li>
<li>粗体加颜色 context.style( { style = "bold", color = "red" }, "important")<ul>
<li>context.bold(function() context.color( { "red" }, "important") end)</li>
<li>context.bold(context.delayed.color( { "red" }, "important"))</li>
</ul>
</li>
</ul>
<p>包装成命令：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">local</span> <span class="kr">function</span> <span class="nc">mycommands</span><span class="p">.</span><span class="nf">important</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
    <span class="n">context</span><span class="p">.</span><span class="n">style</span><span class="p">(</span> <span class="p">{</span> <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span> <span class="p">},</span> <span class="n">str</span> <span class="p">)</span>
<span class="kr">end</span>
<span class="n">mycommands</span><span class="p">.</span><span class="n">important</span><span class="p">(</span> <span class="s2">&quot;important&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>或设置、定义一种风格：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">context</span><span class="p">.</span><span class="n">setupstyle</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;important&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span> <span class="p">}</span> <span class="p">)</span>
<span class="n">context</span><span class="p">.</span><span class="n">style</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;important&quot;</span> <span class="p">},</span> <span class="s2">&quot;important&quot;</span><span class="p">)</span>

<span class="n">context</span><span class="p">.</span><span class="n">definestyle</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;important&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span> <span class="p">}</span> <span class="p">)</span>
<span class="n">context</span><span class="p">.</span><span class="n">important</span><span class="p">(</span><span class="s2">&quot;important&quot;</span><span class="p">)</span>
<span class="n">context</span><span class="p">.</span><span class="n">startimportant</span><span class="p">()</span>
<span class="n">context</span><span class="p">.</span><span class="n">inframed</span><span class="p">(</span><span class="s2">&quot;important&quot;</span><span class="p">)</span>
<span class="n">context</span><span class="p">.</span><span class="n">stopimportant</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<h3 id="forlorien">ForLorien 打印数学题的完整例子<a class="headerlink" href="#forlorien" title="Permanent link">#</a></h3>
<h3 id="interfacing_texunicode">Interfacing TeX界面和Unicode的处理<a class="headerlink" href="#interfacing_texunicode" title="Permanent link">#</a></h3>
<h3 id="formatters">Formatters<a class="headerlink" href="#formatters" title="Permanent link">#</a></h3>
<h3 id="graphics">Graphics<a class="headerlink" href="#graphics" title="Permanent link">#</a></h3>
<h3 id="_49">宏<a class="headerlink" href="#_49" title="Permanent link">#</a></h3>
<p><em>可能有用的界面定义，效率不是最高。一般用TeX定义宏。参见token库</em></p>
<p>TEX命令:
<code>\setupsomething[key=value]</code>
等价于LUA调用:
<code>context.setupsomething { key = value }</code></p>
<p>但Lua中的关键字需要先翻译成界面预设的相应的值，比如<code>yes</code>要转换成<code>interfaces.variables.yes</code>。</p>
<p>TeX的宏定义和使用：</p>
<ul>
<li>\def\test#1#2{.. #1 .. #2 .. } \test{a}{b}</li>
<li>\def\test[#1]#2{.. #1 .. #2 .. } \test[a]{b}</li>
<li>\def\test(#1&gt;&lt;#2){.. #1 .. #2 .. } \test(a&gt;&lt;b)  （定界符号可以灵活处理）</li>
</ul>
<p>In MkIV <code>\define</code> is like <code>\unexpanded\def</code> in TEX
and <code>\defineexpandable</code> is like <code>\def</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="err">\</span><span class="n">startluacode</span>
<span class="kr">function</span> <span class="nf">test</span><span class="p">(</span><span class="n">opt_1</span><span class="p">,</span> <span class="n">opt_2</span><span class="p">,</span> <span class="n">arg_1</span><span class="p">)</span>
    <span class="n">context</span><span class="p">.</span><span class="n">startnarrower</span><span class="p">()</span>
    <span class="n">context</span><span class="p">(</span><span class="s2">&quot;options 1: %s&quot;</span><span class="p">,</span><span class="n">interfaces</span><span class="p">.</span><span class="n">tolist</span><span class="p">(</span><span class="n">opt_1</span><span class="p">))</span>
    <span class="n">context</span><span class="p">.</span><span class="n">par</span><span class="p">()</span>
    <span class="n">context</span><span class="p">(</span><span class="s2">&quot;options 2: %s&quot;</span><span class="p">,</span><span class="n">interfaces</span><span class="p">.</span><span class="n">tolist</span><span class="p">(</span><span class="n">opt_2</span><span class="p">))</span>
    <span class="n">context</span><span class="p">.</span><span class="n">par</span><span class="p">()</span>
    <span class="n">context</span><span class="p">(</span><span class="s2">&quot;argument 1: %s&quot;</span><span class="p">,</span><span class="n">arg_1</span><span class="p">)</span>
    <span class="n">context</span><span class="p">.</span><span class="n">stopnarrower</span><span class="p">()</span>
<span class="kr">end</span>

<span class="n">interfaces</span><span class="p">.</span><span class="n">definecommand</span> <span class="p">{</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span> <span class="s2">&quot;option&quot;</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;option&quot;</span><span class="p">,</span> <span class="s2">&quot;hash&quot;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;string&quot;</span> <span class="p">},</span>
    <span class="p">},</span>
    <span class="n">macro</span> <span class="o">=</span> <span class="n">test</span><span class="p">,</span>
<span class="p">}</span>
<span class="err">\</span><span class="n">stopluacode</span>
</code></pre></div></td></tr></table></div>
<p>使用<code>test</code>： \test[1][a=3]{whatever}</p>
<p><strong>在lua中操控宏：</strong></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\def\TestA</span><span class="nb">{</span>A<span class="nb">}</span>
<span class="k">\def\TestB</span><span class="nb">{</span><span class="k">\def\TestC</span><span class="nb">{</span>c<span class="nb">}}</span>
<span class="k">\def\TestC</span><span class="nb">{</span>C<span class="nb">}</span>

<span class="k">\startluacode</span>
    context(tokens.getters.macro(&quot;TestA&quot;))
    context(tokens.getters.macro(&quot;TestB&quot;))
    context(tokens.getters.macro(&quot;TestC&quot;))
    tokens.setters.macro(&quot;TestA&quot;,&quot;a&quot;)
    context(tokens.getters.macro(&quot;TestA&quot;))
    context(function()
        context(tokens.getters.macro(&quot;TestA&quot;))
        context(tokens.getters.macro(&quot;TestB&quot;))
        context(tokens.getters.macro(&quot;TestC&quot;))
    end)
<span class="k">\stopluacode</span>

ACaac

<span class="k">\startluacode</span>
if tokens.getters.macro(&quot;fontstyle&quot;) == &quot;rm&quot; then
    context(&quot;serif&quot;)
else
    context(&quot;unknown&quot;)
end
<span class="k">\stopluacode</span>

serif
</code></pre></div></td></tr></table></div>
<p><strong>定义环境：</strong></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="err">\</span><span class="n">startluacode</span>
<span class="kd">local</span> <span class="kr">function</span> <span class="nf">startmore</span><span class="p">(</span><span class="n">opt_1</span><span class="p">)</span>
    <span class="n">context</span><span class="p">.</span><span class="n">startnarrower</span><span class="p">()</span>
    <span class="n">context</span><span class="p">(</span><span class="s2">&quot;start more, options: %s&quot;</span><span class="p">,</span><span class="n">interfaces</span><span class="p">.</span><span class="n">tolist</span><span class="p">(</span><span class="n">opt_1</span><span class="p">))</span>
    <span class="n">context</span><span class="p">.</span><span class="n">startnarrower</span><span class="p">()</span>
<span class="kr">end</span>
<span class="kd">local</span> <span class="kr">function</span> <span class="nf">stopmore</span><span class="p">()</span>
    <span class="n">context</span><span class="p">.</span><span class="n">stopnarrower</span><span class="p">()</span>
    <span class="n">context</span><span class="p">(</span><span class="s2">&quot;stop more&quot;</span><span class="p">)</span>
    <span class="n">context</span><span class="p">.</span><span class="n">stopnarrower</span><span class="p">()</span>
<span class="kr">end</span>

<span class="n">interfaces</span><span class="p">.</span><span class="n">definecommand</span> <span class="p">(</span> <span class="s2">&quot;more&quot;</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">environment</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span> <span class="s2">&quot;option&quot;</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span> <span class="p">},</span>
    <span class="p">},</span>
    <span class="n">starter</span> <span class="o">=</span> <span class="n">startmore</span><span class="p">,</span>
    <span class="n">stopper</span> <span class="o">=</span> <span class="n">stopmore</span><span class="p">,</span>
<span class="p">}</span> <span class="p">)</span>
<span class="err">\</span><span class="n">stopluacode</span>
</code></pre></div></td></tr></table></div>
<p>使用<code>more</code>： \startmore[1] one \startmore[2] two \stopmore one \stopmore</p>
<h3 id="verbatim">Verbatim 字符字面值<a class="headerlink" href="#verbatim" title="Permanent link">#</a></h3>
<p>获得公式：</p>
<ul>
<li><code>$e=mc^2$</code></li>
<li><code>\mathematics{e=mc^2}</code></li>
<li><code>context.mathematics("e=mc^2")</code></li>
</ul>
<p>获得字面值：</p>
<ul>
<li><code>context.verbatim("$e=mc^2$")</code></li>
<li><code>context.verbatim.bold("$e=mc^2$")</code></li>
<li><code>context.verbatim.inframed({ offset = "0pt" }, "$e=mc^2$")</code></li>
</ul>
<p><code>context.verbatim</code>比<code>type</code>宏更方便、快、准确。</p>
<p>利用缓存处理多行文本：</p>
<ul>
<li>context.tobuffer("temp",str)</li>
<li>context.getbuffer("temp")</li>
</ul>
<p>利用虚拟文件处理多行文本：</p>
<ul>
<li>context.tolines(str)</li>
<li>context.viafile(str)</li>
</ul>
<p>使用lpeg和visualizers完美打印：</p>
<ul>
<li>spaces should honoured and can be visualized</li>
<li>newlines and empty lins need to be honoured as well</li>
<li>optionally lines have to be numbered but</li>
<li>wrapped around lines should not be numbered</li>
</ul>
<h3 id="logging">Logging<a class="headerlink" href="#logging" title="Permanent link">#</a></h3>
<p>关闭日志：</p>
<ul>
<li>context --silent</li>
<li>context --silent=structure<em>,resolve</em>,font*</li>
</ul>
<p>禁用控制台：</p>
<ul>
<li>context --noconsole</li>
</ul>
<p>在CONTEXT使用指令：</p>
<ul>
<li>\enabledirectives[logs.blocked=structure<em>,resolve</em>,font*]</li>
<li>\enabledirectives[logs.target=file]</li>
</ul>
<p>Lua界面：</p>
<ul>
<li>local report_whatever = logs.reporter("modules","whatever")</li>
<li>report_whatever("not found: %s","this or that")</li>
</ul>
<p>TeX中的信息同步，还需要配置<code>logs.messenger</code></p>
<h3 id="lua_4">Lua 函数<a class="headerlink" href="#lua_4" title="Permanent link">#</a></h3>
<h4 id="table">table<a class="headerlink" href="#table" title="Permanent link">#</a></h4>
<p>LuaTeX的函数：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">-- 表项拼接为文本</span>
<span class="kd">local</span> <span class="n">str</span> <span class="o">=</span> <span class="nb">table.concat</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">str</span> <span class="o">=</span> <span class="nb">table.concat</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">separator</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">str</span> <span class="o">=</span> <span class="nb">table.concat</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">separator</span><span class="p">,</span><span class="n">first</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">str</span> <span class="o">=</span> <span class="nb">table.concat</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">separator</span><span class="p">,</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="p">)</span>
<span class="nb">table.concat</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">,</span><span class="s2">&quot;d&quot;</span><span class="p">,</span><span class="s2">&quot;e&quot;</span><span class="p">},</span><span class="s2">&quot;+&quot;</span><span class="p">)</span>
<span class="c1">-- a+b+c+d+e</span>
<span class="nb">table.concat</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">,</span><span class="s2">&quot;d&quot;</span><span class="p">,</span><span class="s2">&quot;e&quot;</span><span class="p">},</span><span class="s2">&quot;+&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="c1">-- b+c</span>

<span class="c1">-- 插入和移除</span>
<span class="nb">table.insert</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
<span class="nb">table.insert</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">position</span><span class="p">)</span>
<span class="n">value</span> <span class="o">=</span> <span class="nb">table.remove</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">position</span><span class="p">)</span>

<span class="c1">-- 解包</span>
<span class="kd">local</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">table.unpack</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="c1">-- 排序</span>
<span class="nb">table.sort</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="nb">table.sort</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">comparefunction</span><span class="p">)</span>
<span class="n">t</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">}</span>
<span class="nb">table.sort</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="kr">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="kr">return</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span> <span class="kr">end</span><span class="p">)</span>
<span class="c1">-- t={ &quot;c&quot;, &quot;b&quot;, &quot;a&quot; }</span>
</code></pre></div></td></tr></table></div>
<p>内置函数：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">-- 排序</span>
<span class="kd">local</span> <span class="n">a</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">sorted</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

<span class="c1">-- 取键值</span>
<span class="kd">local</span> <span class="n">s</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">keys</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">s</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">sortedkeys</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">s</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">sortedhashkeys</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="c1">-- 追踪/打印/查看表格内容</span>
<span class="n">inspect</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="c1">-- 迭代器（与sortedpairs同义，以便与pairs、ipairs相对） </span>
<span class="kr">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="kr">in</span> <span class="n">table</span><span class="p">.</span><span class="n">sortedhash</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="kr">do</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
<span class="kr">end</span>

<span class="n">table</span><span class="p">.</span><span class="n">serialize</span> <span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">reduce</span><span class="p">,</span> <span class="n">noquotes</span><span class="p">,</span> <span class="n">hexify</span><span class="p">)</span>
<span class="n">table</span><span class="p">.</span><span class="n">print</span> <span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">reduce</span><span class="p">,</span> <span class="n">noquotes</span><span class="p">,</span> <span class="n">hexify</span><span class="p">)</span>
<span class="n">table</span><span class="p">.</span><span class="n">tofile</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">reduce</span><span class="p">,</span> <span class="n">noquotes</span><span class="p">,</span> <span class="n">hexify</span><span class="p">)</span>
<span class="n">table</span><span class="p">.</span><span class="n">tohandle</span> <span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">reduce</span><span class="p">,</span> <span class="n">noquotes</span><span class="p">,</span> <span class="n">hexify</span><span class="p">)</span>
<span class="n">table</span><span class="p">.</span><span class="n">serialize</span><span class="p">({</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="kc">true</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;6&quot;</span> <span class="p">},</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
<span class="c1">-- t={[3]=&quot;b&quot;,[&quot;a&quot;]=2,[true]=&quot;6&quot;,}</span>

<span class="c1">-- 比较</span>
<span class="kd">local</span> <span class="n">b</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">identical</span> <span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">two</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">b</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">are_equal</span> <span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">two</span><span class="p">)</span>

<span class="c1">-- 哈希</span>
<span class="kd">local</span> <span class="n">hashed</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">tohash</span><span class="p">(</span><span class="n">indexed</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">indexed</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">fromhash</span><span class="p">(</span><span class="n">hashed</span><span class="p">)</span>
<span class="n">table</span><span class="p">.</span><span class="n">tohash</span><span class="p">({</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span> <span class="p">})</span>
<span class="c1">-- t={[&quot;a&quot;]=true,[&quot;b&quot;]=true,[&quot;c&quot;]=true,}</span>
<span class="n">table</span><span class="p">.</span><span class="n">fromhash</span><span class="p">({</span> <span class="n">a</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">})</span>
<span class="c1">-- t={ &quot;c&quot;, &quot;a&quot; }</span>

<span class="c1">-- </span>
<span class="kd">local</span> <span class="n">swapped</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">swapped</span><span class="p">(</span><span class="n">indexedtable</span><span class="p">)</span>
<span class="n">table</span><span class="p">.</span><span class="n">swapped</span><span class="p">({</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span> <span class="p">})</span>
<span class="c1">-- t={[&quot;a&quot;]=1,[&quot;b&quot;]=2,[&quot;c&quot;]=3,}</span>

<span class="c1">-- 正反</span>
<span class="kd">local</span> <span class="n">reversed</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">reversed</span> <span class="p">(</span><span class="n">indexedtable</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">reverse</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">indexedtable</span><span class="p">)</span>

<span class="c1">-- 镜像</span>
<span class="kd">local</span> <span class="n">mirrored</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">mirrored</span> <span class="p">(</span><span class="n">hashedtable</span><span class="p">)</span>
<span class="n">table</span><span class="p">.</span><span class="n">mirrored</span><span class="p">({</span> <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;z&quot;</span> <span class="p">})</span>
<span class="c1">-- t={[&quot;a&quot;]=&quot;x&quot;,[&quot;b&quot;]=&quot;y&quot;,[&quot;c&quot;]=&quot;z&quot;,[&quot;x&quot;]=&quot;a&quot;,[&quot;y&quot;]=&quot;b&quot;,[&quot;z&quot;]=&quot;c&quot;,}</span>

<span class="c1">-- 增添</span>
<span class="n">table</span><span class="p">.</span><span class="n">append</span> <span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">two</span><span class="p">)</span>
<span class="n">table</span><span class="p">.</span><span class="n">prepend</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">two</span><span class="p">)</span>

<span class="c1">-- 原位合并</span>
<span class="n">table</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">two</span><span class="p">,</span> <span class="p">...)</span>
<span class="n">table</span><span class="p">.</span><span class="n">imerge</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">two</span><span class="p">,</span> <span class="p">...)</span>
<span class="c1">-- 拷贝合并</span>
<span class="kd">local</span> <span class="n">merged</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">merged</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">two</span><span class="p">,</span> <span class="p">...)</span>
<span class="kd">local</span> <span class="n">merged</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">imerged</span> <span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">two</span><span class="p">,</span> <span class="p">...)</span>

<span class="c1">-- 拷贝</span>
<span class="kd">local</span> <span class="n">copy</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">copy</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">fastcopy</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="c1">--不检查循环引用</span>

<span class="c1">-- 展平（一层）嵌套，用merge也可以做到</span>
<span class="kd">local</span> <span class="n">flattened</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="c1">-- 键值小写</span>
<span class="kd">local</span> <span class="n">normalized</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">loweredkeys</span> <span class="p">{</span> <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="s2">&quot;c&quot;</span> <span class="p">}</span>

<span class="c1">-- 包含判断</span>
<span class="kr">if</span> <span class="n">table</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">5</span> <span class="p">)</span> <span class="kr">then</span> <span class="p">...</span> <span class="kr">else</span> <span class="p">...</span> <span class="kr">end</span>
<span class="kr">if</span> <span class="n">table</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="s2">&quot;5&quot;</span><span class="p">)</span> <span class="kr">then</span> <span class="p">...</span> <span class="kr">else</span> <span class="p">...</span> <span class="kr">end</span>

<span class="c1">-- 去重、唯一化</span>
<span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">unique</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span> <span class="p">}</span>

<span class="c1">-- 计算长度、元素个数（索引表用#t更快）</span>
<span class="kd">local</span> <span class="n">n</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="c1">-- 序列化（比如供打印）</span>
<span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="p">.</span><span class="n">sequenced</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">separator</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
<h4 id="math">math<a class="headerlink" href="#math" title="Permanent link">#</a></h4>
<p>除了内置函数，还提供：round, odd, even, div, mod, sind, cosd and
tand</p>
<h4 id="boolean">boolean<a class="headerlink" href="#boolean" title="Permanent link">#</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">-- 转0、1</span>
<span class="kd">local</span> <span class="n">state</span> <span class="o">=</span> <span class="n">boolean</span><span class="p">.</span><span class="n">tonumber</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>

<span class="c1">-- 文本转布尔（全局也可以用，或string.toboolean，如果tolerant=true，字符串true, yes, on, 1, t和数字1都转为布尔true）</span>
<span class="kd">local</span> <span class="n">b</span> <span class="o">=</span> <span class="n">toboolean</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">b</span> <span class="o">=</span> <span class="n">toboolean</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="n">tolerant</span><span class="p">)</span>

<span class="c1">-- 判断是布尔，或string.is_boolean</span>
<span class="kr">if</span> <span class="n">is_boolean</span><span class="p">(</span><span class="n">str</span><span class="p">)</span><span class="kr">then</span> <span class="p">...</span> <span class="kr">end</span>
<span class="kr">if</span> <span class="n">is_boolean</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="n">default</span><span class="p">)</span> <span class="kr">then</span> <span class="p">...</span> <span class="kr">end</span>
</code></pre></div></td></tr></table></div>
<h4 id="string">string<a class="headerlink" href="#string" title="Permanent link">#</a></h4>
<p>Lua:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nb">string.byte</span><span class="p">(</span><span class="s2">&quot;luatex&quot;</span><span class="p">)</span> <span class="c1">--108</span>
<span class="nb">string.char</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span><span class="mi">66</span><span class="p">,</span><span class="mi">67</span><span class="p">)</span> <span class="c1">--ABC  utf8.char(n.char)</span>

<span class="c1">-- 切片</span>
<span class="kd">local</span> <span class="n">slice</span> <span class="o">=</span> <span class="nb">string.sub</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="p">)</span>

<span class="c1">-- 替换</span>
<span class="kd">local</span> <span class="n">new</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="nb">string.gsub</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="n">pattern</span><span class="p">,</span><span class="n">replacement</span><span class="p">,</span><span class="n">howoften</span><span class="p">)</span>
<span class="nb">string.gsub</span><span class="p">(</span><span class="s2">&quot;abcdef&quot;</span><span class="p">,</span><span class="s2">&quot;[bc]&quot;</span><span class="p">,</span><span class="nb">string.upper</span><span class="p">)</span> <span class="c1">--aBCdef</span>

<span class="c1">-- 查找</span>
<span class="kd">local</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="n">pattern</span><span class="p">)</span>
<span class="kr">if</span> <span class="n">find</span><span class="p">(</span><span class="s2">&quot;luatex&quot;</span><span class="p">,</span><span class="s2">&quot;tex&quot;</span><span class="p">)</span> <span class="kr">then</span> <span class="p">...</span> <span class="kr">end</span>

<span class="c1">-- 逐一匹配</span>
<span class="kd">local</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="p">...</span> <span class="o">=</span> <span class="nb">string.match</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="n">pattern</span><span class="p">)</span>
<span class="kr">for</span> <span class="n">s</span> <span class="kr">in</span> <span class="nb">string.gmatch</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="s2">&quot;([^,%s])+&quot;</span><span class="p">)</span> <span class="kr">do</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- 大写、小写</span>
<span class="nb">string.lower</span><span class="p">(</span><span class="s2">&quot;LOW&quot;</span><span class="p">)</span>
<span class="nb">string.upper</span><span class="p">(</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>

<span class="c1">-- 模板格式化</span>
<span class="kd">local</span> <span class="n">s</span> <span class="o">=</span> <span class="n">format</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="p">...)</span>
</code></pre></div></td></tr></table></div>
<p>CONTEXT：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">-- 行修剪</span>
<span class="n">utilities</span><span class="p">.</span><span class="n">strings</span><span class="p">.</span><span class="n">striplines</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="s2">&quot;collapse&quot;</span><span class="p">)</span>
<span class="n">utilities</span><span class="p">.</span><span class="n">strings</span><span class="p">.</span><span class="n">striplines</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="s2">&quot;prune and collapse&quot;</span><span class="p">)</span>
<span class="n">utilities</span><span class="p">.</span><span class="n">strings</span><span class="p">.</span><span class="n">striplines</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="s2">&quot;prune and no empty&quot;</span><span class="p">)</span>
<span class="n">utilities</span><span class="p">.</span><span class="n">strings</span><span class="p">.</span><span class="n">striplines</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="s2">&quot;prune and to space&quot;</span><span class="p">)</span>
<span class="n">utilities</span><span class="p">.</span><span class="n">strings</span><span class="p">.</span><span class="n">striplines</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="s2">&quot;retain&quot;</span><span class="p">)</span>

<span class="c1">-- 强大的格式化formatter（略）</span>

<span class="c1">-- 修剪头尾</span>
<span class="kd">local</span> <span class="n">s</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">strip</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>

<span class="c1">-- 分切</span>
<span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">lpeg</span><span class="p">)</span> <span class="c1">--多个分切符号`lpeg.S(&quot;,.&quot;)`</span>
<span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">checkedsplit</span> <span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">lpeg</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">splitlines</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>

<span class="c1">-- 引号</span>
<span class="kd">local</span> <span class="n">q</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">quoted</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">u</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">unquoted</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>

<span class="c1">-- 计数</span>
<span class="kd">local</span> <span class="n">n</span> <span class="o">=</span> <span class="n">count</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="n">pattern</span><span class="p">)</span>
<span class="n">string</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;test me&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">)</span> <span class="c1">-- 2</span>

<span class="c1">-- 限制长度</span>
<span class="nb">print</span><span class="p">(</span><span class="n">limit</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="n">max</span><span class="p">,</span><span class="n">sentinel</span><span class="p">)</span>
<span class="n">string</span><span class="p">.</span><span class="n">limit</span><span class="p">(</span><span class="s2">&quot;too long&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="c1">--too...</span>

<span class="c1">-- 判断为空</span>
<span class="kr">if</span> <span class="n">is_empty</span><span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="kr">then</span> <span class="p">...</span> <span class="kr">end</span>

<span class="c1">-- 转义</span>
<span class="kd">local</span> <span class="n">e</span> <span class="o">=</span> <span class="n">escapedpattern</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">simple</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">p</span> <span class="o">=</span> <span class="n">topattern</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">lowercase</span><span class="p">,</span> <span class="n">strict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="utf">UTF<a class="headerlink" href="#utf" title="Permanent link">#</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">local</span> <span class="n">b</span> <span class="o">=</span> <span class="n">utf</span><span class="p">.</span><span class="n">byte</span><span class="p">(</span><span class="s2">&quot;å&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">c</span> <span class="o">=</span> <span class="n">utf</span><span class="p">.</span><span class="n">char</span><span class="p">(</span><span class="mh">0xE5</span><span class="p">)</span>

<span class="c1">-- 切片</span>
<span class="n">utf</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;123456àáâãäå&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>

<span class="c1">-- 长度</span>
<span class="kd">local</span> <span class="n">l</span> <span class="o">=</span> <span class="n">utf</span><span class="p">.</span><span class="n">len</span><span class="p">(</span><span class="s2">&quot;ÀÁÂÃÄÅàáâãäå&quot;</span><span class="p">)</span>

<span class="c1">-- 迭代</span>
<span class="kr">for</span> <span class="n">u</span> <span class="kr">in</span> <span class="n">utf</span><span class="p">.</span><span class="n">values</span><span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="kr">do</span>
    <span class="p">...</span> <span class="c1">-- u is a number</span>
<span class="kr">end</span>
<span class="kr">for</span> <span class="n">c</span> <span class="kr">in</span> <span class="n">utf</span><span class="p">.</span><span class="n">characters</span><span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="kr">do</span>
    <span class="p">...</span> <span class="c1">-- c is a string</span>
<span class="kr">end</span>

<span class="c1">-- 转码</span>
<span class="n">utf</span><span class="p">.</span><span class="n">ustring</span><span class="p">(</span><span class="s2">&quot;ù&quot;</span><span class="p">)</span>
<span class="c1">-- U+000F9</span>
<span class="n">utf</span><span class="p">.</span><span class="n">xstring</span><span class="p">(</span><span class="mh">0xE6</span><span class="p">)</span>
<span class="c1">-- 0x000E6</span>
<span class="n">utf</span><span class="p">.</span><span class="n">xstring</span><span class="p">(</span><span class="s2">&quot;à&quot;</span><span class="p">)</span>
<span class="c1">-- 0x000E0</span>
<span class="n">utf</span><span class="p">.</span><span class="n">tocodes</span><span class="p">(</span><span class="s2">&quot;òóö&quot;</span><span class="p">,</span><span class="s2">&quot;+&quot;</span><span class="p">)</span>
<span class="c1">-- 0x00F2+0x00F3+0x00F6</span>

<span class="c1">-- 切分成表</span>
<span class="n">utf</span><span class="p">.</span><span class="n">split</span> <span class="n">utf</span><span class="p">.</span><span class="n">splitlines</span> <span class="n">utf</span><span class="p">.</span><span class="n">totable</span>

<span class="c1">-- 计数</span>
<span class="n">utf</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;äáàa&quot;</span><span class="p">,</span><span class="n">lpeg</span><span class="p">.</span><span class="n">P</span><span class="p">(</span><span class="s2">&quot;á&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">lpeg</span><span class="p">.</span><span class="n">P</span><span class="p">(</span><span class="s2">&quot;à&quot;</span><span class="p">))</span> <span class="c1">--2</span>

<span class="c1">-- 映射器、替换器remapper replacer substituter</span>
<span class="kd">local</span> <span class="n">remap</span> <span class="o">=</span> <span class="n">utf</span><span class="p">.</span><span class="n">remapper</span> <span class="p">{</span> <span class="n">a</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="n">remap</span><span class="p">(</span><span class="s2">&quot;abcd 1234 abcd&quot;</span><span class="p">))</span>

<span class="c1">-- 判断值有效(主要是外部输入)</span>
<span class="kr">if</span> <span class="n">utf</span><span class="p">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="kr">do</span> <span class="p">...</span> <span class="kr">end</span>
</code></pre></div></td></tr></table></div>
<h4 id="number">number<a class="headerlink" href="#number" title="Permanent link">#</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">-- 转比特</span>
<span class="n">number</span><span class="p">.</span><span class="n">tobitstring</span><span class="p">(</span><span class="mi">2013</span><span class="p">)</span>

<span class="c1">-- 检查数字有效</span>
<span class="n">number</span><span class="p">.</span><span class="n">valid</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="n">number</span><span class="p">.</span><span class="n">valid</span><span class="p">(</span><span class="s2">&quot;ab&quot;</span><span class="p">,</span><span class="mi">56</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="lpeg_patterns">LPEG patterns 格式<a class="headerlink" href="#lpeg_patterns" title="Permanent link">#</a></h4>
<p>类似于正则表达式，细节见<code>l-lpeg.lua</code></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">local</span> <span class="n">splitter</span> <span class="o">=</span> <span class="n">lpeg</span><span class="p">.</span><span class="n">splitat</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">lpeg</span><span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="n">splitter</span><span class="p">,</span><span class="s2">&quot;2*4&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">lpeg</span><span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="n">splitter</span><span class="p">,</span><span class="s2">&quot;2*4&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="io_1">IO<a class="headerlink" href="#io_1" title="Permanent link">#</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">local</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">io.open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">f</span><span class="p">:</span><span class="n">read</span><span class="p">(...)</span>
<span class="n">f</span><span class="p">:</span><span class="n">write</span><span class="p">(...)</span>
<span class="n">f</span><span class="p">:</span><span class="n">lines</span><span class="p">()</span>
<span class="n">f</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>

<span class="n">io</span><span class="p">.</span><span class="n">loaddata</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">textmode</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">savedata</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">str</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">savedata</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">tab</span><span class="p">,</span><span class="n">joiner</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="filedirurlos">File、Dir、URL、OS<a class="headerlink" href="#filedirurlos" title="Permanent link">#</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nb">os.time</span><span class="p">()</span>
<span class="n">os</span><span class="p">.</span><span class="n">gettimeofday</span><span class="p">()</span>
<span class="n">os</span><span class="p">.</span><span class="n">runtime</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<h3 id="lua_interface_code">LUA 界面代码 interface code<a class="headerlink" href="#lua_interface_code" title="Permanent link">#</a></h3>
<h4 id="_50">字体<a class="headerlink" href="#_50" title="Permanent link">#</a></h4>
<h4 id="nodes">Nodes<a class="headerlink" href="#nodes" title="Permanent link">#</a></h4>
<p>引擎提供的所有node助手都映射在nodes命名空间下。node详情参见 <em>LUATEX manual</em></p>
<p>由于历史原因，nodes下的一些助手与node下的近似。</p>
<p><strong>结点和结点列表追踪：</strong></p>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">\setbox</span>0<span class="k">\hbox</span><span class="nb">{</span>我在这里。It&#39;s in <span class="k">\hbox</span><span class="nb">{</span><span class="k">\bf</span> all<span class="nb">}</span> those nodes.<span class="nb">}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="err">\</span><span class="n">startluacode</span>
<span class="c1">--基本信息：类型（node）、编号、前后结点编号、类型id、？？</span>
<span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="c1">--&lt;node :   1605 &lt;=   1612 =&gt;   1667 : glyph unset&gt;</span>

<span class="c1">--结点转utf（仅限能转的如字模结点）</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">toutf</span><span class="p">(</span><span class="n">tex</span><span class="p">.</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">toutf</span><span class="p">(</span><span class="n">tex</span><span class="p">.</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">list</span><span class="p">))</span>
<span class="c1">--我你他！</span>

<span class="c1">--结点列表转utf（非字模用`[-]`表示）</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">listtoutf</span><span class="p">(</span><span class="n">tex</span><span class="p">.</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> 
<span class="nb">print</span><span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">listtoutf</span><span class="p">(</span><span class="n">tex</span><span class="p">.</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">list</span><span class="p">))</span>
<span class="c1">--[-][-]我[-]你[-]他[-][-]！[-]</span>

<span class="c1">--结点序列化（结点类型、字模的utf代码和字符）</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">tosequence</span><span class="p">(</span><span class="n">tex</span><span class="p">.</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">tosequence</span><span class="p">(</span><span class="n">tex</span><span class="p">.</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">list</span><span class="p">))</span>

<span class="c1">--结点id转文本（同id合并）</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">idstostring</span><span class="p">(</span><span class="n">tex</span><span class="p">.</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">idstostring</span><span class="p">(</span><span class="n">tex</span><span class="p">.</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">list</span><span class="p">))</span>

<span class="c1">--结点计数</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">countall</span><span class="p">(</span><span class="n">tex</span><span class="p">.</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">countall</span><span class="p">(</span><span class="n">tex</span><span class="p">.</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">list</span><span class="p">))</span>

<span class="c1">--查看结点类型、小类和id</span>
<span class="nb">print</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">type</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">id</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">subtypes</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">id</span><span class="p">)[</span><span class="n">n</span><span class="p">.</span><span class="n">subtype</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">(</span><span class="s2">&quot;vlist&quot;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div></p>
<p>查看字模结点n的字符：</p>
<p>local c = utf8.char(n.char)</p>
<p>跟踪结点明细：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">local</span> <span class="kr">function</span> <span class="nf">show_detail</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> 
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span><span class="o">..</span><span class="n">label</span><span class="o">..</span><span class="s2">&quot;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">toutf</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    <span class="kr">for</span> <span class="n">i</span> <span class="kr">in</span> <span class="n">node</span><span class="p">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="kr">do</span>
        <span class="kd">local</span> <span class="n">char</span>
        <span class="kr">if</span> <span class="n">i</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">glyph_id</span> <span class="kr">then</span>
            <span class="n">char</span> <span class="o">=</span> <span class="nb">utf8.char</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">char</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">char</span><span class="p">)</span>
        <span class="kr">elseif</span> <span class="n">i</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">penalty_id</span> <span class="kr">then</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">penalty</span><span class="p">)</span>
        <span class="kr">elseif</span> <span class="n">i</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">glue_id</span> <span class="kr">then</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">stretch</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">shrink</span><span class="p">)</span>
        <span class="kr">elseif</span> <span class="n">i</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">hlist_id</span> <span class="kr">then</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">nodes</span><span class="p">.</span><span class="n">toutf</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">list</span><span class="p">))</span>
        <span class="kr">else</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="kr">end</span>
    <span class="kr">end</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>
<p><strong>结点类型的id与字符串映射表，大类：</strong></p>
<ul>
<li>nodes.nodecodes  regular nodes, some fo them are sort of private to the engine. underscores：<ul>
<li>nodes.nodecodes.glyph</li>
<li>nodes.nodecodes.kern</li>
<li>nodes.nodecodes.glue</li>
</ul>
</li>
<li>nodes.noadcodes  math nodes that later on are converted into regular nodes</li>
</ul>
<p><strong>小类：</strong></p>
<ul>
<li>nodes.listcodes  subtypes of hlist and vlist nodes</li>
<li>nodes.kerncodes  subtypes of kern nodes</li>
<li>nodes.gluecodes  subtypes of glue nodes (skips)</li>
<li>nodes.glyphcodes  subtypes of glyph nodes, the subtype can change</li>
<li>nodes.mathcodes  math specific subtypes</li>
<li>nodes.fillcodes  these are not really subtypes but indicate the strength of the filler</li>
<li>nodes.whatsitcodes  subtypes of a rather large group of extension nodes</li>
</ul>
<p>遍历并判断结点类型：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">-- 本地变量要比原变量快得多</span>
<span class="kd">local</span> <span class="n">glyph_code</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">.</span><span class="n">nodecodes</span><span class="p">.</span><span class="n">glyph</span>
<span class="kd">local</span> <span class="n">kern_code</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">.</span><span class="n">nodecodes</span><span class="p">.</span><span class="n">kern</span>
<span class="kd">local</span> <span class="n">glue_code</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">.</span><span class="n">nodecodes</span><span class="p">.</span><span class="n">glue</span>
<span class="c1">--for n in node.traverse_id(glyph_code,list) do</span>
<span class="kr">for</span> <span class="n">n</span> <span class="kr">in</span> <span class="n">nodes</span><span class="p">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="kr">do</span>
    <span class="kd">local</span> <span class="n">id</span> <span class="o">==</span> <span class="n">n</span><span class="p">.</span><span class="n">id</span>
    <span class="kr">if</span> <span class="n">id</span> <span class="o">==</span> <span class="n">glyph_code</span> <span class="kr">then</span>
        <span class="p">...</span>
    <span class="kr">elseif</span> <span class="n">id</span> <span class="o">==</span> <span class="n">kern_code</span> <span class="kr">then</span>
        <span class="p">...</span>
    <span class="kr">elseif</span> <span class="n">id</span> <span class="o">==</span> <span class="n">glue_code</span> <span class="kr">then</span>
        <span class="p">...</span>
    <span class="kr">else</span>
        <span class="p">...</span>
    <span class="kr">end</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>
<p><strong>新建结点、结点池操控函数：</strong></p>
<ul>
<li>node.new</li>
<li>local g = nodes.pool.glyph(fnt,chr) --根据字体id取字符</li>
</ul>
<h4 id="resolversmathgrphmetapostluatextracing">Resolvers、math、grph、MetaPost、LuaTEX、Tracing<a class="headerlink" href="#resolversmathgrphmetapostluatextracing" title="Permanent link">#</a></h4>
<h3 id="scanners">Scanners<a class="headerlink" href="#scanners" title="Permanent link">#</a></h3>
<p>定义直接与Lua交互的宏。</p>
<p>实现一个界面：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="err">\</span><span class="n">startluacode</span>
<span class="n">interfaces</span><span class="p">.</span><span class="n">implement</span> <span class="p">{</span>
    <span class="n">name</span>    <span class="o">=</span> <span class="s2">&quot;MyMacroA&quot;</span><span class="p">,</span>
    <span class="n">public</span>    <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
    <span class="n">permanent</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
    <span class="n">actions</span>    <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">context</span><span class="p">(</span><span class="s2">&quot;(%s)&quot;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
    <span class="kr">end</span><span class="p">,</span>
<span class="p">}</span>
<span class="err">\</span><span class="n">stopluacode</span>
<span class="c1">-- \def\MyMacro #1 {... \clf_MyMacroA{ #1 } ...}</span>

<span class="err">\</span><span class="n">startluacode</span>
<span class="n">interfaces</span><span class="p">.</span><span class="n">implement</span> <span class="p">{</span>
    <span class="n">name</span>    <span class="o">=</span> <span class="s2">&quot;MyMacroJ&quot;</span><span class="p">,</span>
    <span class="n">public</span>    <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="s2">&quot;box&quot;</span><span class="p">,</span>
    <span class="n">actions</span>    <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">context</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="kr">end</span><span class="p">,</span>
<span class="p">}</span>
<span class="err">\</span><span class="n">stopluacode</span>
<span class="c1">-- \MyMacroJ \hbox{\strut Test 1}</span>
<span class="c1">-- \MyMacroJ \hbox to 4cm {\strut Test 2}</span>

<span class="err">\</span><span class="n">startluacode</span>
    <span class="n">interfaces</span><span class="p">.</span><span class="n">implement</span> <span class="p">{</span>
    <span class="n">name</span>    <span class="o">=</span> <span class="s2">&quot;MyMacroL&quot;</span><span class="p">,</span>
    <span class="n">public</span>    <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;hbox&quot;</span><span class="p">,</span>
        <span class="s2">&quot;vbox&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">actions</span>    <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">context</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">context</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="kr">end</span><span class="p">,</span>
<span class="p">}</span>
<span class="err">\</span><span class="n">stopluacode</span>
<span class="c1">-- \MyMacroL{\strut Test 1h} to 10mm {\vfill Test 1v\vfill}</span>
<span class="c1">-- \MyMacroL spread 1cm {\strut Test 2h} to 15mm {\vfill Test 2v\vfill}</span>
</code></pre></div></td></tr></table></div>
<h3 id="print">控制台print中文乱码的问题<a class="headerlink" href="#print" title="Permanent link">#</a></h3>
<p>临时改变code page为utf8<code>chcp 65001</code></p>
<h3 id="_51">样例<a class="headerlink" href="#_51" title="Permanent link">#</a></h3>
<h4 id="hyphenation">hyphenation<a class="headerlink" href="#hyphenation" title="Permanent link">#</a></h4>
<p>导出luatex的断词信息。</p>
<p>This will write to hyphens-\jobname.txt a dump of all the characters that luatex has been asked to add hyphenation points to from this point on in the source, with the output of each callback call on a single line.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nb">{</span><span class="k">\catcode</span>`<span class="k">\#</span>=12
<span class="k">\directlua</span> <span class="nb">{</span>
local words = io.open(&#39;hyphens-&#39; .. tex.jobname .. &#39;.txt&#39;, &#39;w&#39;);
local outchar = unicode.utf8.char
local function dumphyphens (head)
   local data = <span class="nb">{}</span>
   for v in node.traverse(head) do
       if v.id == node.id(&#39;glyph&#39;) then
         data[#data+1] = outchar(v.char);
       elseif v.id == node.id(&#39;disc&#39;) then
          data[#data+1] = &#39;-&#39;
       elseif v.id == node.id(&#39;glue&#39;) then
         data[#data+1] = outchar(32)
       elseif v.id == node.id(&#39;hlist&#39;) then
         data[#data+1] = dumphyphens(v.list)
       end
   end
   return table.concat(data)
end
callback.register (&#39;hyphenate&#39;, function (head,tail)
   lang.hyphenate(head, tail) 
   words:write (dumphyphens(head) .. outchar(10))
   end)
<span class="nb">}}</span>

<span class="k">\input</span> knuth
<span class="k">\bye</span>
</code></pre></div></td></tr></table></div>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        这篇怎么样啊？
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="这篇有用" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="需要改进" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              多谢反馈!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              多谢反馈!
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                

  <!-- Giscus -->
  <h2 id="__comments">评论</h2>
  <!-- Replace with generated snippet -->
  <script src="https://giscus.app/client.js"
  data-repo="Fusyong/Fusyong.github.io"
  data-repo-id="MDEwOlJlcG9zaXRvcnkxNTMwNDc3ODc="
  data-category="Announcements"
  data-category-id="DIC_kwDOCR9S684CPp2T"
  data-mapping="pathname"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="bottom"
  data-theme="light"
  data-lang="zh-CN"
  crossorigin="anonymous"
  async>
</script>

  <!-- Reload on palette change -->
  <script>
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object")
      if (palette.color.scheme === "slate") {
        var giscus = document.querySelector("script[src*=giscus]")
        giscus.setAttribute("data-theme", "dark") 
      }

    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "dark" : "light"

          /* Instruct Giscus to change theme */
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>

              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../2022-02-23-luametatex-callback-playground/" class="md-footer__link md-footer__link--prev" aria-label="上一页: LuaTeX回调游乐场" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  上一页
                </span>
                LuaTeX回调游乐场
              </div>
            </div>
          </a>
        
        
          
          <a href="../2022-01-10-ConTeXt%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-footer__link md-footer__link--next" aria-label="下一页: ConTeXt学习笔记" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  下一页
                </span>
                ConTeXt学习笔记
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2018 - 2023 黄复雄
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/Fusyong" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://www.facebook.com/Aahuaang/" target="_blank" rel="noopener" title="www.facebook.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/fusyong" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "navigation.instant", "navigation.footer", "navigation.tracking", "toc.follow", "search.highlight", "search.share"], "search": "../assets/javascripts/workers/search.db81ec45.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../assets/javascripts/bundle.a00a7c5e.min.js"></script>
      
    
  </body>
</html>